<!doctype html>
<html data-n-head-ssr lang="en" data-n-head="%7B%22lang%22:%7B%22ssr%22:%22en%22%7D%7D">
  <head >
    <title>rego.fyi: A Study in Serverless Authorization with Open Policy Agent</title><meta data-n-head="ssr" charset="utf-8"><meta data-n-head="ssr" name="viewport" content="width=device-width, initial-scale=1"><meta data-n-head="ssr" data-hid="description" name="description" content=""><meta data-n-head="ssr" name="format-detection" content="telephone=no"><meta data-n-head="ssr" data-hid="charset" charset="utf-8"><meta data-n-head="ssr" data-hid="mobile-web-app-capable" name="mobile-web-app-capable" content="yes"><meta data-n-head="ssr" data-hid="og:type" name="og:type" property="og:type" content="website"><link data-n-head="ssr" rel="icon" type="image/x-icon" href="/favicon.ico"><link data-n-head="ssr" rel="preconnect" href="https://fonts.gstatic.com"><link data-n-head="ssr" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&amp;display=swap"><link data-n-head="ssr" data-hid="shortcut-icon" rel="shortcut icon" href="/_nuxt/icons/icon_64x64.e3e9fb.png"><link data-n-head="ssr" data-hid="apple-touch-icon" rel="apple-touch-icon" href="/_nuxt/icons/icon_512x512.e3e9fb.png" sizes="512x512"><link data-n-head="ssr" rel="manifest" href="/_nuxt/manifest.f9c56d04.json" data-hid="manifest"><link rel="preload" href="/_nuxt/548109a.js" as="script"><link rel="preload" href="/_nuxt/84567ea.js" as="script"><link rel="preload" href="/_nuxt/ad2e88f.js" as="script"><link rel="preload" href="/_nuxt/a9b0fbe.js" as="script"><link rel="preload" href="/_nuxt/c3ddcce.js" as="script"><style data-vue-ssr-id="54b08540:0 a57b151a:0 1239d49d:0 bc0f4dfc:0 59be0982:0 4d321698:0 3c003464:0 6cfba90a:0">/*! tailwindcss v2.2.16 | MIT License | https://tailwindcss.com*/

/*! modern-normalize v1.1.0 | MIT License | https://github.com/sindresorhus/modern-normalize */

/*
Document
========
*/

/**
Use a better box model (opinionated).
*/

*,
::before,
::after {
  box-sizing: border-box;
}

/**
Use a more readable tab size (opinionated).
*/

html {
  -moz-tab-size: 4;
  -o-tab-size: 4;
     tab-size: 4;
}

/**
1. Correct the line height in all browsers.
2. Prevent adjustments of font size after orientation changes in iOS.
*/

html {
  line-height: 1.15; /* 1 */
  -webkit-text-size-adjust: 100%; /* 2 */
}

/*
Sections
========
*/

/**
Remove the margin in all browsers.
*/

body {
  margin: 0;
}

/**
Improve consistency of default fonts in all browsers. (https://github.com/sindresorhus/modern-normalize/issues/3)
*/

body {
  font-family:
		system-ui,
		-apple-system, /* Firefox supports this but not yet `system-ui` */
		'Segoe UI',
		Roboto,
		Helvetica,
		Arial,
		sans-serif,
		'Apple Color Emoji',
		'Segoe UI Emoji';
}

/*
Grouping content
================
*/

/**
1. Add the correct height in Firefox.
2. Correct the inheritance of border color in Firefox. (https://bugzilla.mozilla.org/show_bug.cgi?id=190655)
*/

hr {
  height: 0; /* 1 */
  color: inherit; /* 2 */
}

/*
Text-level semantics
====================
*/

/**
Add the correct text decoration in Chrome, Edge, and Safari.
*/

abbr[title] {
  -webkit-text-decoration: underline dotted;
          text-decoration: underline dotted;
}

/**
Add the correct font weight in Edge and Safari.
*/

b,
strong {
  font-weight: bolder;
}

/**
1. Improve consistency of default fonts in all browsers. (https://github.com/sindresorhus/modern-normalize/issues/3)
2. Correct the odd 'em' font sizing in all browsers.
*/

code,
kbd,
samp,
pre {
  font-family:
		ui-monospace,
		SFMono-Regular,
		Consolas,
		'Liberation Mono',
		Menlo,
		monospace; /* 1 */
  font-size: 1em; /* 2 */
}

/**
Add the correct font size in all browsers.
*/

small {
  font-size: 80%;
}

/**
Prevent 'sub' and 'sup' elements from affecting the line height in all browsers.
*/

sub,
sup {
  font-size: 75%;
  line-height: 0;
  position: relative;
  vertical-align: baseline;
}

sub {
  bottom: -0.25em;
}

sup {
  top: -0.5em;
}

/*
Tabular data
============
*/

/**
1. Remove text indentation from table contents in Chrome and Safari. (https://bugs.chromium.org/p/chromium/issues/detail?id=999088, https://bugs.webkit.org/show_bug.cgi?id=201297)
2. Correct table border color inheritance in all Chrome and Safari. (https://bugs.chromium.org/p/chromium/issues/detail?id=935729, https://bugs.webkit.org/show_bug.cgi?id=195016)
*/

table {
  text-indent: 0; /* 1 */
  border-color: inherit; /* 2 */
}

/*
Forms
=====
*/

/**
1. Change the font styles in all browsers.
2. Remove the margin in Firefox and Safari.
*/

button,
input,
optgroup,
select,
textarea {
  font-family: inherit; /* 1 */
  font-size: 100%; /* 1 */
  line-height: 1.15; /* 1 */
  margin: 0; /* 2 */
}

/**
Remove the inheritance of text transform in Edge and Firefox.
1. Remove the inheritance of text transform in Firefox.
*/

button,
select { /* 1 */
  text-transform: none;
}

/**
Correct the inability to style clickable types in iOS and Safari.
*/

button,
[type='button'],
[type='submit'] {
  -webkit-appearance: button;
}

/**
Remove the inner border and padding in Firefox.
*/

/**
Restore the focus styles unset by the previous rule.
*/

/**
Remove the additional ':invalid' styles in Firefox.
See: https://github.com/mozilla/gecko-dev/blob/2f9eacd9d3d995c937b4251a5557d95d494c9be1/layout/style/res/forms.css#L728-L737
*/

/**
Remove the padding so developers are not caught out when they zero out 'fieldset' elements in all browsers.
*/

legend {
  padding: 0;
}

/**
Add the correct vertical alignment in Chrome and Firefox.
*/

progress {
  vertical-align: baseline;
}

/**
Correct the cursor style of increment and decrement buttons in Safari.
*/

/**
1. Correct the odd appearance in Chrome and Safari.
2. Correct the outline style in Safari.
*/

[type='search'] {
  -webkit-appearance: textfield; /* 1 */
  outline-offset: -2px; /* 2 */
}

/**
Remove the inner padding in Chrome and Safari on macOS.
*/

/**
1. Correct the inability to style clickable types in iOS and Safari.
2. Change font properties to 'inherit' in Safari.
*/

/*
Interactive
===========
*/

/*
Add the correct display in Chrome and Safari.
*/

summary {
  display: list-item;
}

/**
 * Manually forked from SUIT CSS Base: https://github.com/suitcss/base
 * A thin layer on top of normalize.css that provides a starting point more
 * suitable for web applications.
 */

/**
 * Removes the default spacing and border for appropriate elements.
 */

blockquote,
dl,
dd,
h1,
h2,
h3,
h4,
h5,
h6,
hr,
figure,
p,
pre {
  margin: 0;
}

button {
  background-color: transparent;
  background-image: none;
}

fieldset {
  margin: 0;
  padding: 0;
}

ol,
ul {
  list-style: none;
  margin: 0;
  padding: 0;
}

/**
 * Tailwind custom reset styles
 */

/**
 * 1. Use the user's configured `sans` font-family (with Tailwind's default
 *    sans-serif font stack as a fallback) as a sane default.
 * 2. Use Tailwind's default "normal" line-height so the user isn't forced
 *    to override it to ensure consistency even when using the default theme.
 */

html {
  font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji"; /* 1 */
  line-height: 1.5; /* 2 */
}

/**
 * Inherit font-family and line-height from `html` so users can set them as
 * a class directly on the `html` element.
 */

body {
  font-family: inherit;
  line-height: inherit;
}

/**
 * 1. Prevent padding and border from affecting element width.
 *
 *    We used to set this in the html element and inherit from
 *    the parent element for everything else. This caused issues
 *    in shadow-dom-enhanced elements like <details> where the content
 *    is wrapped by a div with box-sizing set to `content-box`.
 *
 *    https://github.com/mozdevs/cssremedy/issues/4
 *
 *
 * 2. Allow adding a border to an element by just adding a border-width.
 *
 *    By default, the way the browser specifies that an element should have no
 *    border is by setting it's border-style to `none` in the user-agent
 *    stylesheet.
 *
 *    In order to easily add borders to elements by just setting the `border-width`
 *    property, we change the default border-style for all elements to `solid`, and
 *    use border-width to hide them instead. This way our `border` utilities only
 *    need to set the `border-width` property instead of the entire `border`
 *    shorthand, making our border utilities much more straightforward to compose.
 *
 *    https://github.com/tailwindcss/tailwindcss/pull/116
 */

*,
::before,
::after {
  box-sizing: border-box; /* 1 */
  border-width: 0; /* 2 */
  border-style: solid; /* 2 */
  border-color: currentColor; /* 2 */
}

/*
 * Ensure horizontal rules are visible by default
 */

hr {
  border-top-width: 1px;
}

/**
 * Undo the `border-style: none` reset that Normalize applies to images so that
 * our `border-{width}` utilities have the expected effect.
 *
 * The Normalize reset is unnecessary for us since we default the border-width
 * to 0 on all elements.
 *
 * https://github.com/tailwindcss/tailwindcss/issues/362
 */

img {
  border-style: solid;
}

textarea {
  resize: vertical;
}

input::-moz-placeholder, textarea::-moz-placeholder {
  opacity: 1;
  color: #9ca3af;
}

input:-ms-input-placeholder, textarea:-ms-input-placeholder {
  opacity: 1;
  color: #9ca3af;
}

input::placeholder,
textarea::placeholder {
  opacity: 1;
  color: #9ca3af;
}

button {
  cursor: pointer;
}

/**
 * Override legacy focus reset from Normalize with modern Firefox focus styles.
 *
 * This is actually an improvement over the new defaults in Firefox in our testing,
 * as it triggers the better focus styles even for links, which still use a dotted
 * outline in Firefox by default.
 */

table {
  border-collapse: collapse;
}

h1,
h2,
h3,
h4,
h5,
h6 {
  font-size: inherit;
  font-weight: inherit;
}

/**
 * Reset links to optimize for opt-in styling instead of
 * opt-out.
 */

a {
  color: inherit;
  text-decoration: inherit;
}

/**
 * Reset form element properties that are easy to forget to
 * style explicitly so you don't inadvertently introduce
 * styles that deviate from your design system. These styles
 * supplement a partial reset that is already applied by
 * normalize.css.
 */

button,
input,
optgroup,
select,
textarea {
  padding: 0;
  line-height: inherit;
  color: inherit;
}

/**
 * Use the configured 'mono' font family for elements that
 * are expected to be rendered with a monospace font, falling
 * back to the system monospace stack if there is no configured
 * 'mono' font family.
 */

pre,
code,
kbd,
samp {
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
}

/**
 * 1. Make replaced elements `display: block` by default as that's
 *    the behavior you want almost all of the time. Inspired by
 *    CSS Remedy, with `svg` added as well.
 *
 *    https://github.com/mozdevs/cssremedy/issues/14
 * 
 * 2. Add `vertical-align: middle` to align replaced elements more
 *    sensibly by default when overriding `display` by adding a
 *    utility like `inline`.
 *
 *    This can trigger a poorly considered linting error in some
 *    tools but is included by design.
 * 
 *    https://github.com/jensimmons/cssremedy/issues/14#issuecomment-634934210
 */

img,
svg,
video,
canvas,
audio,
iframe,
embed,
object {
  display: block; /* 1 */
  vertical-align: middle; /* 2 */
}

/**
 * Constrain images and videos to the parent width and preserve
 * their intrinsic aspect ratio.
 *
 * https://github.com/mozdevs/cssremedy/issues/14
 */

img,
video {
  max-width: 100%;
  height: auto;
}

/**
 * Ensure the default browser behavior of the `hidden` attribute.
 */

[hidden] {
  display: none;
}

*, ::before, ::after{
  --tw-border-opacity:1;
  border-color:rgba(229, 231, 235, var(--tw-border-opacity));
}

.container{
  width:100%;
}

@media (min-width: 640px){
  .container{
    max-width:640px;
  }
}

@media (min-width: 768px){
  .container{
    max-width:768px;
  }
}

@media (min-width: 1024px){
  .container{
    max-width:1024px;
  }
}

@media (min-width: 1280px){
  .container{
    max-width:1280px;
  }
}

@media (min-width: 1536px){
  .container{
    max-width:1536px;
  }
}

.static{
  position:static;
}

.absolute{
  position:absolute;
}

.relative{
  position:relative;
}

.top-1\/2{
  top:50%;
}

.left-1\/2{
  left:50%;
}

.m-4{
  margin:1rem;
}

.mx-auto{
  margin-left:auto;
  margin-right:auto;
}

.my-2{
  margin-top:0.5rem;
  margin-bottom:0.5rem;
}

.my-4{
  margin-top:1rem;
  margin-bottom:1rem;
}

.mt-4{
  margin-top:1rem;
}

.mt-6{
  margin-top:1.5rem;
}

.mr-1{
  margin-right:0.25rem;
}

.mr-2{
  margin-right:0.5rem;
}

.mr-1\.5{
  margin-right:0.375rem;
}

.-mr-2{
  margin-right:-0.5rem;
}

.mb-3{
  margin-bottom:0.75rem;
}

.mb-4{
  margin-bottom:1rem;
}

.mb-6{
  margin-bottom:1.5rem;
}

.ml-2{
  margin-left:0.5rem;
}

.ml-4{
  margin-left:1rem;
}

.ml-10{
  margin-left:2.5rem;
}

.-ml-0{
  margin-left:0px;
}

.-ml-0\.5{
  margin-left:-0.125rem;
}

.block{
  display:block;
}

.flex{
  display:flex;
}

.inline-flex{
  display:inline-flex;
}

.table{
  display:table;
}

.hidden{
  display:none;
}

.h-2{
  height:0.5rem;
}

.h-4{
  height:1rem;
}

.h-6{
  height:1.5rem;
}

.h-8{
  height:2rem;
}

.h-12{
  height:3rem;
}

.h-16{
  height:4rem;
}

.w-2{
  width:0.5rem;
}

.w-6{
  width:1.5rem;
}

.w-8{
  width:2rem;
}

.w-12{
  width:3rem;
}

.w-64{
  width:16rem;
}

.w-1\/2{
  width:50%;
}

.w-3\/4{
  width:75%;
}

.w-full{
  width:100%;
}

.max-w-xs{
  max-width:20rem;
}

.max-w-sm{
  max-width:24rem;
}

.max-w-7xl{
  max-width:80rem;
}

.max-w-screen-md{
  max-width:768px;
}

.max-w-screen-xl{
  max-width:1280px;
}

.flex-1{
  flex:1 1 0%;
}

.flex-shrink-0{
  flex-shrink:0;
}

.transform{
  --tw-translate-x:0;
  --tw-translate-y:0;
  --tw-rotate:0;
  --tw-skew-x:0;
  --tw-skew-y:0;
  --tw-scale-x:1;
  --tw-scale-y:1;
  transform:translateX(var(--tw-translate-x)) translateY(var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y));
}

.-translate-x-1\/2{
  --tw-translate-x:-50%;
}

.-translate-y-1\/2{
  --tw-translate-y:-50%;
}

@-webkit-keyframes spin{
  to{
    transform:rotate(360deg);
  }
}

@keyframes spin{
  to{
    transform:rotate(360deg);
  }
}

@-webkit-keyframes ping{
  75%, 100%{
    transform:scale(2);
    opacity:0;
  }
}

@keyframes ping{
  75%, 100%{
    transform:scale(2);
    opacity:0;
  }
}

@-webkit-keyframes pulse{
  50%{
    opacity:.5;
  }
}

@keyframes pulse{
  50%{
    opacity:.5;
  }
}

@-webkit-keyframes bounce{
  0%, 100%{
    transform:translateY(-25%);
    -webkit-animation-timing-function:cubic-bezier(0.8,0,1,1);
            animation-timing-function:cubic-bezier(0.8,0,1,1);
  }

  50%{
    transform:none;
    -webkit-animation-timing-function:cubic-bezier(0,0,0.2,1);
            animation-timing-function:cubic-bezier(0,0,0.2,1);
  }
}

@keyframes bounce{
  0%, 100%{
    transform:translateY(-25%);
    -webkit-animation-timing-function:cubic-bezier(0.8,0,1,1);
            animation-timing-function:cubic-bezier(0.8,0,1,1);
  }

  50%{
    transform:none;
    -webkit-animation-timing-function:cubic-bezier(0,0,0.2,1);
            animation-timing-function:cubic-bezier(0,0,0.2,1);
  }
}

.appearance-none{
  -webkit-appearance:none;
     -moz-appearance:none;
          appearance:none;
}

.flex-col{
  flex-direction:column;
}

.flex-wrap{
  flex-wrap:wrap;
}

.items-center{
  align-items:center;
}

.items-baseline{
  align-items:baseline;
}

.justify-start{
  justify-content:flex-start;
}

.justify-center{
  justify-content:center;
}

.justify-between{
  justify-content:space-between;
}

.space-x-4 > :not([hidden]) ~ :not([hidden]){
  --tw-space-x-reverse:0;
  margin-right:calc(1rem * var(--tw-space-x-reverse));
  margin-left:calc(1rem * calc(1 - var(--tw-space-x-reverse)));
}

.space-y-1 > :not([hidden]) ~ :not([hidden]){
  --tw-space-y-reverse:0;
  margin-top:calc(0.25rem * calc(1 - var(--tw-space-y-reverse)));
  margin-bottom:calc(0.25rem * var(--tw-space-y-reverse));
}

.space-y-3 > :not([hidden]) ~ :not([hidden]){
  --tw-space-y-reverse:0;
  margin-top:calc(0.75rem * calc(1 - var(--tw-space-y-reverse)));
  margin-bottom:calc(0.75rem * var(--tw-space-y-reverse));
}

.rounded{
  border-radius:0.25rem;
}

.rounded-md{
  border-radius:0.375rem;
}

.rounded-lg{
  border-radius:0.5rem;
}

.rounded-xl{
  border-radius:0.75rem;
}

.rounded-2xl{
  border-radius:1rem;
}

.rounded-full{
  border-radius:9999px;
}

.rounded-l-full{
  border-top-left-radius:9999px;
  border-bottom-left-radius:9999px;
}

.border{
  border-width:1px;
}

.border-transparent{
  border-color:transparent;
}

.border-gray-300{
  --tw-border-opacity:1;
  border-color:rgba(209, 213, 219, var(--tw-border-opacity));
}

.hover\:border-white:hover{
  --tw-border-opacity:1;
  border-color:rgba(255, 255, 255, var(--tw-border-opacity));
}

.focus\:border-transparent:focus{
  border-color:transparent;
}

.bg-black{
  --tw-bg-opacity:1;
  background-color:rgba(0, 0, 0, var(--tw-bg-opacity));
}

.bg-white{
  --tw-bg-opacity:1;
  background-color:rgba(255, 255, 255, var(--tw-bg-opacity));
}

.bg-gray-100{
  --tw-bg-opacity:1;
  background-color:rgba(243, 244, 246, var(--tw-bg-opacity));
}

.bg-purple-200{
  --tw-bg-opacity:1;
  background-color:rgba(221, 214, 254, var(--tw-bg-opacity));
}

.hover\:bg-white:hover{
  --tw-bg-opacity:1;
  background-color:rgba(255, 255, 255, var(--tw-bg-opacity));
}

.hover\:bg-gray-500:hover{
  --tw-bg-opacity:1;
  background-color:rgba(107, 114, 128, var(--tw-bg-opacity));
}

.hover\:bg-gray-600:hover{
  --tw-bg-opacity:1;
  background-color:rgba(75, 85, 99, var(--tw-bg-opacity));
}

.hover\:bg-gray-800:hover{
  --tw-bg-opacity:1;
  background-color:rgba(31, 41, 55, var(--tw-bg-opacity));
}

.p-2{
  padding:0.5rem;
}

.p-4{
  padding:1rem;
}

.p-8{
  padding:2rem;
}

.px-2{
  padding-left:0.5rem;
  padding-right:0.5rem;
}

.px-3{
  padding-left:0.75rem;
  padding-right:0.75rem;
}

.px-4{
  padding-left:1rem;
  padding-right:1rem;
}

.px-6{
  padding-left:1.5rem;
  padding-right:1.5rem;
}

.px-8{
  padding-left:2rem;
  padding-right:2rem;
}

.px-2\.5{
  padding-left:0.625rem;
  padding-right:0.625rem;
}

.py-0{
  padding-top:0px;
  padding-bottom:0px;
}

.py-2{
  padding-top:0.5rem;
  padding-bottom:0.5rem;
}

.py-3{
  padding-top:0.75rem;
  padding-bottom:0.75rem;
}

.py-4{
  padding-top:1rem;
  padding-bottom:1rem;
}

.py-8{
  padding-top:2rem;
  padding-bottom:2rem;
}

.py-0\.5{
  padding-top:0.125rem;
  padding-bottom:0.125rem;
}

.pt-2{
  padding-top:0.5rem;
}

.pt-8{
  padding-top:2rem;
}

.pt-10{
  padding-top:2.5rem;
}

.pb-2{
  padding-bottom:0.5rem;
}

.pb-3{
  padding-bottom:0.75rem;
}

.pb-8{
  padding-bottom:2rem;
}

.text-left{
  text-align:left;
}

.text-center{
  text-align:center;
}

.text-right{
  text-align:right;
}

.text-xs{
  font-size:0.75rem;
  line-height:1rem;
}

.text-sm{
  font-size:0.875rem;
  line-height:1.25rem;
}

.text-base{
  font-size:1rem;
  line-height:1.5rem;
}

.text-lg{
  font-size:1.125rem;
  line-height:1.75rem;
}

.text-xl{
  font-size:1.25rem;
  line-height:1.75rem;
}

.text-2xl{
  font-size:1.5rem;
  line-height:2rem;
}

.text-3xl{
  font-size:1.875rem;
  line-height:2.25rem;
}

.text-4xl{
  font-size:2.25rem;
  line-height:2.5rem;
}

.text-5xl{
  font-size:3rem;
  line-height:1;
}

.font-thin{
  font-weight:100;
}

.font-light{
  font-weight:300;
}

.font-medium{
  font-weight:500;
}

.font-semibold{
  font-weight:600;
}

.font-bold{
  font-weight:700;
}

.capitalize{
  text-transform:capitalize;
}

.leading-tight{
  line-height:1.25;
}

.text-black{
  --tw-text-opacity:1;
  color:rgba(0, 0, 0, var(--tw-text-opacity));
}

.text-white{
  --tw-text-opacity:1;
  color:rgba(255, 255, 255, var(--tw-text-opacity));
}

.text-gray-300{
  --tw-text-opacity:1;
  color:rgba(209, 213, 219, var(--tw-text-opacity));
}

.text-gray-400{
  --tw-text-opacity:1;
  color:rgba(156, 163, 175, var(--tw-text-opacity));
}

.text-gray-500{
  --tw-text-opacity:1;
  color:rgba(107, 114, 128, var(--tw-text-opacity));
}

.text-gray-700{
  --tw-text-opacity:1;
  color:rgba(55, 65, 81, var(--tw-text-opacity));
}

.text-gray-800{
  --tw-text-opacity:1;
  color:rgba(31, 41, 55, var(--tw-text-opacity));
}

.text-green-500{
  --tw-text-opacity:1;
  color:rgba(16, 185, 129, var(--tw-text-opacity));
}

.text-purple-500{
  --tw-text-opacity:1;
  color:rgba(139, 92, 246, var(--tw-text-opacity));
}

.hover\:text-white:hover{
  --tw-text-opacity:1;
  color:rgba(255, 255, 255, var(--tw-text-opacity));
}

.hover\:text-gray-300:hover{
  --tw-text-opacity:1;
  color:rgba(209, 213, 219, var(--tw-text-opacity));
}

.hover\:text-gray-800:hover{
  --tw-text-opacity:1;
  color:rgba(31, 41, 55, var(--tw-text-opacity));
}

.placeholder-gray-400::-moz-placeholder{
  --tw-placeholder-opacity:1;
  color:rgba(156, 163, 175, var(--tw-placeholder-opacity));
}

.placeholder-gray-400:-ms-input-placeholder{
  --tw-placeholder-opacity:1;
  color:rgba(156, 163, 175, var(--tw-placeholder-opacity));
}

.placeholder-gray-400::placeholder{
  --tw-placeholder-opacity:1;
  color:rgba(156, 163, 175, var(--tw-placeholder-opacity));
}

.opacity-50{
  opacity:0.5;
}

*, ::before, ::after{
  --tw-shadow:0 0 #0000;
}

.shadow-sm{
  --tw-shadow:0 1px 2px 0 rgba(0, 0, 0, 0.05);
  box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow);
}

.shadow{
  --tw-shadow:0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
  box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow);
}

.shadow-md{
  --tw-shadow:0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow);
}

.shadow-lg{
  --tw-shadow:0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
  box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow);
}

.shadow-xl{
  --tw-shadow:0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
  box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow);
}

.focus\:outline-none:focus{
  outline:2px solid transparent;
  outline-offset:2px;
}

*, ::before, ::after{
  --tw-ring-inset:var(--tw-empty,/*!*/ /*!*/);
  --tw-ring-offset-width:0px;
  --tw-ring-offset-color:#fff;
  --tw-ring-color:rgba(59, 130, 246, 0.5);
  --tw-ring-offset-shadow:0 0 #0000;
  --tw-ring-shadow:0 0 #0000;
}

.focus\:ring-2:focus{
  --tw-ring-offset-shadow:var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);
  --tw-ring-shadow:var(--tw-ring-inset) 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color);
  box-shadow:var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000);
}

.focus\:ring-white:focus{
  --tw-ring-opacity:1;
  --tw-ring-color:rgba(255, 255, 255, var(--tw-ring-opacity));
}

.focus\:ring-gray-400:focus{
  --tw-ring-opacity:1;
  --tw-ring-color:rgba(156, 163, 175, var(--tw-ring-opacity));
}

.focus\:ring-offset-2:focus{
  --tw-ring-offset-width:2px;
}

.focus\:ring-offset-white:focus{
  --tw-ring-offset-color:#fff;
}

.filter{
  --tw-blur:var(--tw-empty,/*!*/ /*!*/);
  --tw-brightness:var(--tw-empty,/*!*/ /*!*/);
  --tw-contrast:var(--tw-empty,/*!*/ /*!*/);
  --tw-grayscale:var(--tw-empty,/*!*/ /*!*/);
  --tw-hue-rotate:var(--tw-empty,/*!*/ /*!*/);
  --tw-invert:var(--tw-empty,/*!*/ /*!*/);
  --tw-saturate:var(--tw-empty,/*!*/ /*!*/);
  --tw-sepia:var(--tw-empty,/*!*/ /*!*/);
  --tw-drop-shadow:var(--tw-empty,/*!*/ /*!*/);
  filter:var(--tw-blur) var(--tw-brightness) var(--tw-contrast) var(--tw-grayscale) var(--tw-hue-rotate) var(--tw-invert) var(--tw-saturate) var(--tw-sepia) var(--tw-drop-shadow);
}

.transition-colors{
  transition-property:background-color, border-color, color, fill, stroke;
  transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);
  transition-duration:150ms;
}

.duration-200{
  transition-duration:200ms;
}

@media (min-width: 640px){
  .sm\:px-3{
    padding-left:0.75rem;
    padding-right:0.75rem;
  }

  .sm\:pt-12{
    padding-top:3rem;
  }
}

@media (min-width: 768px){
  .md\:ml-6{
    margin-left:1.5rem;
  }

  .md\:block{
    display:block;
  }

  .md\:flex{
    display:flex;
  }

  .md\:hidden{
    display:none;
  }

  .md\:w-full{
    width:100%;
  }

  .md\:flex-row{
    flex-direction:row;
  }

  .md\:justify-between{
    justify-content:space-between;
  }

  .md\:space-x-3 > :not([hidden]) ~ :not([hidden]){
    --tw-space-x-reverse:0;
    margin-right:calc(0.75rem * var(--tw-space-x-reverse));
    margin-left:calc(0.75rem * calc(1 - var(--tw-space-x-reverse)));
  }

  .md\:space-y-0 > :not([hidden]) ~ :not([hidden]){
    --tw-space-y-reverse:0;
    margin-top:calc(0px * calc(1 - var(--tw-space-y-reverse)));
    margin-bottom:calc(0px * var(--tw-space-y-reverse));
  }

  .md\:p-16{
    padding:4rem;
  }

  .md\:text-center{
    text-align:center;
  }

  .md\:text-3xl{
    font-size:1.875rem;
    line-height:2.25rem;
  }
}

@media (min-width: 1024px){
}

@media (min-width: 1280px){
}

@media (min-width: 1536px){
}
/*purgecss start ignore*/
.nuxt-progress{
  position:fixed;
  top:0;
  left:0;
  right:0;
  height:2px;
  width:0;
  opacity:1;
  transition:width .1s,opacity .4s;
  background-color:#000;
  z-index:999999
}
.nuxt-progress.nuxt-progress-notransition{
  transition:none
}
.nuxt-progress-failed{
  background-color:red
}

/*purgecss end ignore*/
/*purgecss start ignore*/
:root{
  --gray:#666
}
html{
  font-family:"Oxygen"
}
body{
  background:#0f0f0f;
  font-family:"Space Mono";
  color:#fff
}

/*purgecss end ignore*/
/*purgecss start ignore*/

/*purgecss end ignore*/
/*purgecss start ignore*/
.page-wrapper[data-v-3bf13c85]{
  margin:auto;
  padding:1rem
}
.article-content-wrapper[data-v-3bf13c85]{
  display:flex;
  flex-direction:column;
  align-items:center;
  margin:auto auto 2rem
}
.article-content-wrapper .article-block[data-v-3bf13c85]{
  width:100%;
  max-width:880px
}
.article-content-wrapper .aside-username-wrapper[data-v-3bf13c85]{
  max-width:880px;
  width:100%;
  position:relative
}
.article-content-wrapper .aside-username-wrapper .aside-username-block[data-v-3bf13c85]{
  position:-webkit-sticky;
  position:sticky;
  top:1rem
}

/*purgecss end ignore*/
/*purgecss start ignore*/
article[data-v-25febe66]{
  padding:.5rem;
  border-radius:1rem
}
header[data-v-25febe66],header h1[data-v-25febe66]{
  margin-bottom:1rem
}
header .tags[data-v-25febe66]{
  display:flex;
  flex-wrap:wrap;
  margin-bottom:1.5rem
}
header .tags .tag[data-v-25febe66]{
  line-height:1;
  padding:.5rem;
  margin:0 .5rem .5rem 0;
  border-radius:.25rem
}
header .tags .tag[data-v-25febe66]:active{
  background:transparent
}
header .image-wrapper[data-v-25febe66]{
  position:relative;
  padding-bottom:56.25%;
  margin-bottom:1.5rem;
  border-radius:.5rem;
  overflow:hidden
}
header .image-wrapper img[data-v-25febe66]{
  position:absolute;
  top:0;
  left:0;
  width:100%;
  height:100%;
  -o-object-fit:cover;
     object-fit:cover
}
header .meta[data-v-25febe66]{
  line-height:1;
  text-transform:uppercase;
  display:flex;
  align-items:center;
  justify-content:space-between
}
header .meta .scl[data-v-25febe66]{
  display:flex
}
header .meta .scl span[data-v-25febe66]{
  display:flex;
  align-items:center;
  margin-right:1rem
}
header .meta .scl span svg[data-v-25febe66]{
  margin-right:.25rem
}
header .meta .scl .comments[data-v-25febe66]{
  cursor:pointer
}
[data-v-25febe66] .content .ltag__user{
  display:none
}
[data-v-25febe66] .content iframe{
  max-width:100%
}
[data-v-25febe66] .content h1,[data-v-25febe66] .content h2,[data-v-25febe66] .content h3,[data-v-25febe66] .content h4{
  margin-top:2rem;
  margin-bottom:1rem
}
[data-v-25febe66] .content p{
  margin-bottom:1rem;
  line-height:1.4
}
[data-v-25febe66] .content p code{
  background-color:#d2f3e1;
  border-radius:.25rem;
  padding:.25rem
}
[data-v-25febe66] .content img{
  width:100%;
  border-radius:.5rem
}
[data-v-25febe66] .content .highlight{
  margin-bottom:1rem;
  border-radius:.5rem
}
[data-v-25febe66] .content ul{
  list-style:numeral;
  margin-bottom:1rem
}
[data-v-25febe66] .content ul li p{
  margin-bottom:0
}
[data-v-25febe66] .content ol{
  margin-bottom:1rem
}

/*purgecss end ignore*/
/*purgecss start ignore*/
aside[data-v-29ea5fa2]{
  padding:1rem;
  border-radius:1rem
}
aside .username-heading[data-v-29ea5fa2]{
  display:flex;
  margin-bottom:1rem
}
aside .username-heading img[data-v-29ea5fa2]{
  width:3rem;
  height:3rem;
  border-radius:50%;
  margin-right:1rem
}
aside .username-heading .text[data-v-29ea5fa2]{
  display:flex;
  flex-direction:column;
  justify-content:center
}
aside .username-heading .text a[data-v-29ea5fa2]{
  line-height:1
}
aside .username-heading .text a[data-v-29ea5fa2]:first-child{
  margin-bottom:.25rem
}
aside .username-heading.loading[data-v-29ea5fa2]{
  display:block
}
aside .f-button[data-v-29ea5fa2]{
  display:block;
  width:100%;
  padding:.5rem;
  border-radius:.5rem;
  text-transform:uppercase;
  text-align:center;
  margin-bottom:1rem
}
aside .f-button[data-v-29ea5fa2]:active{
  background:transparent
}
aside .info>div[data-v-29ea5fa2]{
  margin-bottom:.5rem
}
aside .info .title[data-v-29ea5fa2]{
  text-transform:uppercase;
  margin-bottom:.1rem
}
aside .info .content[data-v-29ea5fa2]{
  line-height:1.4
}

/*purgecss end ignore*/
/*purgecss start ignore*/
.add-comment[data-v-54aa1ab4]{
  display:block;
  width:100%;
  padding:.5rem;
  border-radius:.5rem;
  text-transform:uppercase;
  text-align:center;
  margin-bottom:1rem
}
.add-comment[data-v-54aa1ab4]:active{
  background:transparent
}

/*purgecss end ignore*/</style><link rel="preload" href="/_nuxt/static/1634322943/articles/elthrasher/628138/state.js" as="script"><link rel="preload" href="/_nuxt/static/1634322943/articles/elthrasher/628138/payload.js" as="script"><link rel="preload" href="/_nuxt/static/1634322943/manifest.js" as="script">
  </head>
  <body >
    <div data-server-rendered="true" id="__nuxt"><!----><div id="__layout"><div><div><nav class="py-4"><div class="max-w-7xl mx-auto px-8"><div class="flex items-center justify-between h-16"><div class="flex items-center"><div class="flex items-center"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" x="0px" y="0px" viewBox="0 0 50 62.5" enable-background="new 0 0 50 50" xml:space="preserve"><path fill="#FFFFFF" d="M25,1C11.745,1,1,11.745,1,25s10.745,24,24,24s24-10.745,24-24S38.255,1,25,1z M17.887,38.646  c0.097,0.099,0.097,0.257-0.001,0.354c-0.049,0.049-0.112,0.073-0.176,0.073s-0.128-0.024-0.177-0.073L3.767,25.177  c-0.028-0.028-0.031-0.067-0.042-0.103c-0.008-0.025-0.03-0.047-0.03-0.073s0.022-0.048,0.03-0.073  c0.012-0.036,0.014-0.075,0.042-0.103l13.766-13.823c0.098-0.099,0.256-0.098,0.354-0.001c0.098,0.098,0.098,0.256,0.001,0.354  L4.297,25.001L17.887,38.646z M46.232,25.178c0,0-0.001,0-0.002,0l-13.765,13.82c-0.049,0.049-0.112,0.073-0.177,0.073  c-0.063,0-0.128-0.024-0.177-0.073c-0.098-0.097-0.098-0.255,0-0.354l13.591-13.645L32.112,11.354c-0.098-0.098-0.098-0.256,0-0.354  c0.098-0.097,0.256-0.097,0.354,0.001L46.23,24.823c0.001,0,0.002,0,0.002,0c0.049,0.049,0.073,0.113,0.073,0.177  S46.281,25.129,46.232,25.178z"></path></svg> <h1 class="text-white text-2xl px-2 pb-2">CodeLabs.</h1></div> <div class="hidden md:block"><div class="ml-10 flex items-baseline space-x-4"><a href="/" class="
                  text-gray-300
                  hover:border-white
                  border border-transparent
                  px-3
                  py-2
                  rounded-md
                  text-sm
                  font-medium
                 nuxt-link-active bg-white text-gray-800">Home</a><a href="/articles/elthrasher/Articles" class="
                  text-gray-300
                  hover:border-white
                  border border-transparent
                  px-3
                  py-2
                  rounded-md
                  text-sm
                  font-medium
                ">Articles</a><a href="/articles/elthrasher/Lessons" class="
                  text-gray-300
                  hover:border-white
                  border border-transparent
                  px-3
                  py-2
                  rounded-md
                  text-sm
                  font-medium
                ">Lessons</a><a href="/articles/elthrasher/Courses" class="
                  text-gray-300
                  hover:border-white
                  border border-transparent
                  px-3
                  py-2
                  rounded-md
                  text-sm
                  font-medium
                ">Courses</a><a href="/articles/elthrasher/Pricing" class="
                  text-gray-300
                  hover:border-white
                  border border-transparent
                  px-3
                  py-2
                  rounded-md
                  text-sm
                  font-medium
                ">Pricing</a><a href="/articles/elthrasher/Sponsor" class="
                  text-gray-300
                  hover:border-white
                  border border-transparent
                  px-3
                  py-2
                  rounded-md
                  text-sm
                  font-medium
                ">Sponsor</a></div></div></div> <div class="block"><div class="ml-4 flex items-center md:ml-6"></div></div> <div class="-mr-2 flex md:hidden"><button class="
              text-white
              hover:bg-white hover:text-gray-300
              inline-flex
              items-center
              justify-center
              p-2
              rounded-md
              focus:outline-none
            "><svg width="20" height="20" fill="currentColor" viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg" class="h-8 w-8"><path d="M1664 1344v128q0 26-19 45t-45 19h-1408q-26 0-45-19t-19-45v-128q0-26 19-45t45-19h1408q26 0 45 19t19 45zm0-512v128q0 26-19 45t-45 19h-1408q-26 0-45-19t-19-45v-128q0-26 19-45t45-19h1408q26 0 45 19t19 45zm0-512v128q0 26-19 45t-45 19h-1408q-26 0-45-19t-19-45v-128q0-26 19-45t45-19h1408q26 0 45 19t19 45z"></path></svg></button></div></div></div> <div class="md:hidden hidden"><div class="px-2 pt-2 pb-3 space-y-1 sm:px-3"><a href="/" class="
            text-gray-300
            border border-transparent
            hover:border-white
            block
            px-3
            py-2
            rounded-md
            text-base
            font-medium
           nuxt-link-active text-gray-800 bg-white">Home</a><a href="/articles/elthrasher/Articles" class="
            text-gray-300
            border border-transparent
            hover:border-white
            block
            px-3
            py-2
            rounded-md
            text-base
            font-medium
          ">Articles</a><a href="/articles/elthrasher/Lessons" class="
            text-gray-300
            border border-transparent
            hover:border-white
            block
            px-3
            py-2
            rounded-md
            text-base
            font-medium
          ">Lessons</a><a href="/articles/elthrasher/Courses" class="
            text-gray-300
            border border-transparent
            hover:border-white
            block
            px-3
            py-2
            rounded-md
            text-base
            font-medium
          ">Courses</a><a href="/articles/elthrasher/Pricing" class="
            text-gray-300
            border border-transparent
            hover:border-white
            block
            px-3
            py-2
            rounded-md
            text-base
            font-medium
          ">Pricing</a><a href="/articles/elthrasher/Sponsor" class="
            text-gray-300
            border border-transparent
            hover:border-white
            block
            px-3
            py-2
            rounded-md
            text-base
            font-medium
          ">Sponsor</a></div></div></nav></div> <div class="page-wrapper" data-v-3bf13c85><div class="article-content-wrapper" data-v-3bf13c85><article data-fetch-key="data-v-25febe66:0" class="article-block" data-v-25febe66 data-v-3bf13c85><header data-v-25febe66><h1 data-v-25febe66>rego.fyi: A Study in Serverless Authorization with Open Policy Agent</h1> <div class="tags" data-v-25febe66><a href="/articles/t/cdk" class="tag" data-v-25febe66>
          #cdk
        </a><a href="/articles/t/security" class="tag" data-v-25febe66>
          #security
        </a><a href="/articles/t/serverless" class="tag" data-v-25febe66>
          #serverless
        </a><a href="/articles/t/opa" class="tag" data-v-25febe66>
          #opa
        </a></div> <div class="image-wrapper" data-v-25febe66><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--RWFYCW_s--/c_imagga_scale,f_auto,fl_progressive,h_420,q_auto,w_1000/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/c1z1qo56feylpjpcpidn.jpg" alt="rego.fyi: A Study in Serverless Authorization with Open Policy Agent" data-v-25febe66></div> <div class="meta" data-v-25febe66><div class="scl" data-v-25febe66><span data-v-25febe66><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-25febe66 data-v-25febe66><path d="M16.4444 3C14.6733 3 13.0333 3.94162 12 5.34C10.9667 3.94162 9.32667 3 7.55556 3C4.49222 3 2 5.52338 2 8.625C2 14.8024 11.0267 20.586 11.4122 20.829C11.5922 20.9426 11.7956 21 12 21C12.2044 21 12.4078 20.9426 12.5878 20.829C12.9733 20.586 22 14.8024 22 8.625C22 5.52338 19.5078 3 16.4444 3Z" fill="#FF0000" data-v-25febe66 data-v-25febe66></path></svg>
            15
          </span> <span class="comments" data-v-25febe66><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-25febe66 data-v-25febe66><path d="M6.11765 22H4.94118L5.64706 21.05C6.11765 20.3969 6.41176 19.5656 6.58824 18.5563C3.64706 17.1906 2 14.6375 2 11.3125C2 6.20625 5.82353 3 12 3C18.1765 3 22 6.20625 22 11.3125C22 16.5375 18.2353 19.625 12 19.625H11.5882C10.6471 20.7531 9 22 6.11765 22ZM12 4.1875C6.47059 4.1875 3.17647 6.85937 3.17647 11.3125C3.17647 15.1125 5.47059 16.8938 7.41177 17.6656L7.82353 17.8437L7.76471 18.3187C7.64706 19.2687 7.47059 20.1 7.11765 20.8125C9.05882 20.575 10.1765 19.5656 10.8235 18.7344L11 18.4969H12C19.9412 18.4969 20.8235 13.5094 20.8235 11.3719C20.8235 6.85938 17.5294 4.1875 12 4.1875Z" fill="black" data-v-25febe66 data-v-25febe66></path></svg>
            0
          </span></div> <time data-v-25febe66>Mar 8</time></div></header> <div class="content" data-v-25febe66><p><a href="https://www.openpolicyagent.org/docs/latest/">Open Policy Agent</a> is a decision engine built on a declarative language called <a href="https://www.openpolicyagent.org/docs/latest/#rego">Rego</a>. OPA is pronounced "oh-pa", but <em>to na kang setóp da mesach!</em> so go ahead and say "oh-pee-ayy" because I know you want to. OPA is general-purpose and written in Go. It allows the creation and compilation of policies written in Rego which can then be hydrated with some kind of data source and then compared against an input to produce a result. OPA docs, linked above, are excellent so check them out for more information.</p>

<h2>
  <a name="table-of-contents" href="#table-of-contents">
  </a>
  Table of Contents
</h2>

<ul>
<li><a href="#tldr">tldr</a></li>
<li><a href="#whyopa">Why OPA?</a></li>
<li><a href="#serverlessopa">Serverless OPA</a></li>
<li><a href="#regofyi">rego.fyi</a></li>
<li><a href="#regopolicy">Rego Policy</a></li>
<li><a href="#opaauthorizer">OPA Authorizer</a></li>
<li><a href="#webapp">Web App</a></li>
<li><a href="#awscdk">AWS CDK</a></li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>

<h2>
  <a name="tldr" href="#tldr">
  </a>
  tl;dr<a name="tldr"></a>
</h2>

<p><a href="https://github.com/elthrasher/rego.fyi">The code is here!</a><br>
<a href="https://rego.fyi">rego.fyi</a></p>
<h2>
  <a name="why-opa" href="#why-opa">
  </a>
  Why OPA?<a name="whyopa"></a>
</h2>

<p>The paradigm presented by OPA is compelling when applied to the use case of multi-tenant SaaS applications. Such applications have complex authorization rules which may include ensuring a user acts within their tenant or personal data, ensuring a user has the right role or permission, ensuring the user belongs to a tenant that is subscribed to the service being provided and many others. Often these rules are implemented in imperative logic throughout the application. A check for subscription may be implemented in middleware while limiting the scope of tenant access is often found in the WHERE clause of a SQL query. Spreading authorization concerns throughout an application makes it very hard to audit and understand what rules the application are actually enforcing and it makes it easy for bugs to creep in.</p>

<p>The more complex the application, the more authorization becomes a problem that needs a single solution. This is the problem OPA can solve. It's enticing to think about authorizing a microservice architecture with OPA. This would allow developers to focus on the problem the service needs to solve and share a common authorization abstraction.</p>
<h2>
  <a name="serverless-opa" href="#serverless-opa">
  </a>
  Serverless OPA<a name="serverlessopa"></a>
</h2>

<p>The usual way to implement OPA for microservices is to stand up an authorization service implementing OPA and have other services invoke it over http using some of the <a href="https://www.openpolicyagent.org/docs/latest/ecosystem/">published middleware</a>. Even the <a href="https://github.com/adaptant-labs/openfaas-function-auth-opa/blob/master/opa-auth/handler.go#L35">OpenFaaS version written in Go</a> depends on a standalone authorization service. I wanted to see if I could use OPA in a 100% serverless environment, making policy decisions in an API Gateway request authorizer without the overhead of additional http requests or the need to run a separate service. I found inspiration in this excellent <a href="https://github.com/zotoio/sls-lambda-opa">sls-lambda-opa</a> repo.</p>

<p>I think of this solution as a layered architecture, where the bottom layer is the authorizer implementing the OPA library, capable of compiling Rego policies. On top of that is the actual policy that states I want to compare a claim like <code>permissions</code> or <code>subscriptions</code> or I'm interested in the HTTP resource and method. Above that is the service or endpoint-specific data that states the actual resources, methods and subscriptions that will be evaluated. Then finally we have the user's session or context, delivered in a <a href="https://jwt.io">JSON Web Token (or JWT)</a>.</p>

<p><figure><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--XL1OF_Hz--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/48x897ff2gjbotbaj2a5.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--XL1OF_Hz--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/48x897ff2gjbotbaj2a5.png" alt="Layers of OPA" loading="lazy"></a><figcaption>OPA sandwich?</figcaption></figure></p>

<p>Each of these layers can be decoupled from the others. An authorizer function implementation might be used across several services with the same policy but different data hydrating the policy.</p>
<h2>
  <a name="regofyi" href="#regofyi">
  </a>
  rego.fyi<a name="regofyi"></a>
</h2>

<p>My first attempt at putting all this together was a fairly terrible demo that needed a REST client and the copying of tokens. I had the urge to build a little fullstack app and so I came up with <a href="https://rego.fyi">rego.fyi</a>. In some ways, it's a less impressive take on <a href="https://play.openpolicyagent.org/">The Rego Playground</a>, but mine is serverless and built on the kind of architecture I want to work with. I'll also caveat that I am absolute trash when it comes to visual design. I'm just awful at it. Respect to those who are good, but I'm not one of you.</p>

<p>The architecture of my app is a little different than what I'd envision using in production. I wanted to be able to experiment with different policies, so the policies, along with data and the user input are all sent to be evaluated by my authorizer function. The authorizer compiles the policy in real time, makes the policy decision based on the data and user input, then returns an IAM policy document specifying whether my Lambda function can be invoked, as appropriate.</p>

<p>In a real application, I likely wouldn't want to compile the policy on request, but instead compile it once on startup. I don't have the expectation of needing to change policies on the fly, though if I did, the policy could be loaded from S3 or a database. What I would probably do in a real application is load the policy from a Lambda Layer.</p>
<h2>
  <a name="rego-policy" href="#rego-policy">
  </a>
  Rego Policy<a name="regopolicy"></a>
</h2>

<p>I am by no means an expert on the rego language and won't give an overview here when there are already <a href="https://www.openpolicyagent.org/docs/latest/#rego">useful docs</a>. I did manage to put together a workable policy for my experiment.<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight rego"><code><span class="ow">package</span> <span class="n">policy</span>

<span class="ow">import</span> <span class="n">data</span><span class="p">.</span><span class="n">requests</span>
<span class="ow">import</span> <span class="n">data</span><span class="p">.</span><span class="n">permissions</span>
<span class="ow">import</span> <span class="n">data</span><span class="p">.</span><span class="n">subscriptions</span>

<span class="ow">default</span> <span class="n">allow</span> <span class="o">=</span> <span class="kc">false</span>

<span class="n">allow</span> <span class="p">{</span>
    <span class="n">check_policy</span><span class="p">[</span><span class="n">input</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">check_policy</span><span class="p">[</span><span class="n">input</span><span class="p">]</span> <span class="p">{</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">[</span><span class="n">_</span><span class="p">]</span>
    <span class="ow">some</span> <span class="n">i</span><span class="p">;</span> <span class="n">match_with_wildcard</span><span class="p">(</span><span class="n">permissions</span><span class="p">,</span> <span class="n">input</span><span class="p">.</span><span class="n">permissions</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="ow">some</span> <span class="n">j</span><span class="p">;</span> <span class="n">match_with_wildcard</span><span class="p">(</span><span class="n">subscriptions</span><span class="p">,</span> <span class="n">input</span><span class="p">.</span><span class="n">subscriptions</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
    <span class="n">match_with_wildcard</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">methods</span><span class="p">,</span> <span class="n">input</span><span class="p">.</span><span class="n">method</span><span class="p">)</span>
    <span class="n">match_with_wildcard</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">resources</span><span class="p">,</span> <span class="n">input</span><span class="p">.</span><span class="n">resource</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">match_with_wildcard</span><span class="p">(</span><span class="n">allowed</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">allowed</span><span class="p">[</span><span class="n">_</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"*"</span>
<span class="p">}</span>
<span class="n">match_with_wildcard</span><span class="p">(</span><span class="n">allowed</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">allowed</span><span class="p">[</span><span class="n">_</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
<span class="p">}</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>The syntax of this policy is <a href="https://www.openpolicyagent.org/docs/latest/policy-language/">explained well in the docs</a>, but just to call out a few things, everything in <code>check_policy</code> can be considered an AND comparison while the duplicative call signature of <code>match_with_wildcard</code> makes it an OR comparison. <code>some i; match_with_wildcard(permissions, input.permissions[i])</code> is a fairly elegant one-liner that makes sure one item in the left-side array matches at least one item in the right-side array.</p>

<p>Note the policy defines fields I care about, namely the HTTP <code>method</code> and <code>resource</code> as well as my custom claims of <code>permissions</code> and <code>subscriptions</code>. This policy doesn't include anything about the values that should be compared to, but does describe the shape of the data and how it should be compared. In order to give those values, we need a data file.<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"requests"</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="w"> </span><span class="nl">"methods"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"GET"</span><span class="p">],</span><span class="w"> </span><span class="nl">"resources"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"/orders"</span><span class="p">]</span><span class="w"> </span><span class="p">}],</span><span class="w">
  </span><span class="nl">"permissions"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"start_order"</span><span class="p">,</span><span class="w"> </span><span class="s2">"view_invoice"</span><span class="p">],</span><span class="w">
  </span><span class="nl">"subscriptions"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"newsletter"</span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>This data file could apply to one API while another one with permissions like <code>cuddle_hedgehogs</code> or <code>introspect_navel</code> protects another one. That's the power of this layered approach! But the best part is rego ships with a <a href="https://www.openpolicyagent.org/docs/latest/policy-testing/">testing framework</a>.</p>

<p>The best way to experience a good separation of concerns is with some solid unit tests. They are quite easy to write.<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight rego"><code><span class="ow">package</span> <span class="n">policy</span>

<span class="n">test_get_allowed</span> <span class="p">{</span>
    <span class="n">allow</span> <span class="ow">with</span> <span class="n">input</span> <span class="ow">as</span> <span class="p">{</span><span class="s2">"permissions"</span><span class="o">:</span><span class="p">[</span><span class="s2">"start_order"</span><span class="p">],</span> <span class="s2">"resource"</span><span class="o">:</span> <span class="s2">"/orders"</span><span class="p">,</span> <span class="s2">"method"</span><span class="o">:</span><span class="s2">"GET"</span><span class="p">,</span> <span class="s2">"subscriptions"</span><span class="o">:</span><span class="p">[</span><span class="s2">"newsletter"</span><span class="p">]}</span>
<span class="p">}</span>

<span class="n">test_get_wrong_subcription_denied</span> <span class="p">{</span>
    <span class="ow">not</span> <span class="n">allow</span> <span class="ow">with</span> <span class="n">input</span> <span class="ow">as</span> <span class="p">{</span><span class="s2">"permissions"</span><span class="o">:</span><span class="p">[</span><span class="s2">"start_order"</span><span class="p">],</span> <span class="s2">"resource"</span><span class="o">:</span> <span class="s2">"/orders"</span><span class="p">,</span> <span class="s2">"method"</span><span class="o">:</span><span class="s2">"GET"</span><span class="p">,</span> <span class="s2">"subscriptions"</span><span class="o">:</span><span class="p">[</span><span class="s2">"pizza_of_the_month"</span><span class="p">]}</span>
<span class="p">}</span>

<span class="n">test_get_wrong_permission_denied</span> <span class="p">{</span>
    <span class="ow">not</span> <span class="n">allow</span> <span class="ow">with</span> <span class="n">input</span> <span class="ow">as</span> <span class="p">{</span><span class="s2">"permissions"</span><span class="o">:</span><span class="p">[</span><span class="s2">"change_password"</span><span class="p">],</span> <span class="s2">"resource"</span><span class="o">:</span> <span class="s2">"/orders"</span><span class="p">,</span> <span class="s2">"method"</span><span class="o">:</span><span class="s2">"GET"</span><span class="p">,</span> <span class="s2">"subscriptions"</span><span class="o">:</span><span class="p">[</span><span class="s2">"newsletter"</span><span class="p">]}</span>
<span class="p">}</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>I'm providing the different user inputs and expecting them to either be allowed or not. Rego also gives me test coverage out of the box!<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight shell"><code>% opa <span class="nb">test</span> <span class="nb">.</span> <span class="nt">-c</span>
<span class="o">{</span>
  <span class="s2">"files"</span>: <span class="o">{</span>
    <span class="s2">"policy.rego"</span>: <span class="o">{</span>
      <span class="s2">"covered"</span>: <span class="o">[</span>
        <span class="o">{</span>
          <span class="s2">"start"</span>: <span class="o">{</span>
            <span class="s2">"row"</span>: 7
          <span class="o">}</span>,
          <span class="s2">"end"</span>: <span class="o">{</span>
            <span class="s2">"row"</span>: 7
          <span class="o">}</span>
        <span class="o">}</span>,
        <span class="o">{</span>
          <span class="s2">"start"</span>: <span class="o">{</span>
            <span class="s2">"row"</span>: 9
          <span class="o">}</span>,
          <span class="s2">"end"</span>: <span class="o">{</span>
            <span class="s2">"row"</span>: 10
          <span class="o">}</span>
        <span class="o">}</span>,
        <span class="o">{</span>
          <span class="s2">"start"</span>: <span class="o">{</span>
            <span class="s2">"row"</span>: 13
          <span class="o">}</span>,
          <span class="s2">"end"</span>: <span class="o">{</span>
            <span class="s2">"row"</span>: 18
          <span class="o">}</span>
        <span class="o">}</span>,
        <span class="o">{</span>
          <span class="s2">"start"</span>: <span class="o">{</span>
            <span class="s2">"row"</span>: 22
          <span class="o">}</span>,
          <span class="s2">"end"</span>: <span class="o">{</span>
            <span class="s2">"row"</span>: 22
          <span class="o">}</span>
        <span class="o">}</span>,
        <span class="o">{</span>
          <span class="s2">"start"</span>: <span class="o">{</span>
            <span class="s2">"row"</span>: 24
          <span class="o">}</span>,
          <span class="s2">"end"</span>: <span class="o">{</span>
            <span class="s2">"row"</span>: 25
          <span class="o">}</span>
        <span class="o">}</span>
      <span class="o">]</span>,
      <span class="s2">"not_covered"</span>: <span class="o">[</span>
        <span class="o">{</span>
          <span class="s2">"start"</span>: <span class="o">{</span>
            <span class="s2">"row"</span>: 21
          <span class="o">}</span>,
          <span class="s2">"end"</span>: <span class="o">{</span>
            <span class="s2">"row"</span>: 21
          <span class="o">}</span>
        <span class="o">}</span>
      <span class="o">]</span>,
      <span class="s2">"coverage"</span>: 92.3
    <span class="o">}</span>,
    <span class="s2">"policy_test.rego"</span>: <span class="o">{</span>
      <span class="s2">"covered"</span>: <span class="o">[</span>
        <span class="o">{</span>
          <span class="s2">"start"</span>: <span class="o">{</span>
            <span class="s2">"row"</span>: 3
          <span class="o">}</span>,
          <span class="s2">"end"</span>: <span class="o">{</span>
            <span class="s2">"row"</span>: 4
          <span class="o">}</span>
        <span class="o">}</span>,
        <span class="o">{</span>
          <span class="s2">"start"</span>: <span class="o">{</span>
            <span class="s2">"row"</span>: 7
          <span class="o">}</span>,
          <span class="s2">"end"</span>: <span class="o">{</span>
            <span class="s2">"row"</span>: 8
          <span class="o">}</span>
        <span class="o">}</span>,
        <span class="o">{</span>
          <span class="s2">"start"</span>: <span class="o">{</span>
            <span class="s2">"row"</span>: 11
          <span class="o">}</span>,
          <span class="s2">"end"</span>: <span class="o">{</span>
            <span class="s2">"row"</span>: 12
          <span class="o">}</span>
        <span class="o">}</span>
      <span class="o">]</span>,
      <span class="s2">"coverage"</span>: 100
    <span class="o">}</span>
  <span class="o">}</span>,
  <span class="s2">"coverage"</span>: 94.75
<span class="o">}</span>
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>Okay, that's a bit verbose and looks like I need another test, but still really useful. There's a <code>--format=pretty</code> option, but it doesn't seem to do anything. Perhaps it's a WIP.</p>

<p>Anyway, this is great! Our old applications with some of the authorization logic in middleware, some in SQL and some in between just can't compete with the ability to unit test the policy logic separate from any application code.</p>

<h2>
  <a name="opa-authorizer" href="#opa-authorizer">
  </a>
  OPA Authorizer<a name="opaauthorizer"></a>
</h2>

<p>The only difference between a RequestAuthorizer and a TokenAuthorizer is the TokenAuthorizer only sees the specified token while a RequestAuthorizer sees the entire request. This is a better fit, since I want to look at things like the HTTP method and path.</p>

<p>My authorizer function needs to:</p>

<ol>
<li>Unpack my "token" (which really consists of the policy, data and user token, base64 encoded for demo purposes)</li>
<li>Compile the policy with the provided data.</li>
<li>Compare the user input and request to the policy.</li>
<li>Return an appropriate IAM policy to allow or deny access to the function handler.</li>
</ol>

<p>This authorizer needs to be written in Go because the supporting OPA libraries are only available to the Go runtime. I normally write TypeScript, but this was my second try at Go and I think I did okay, thanks to countless examples and tutorials across the Internet. In fact, it's fair to say that <a href="https://github.com/elthrasher/rego.fyi/blob/main/fns/go/authorizer.go">imitation</a> is a sincere form of <a href="https://github.com/zotoio/sls-lambda-opa/blob/master/opacheck/main.go">flattery</a>.</p>

<p>This was also the first time I've used Go with Lambda and I must say, this might be addicting.</p>

<p><figure><a href="https://res.cloudinary.com/practicaldev/image/fetch/s--KJ3s6GaP--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/5b0310hx5k2pylykx5f4.png" class="article-body-image-wrapper"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--KJ3s6GaP--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/5b0310hx5k2pylykx5f4.png" alt="Lambda Console" loading="lazy"></a><figcaption>Millisecond billing, yeah!</figcaption></figure></p>

<p>I'm doing around 50ms with cold starts and single-digits otherwise, even though I'm doing all of those things (unpacking, compiling, deciding, generating) on every request. If the policy is compiled at start time, it's even faster.</p>

<h2>
  <a name="web-app" href="#web-app">
  </a>
  Web App<a name="webapp"></a>
</h2>

<p>My poor design skills notwithstanding, I'm reasonably good at programming in React. I built off a <a href="https://dev.to/aws-builders/aws-cdk-one-step-s3-websites-with-esbuild-2e3h">previous effort</a> to do a simple fullstack non-CRA* React app with esbuild. I think it works pretty well.</p>

<p>In order to keep my app from looking like complete trash, I used <a href="https://material-ui.com/">Material-UI</a> from Google for the components and that was pretty easy. I also delved into <a href="https://testing-library.com/docs/react-testing-library/intro/">Testing Library</a> and I find it quite nice and loved that I could write tests without having to render anything shallowly. I used <a href="https://reactjs.org/docs/context.html">React Context</a> for state and I like that a lot better than working with Redux. You can check my code or query about this in the comments as I'm not going to do into great detail here, but as someone who doesn't program in React every day, it's nice checking in and seeing these innovations.</p>

<p>The app is just one page with no routing. When thinking about how to do this app, I actually thought about trying to figure out some kind of client-side JWT or perhaps do a round trip to a backend to get a user token. Ultimately I decided that cryptographic signing is beyond the scope of what I wanted to do in this app, so all it does is stringify the various form fields, base64 encode that string and finally pass the whole thing as an Authentication header. This allows me to have a decoding piece in my authorizer but of course it's in no way secure.</p>

<h2>
  <a name="aws-cdk" href="#aws-cdk">
  </a>
  AWS CDK<a name="awscdk"></a>
</h2>

<p>I love working with CDK. My post on <a href="https://dev.to/aws-builders/aws-cdk-one-step-s3-websites-with-esbuild-2e3h">CDK S3 websites</a> covers most of topics relating to asset bundling, but it's worth remarking on here. My CDK app handles all the asset bundling of my React web app (written in TypeScript), my authorizer function (written in Go) and my function handler (written in TypeScript). Because of the way asset bundling works in CDK, I can safely <code>cdk deploy</code> and only the parts of the application that have changed will deploy. This is great for a fullstack application and makes deployments very fast. I'll dig into this topic a bit more in a future post.</p>

<p>I also was able to get a unified <code>npm test</code> command that runs all the tests for:</p>

<ul>
<li>CDK infrastructure as code written in TypeScript</li>
<li>React web app written in TypeScript</li>
<li>Lambda function handler written in TypeScript</li>
<li>Authorizer function written in Go</li>
<li>Policy written in Rego
</li>
</ul>

<div class="highlight js-code-highlight">
<pre class="highlight shell"><code>% npm t

<span class="o">&gt;</span> cdk-esbuild-s3-website@0.0.1 pretest /Users/mattmorgan/mine/rego.fyi
<span class="o">&gt;</span> npm run lint


<span class="o">&gt;</span> cdk-esbuild-s3-website@0.0.1 lint /Users/mattmorgan/mine/rego.fyi
<span class="o">&gt;</span> eslint <span class="nb">.</span> <span class="nt">--ext</span><span class="o">=</span>.js,.ts


<span class="o">&gt;</span> cdk-esbuild-s3-website@0.0.1 <span class="nb">test</span> /Users/mattmorgan/mine/rego.fyi
<span class="o">&gt;</span> npm run <span class="nb">test</span>:opa <span class="o">&amp;&amp;</span> npm run <span class="nb">test</span>:go <span class="o">&amp;&amp;</span> npm run <span class="nb">test</span>:ts


<span class="o">&gt;</span> cdk-esbuild-s3-website@0.0.1 <span class="nb">test</span>:opa /Users/mattmorgan/mine/rego.fyi
<span class="o">&gt;</span> opa <span class="nb">test</span> ./opa

PASS: 3/3

<span class="o">&gt;</span> cdk-esbuild-s3-website@0.0.1 <span class="nb">test</span>:go /Users/mattmorgan/mine/rego.fyi
<span class="o">&gt;</span> go <span class="nb">test</span> ./...

ok      _/Users/mattmorgan/mine/rego.fyi/fns/go 1.222s

<span class="o">&gt;</span> cdk-esbuild-s3-website@0.0.1 <span class="nb">test</span>:ts /Users/mattmorgan/mine/rego.fyi
<span class="o">&gt;</span> jest <span class="nt">--coverage</span> <span class="nt">--silent</span>

 PASS   node  fns/ts/lambdalith.spec.ts
 PASS   dom  ui/providers/PayloadsProvider.spec.tsx
Bundling asset Default/AuthZFun/Code/Stage...
go version go1.16 darwin/amd64
Bundling asset WebTestStack/DeployWebsite/Asset1/Stage...
Bundling asset ApiTestStack/AuthZFun/Code/Stage...
0.8.56
go version go1.16 darwin/amd64
Bundling asset TestStack/DeployWebsite/Asset1/Stage...
0.8.56

<span class="o">&gt;</span> cdk-esbuild-s3-website@0.0.1 build /Users/mattmorgan/mine/rego.fyi
<span class="o">&gt;</span> npm run clean <span class="o">&amp;&amp;</span> npm run build:website


<span class="o">&gt;</span> cdk-esbuild-s3-website@0.0.1 build /Users/mattmorgan/mine/rego.fyi
<span class="o">&gt;</span> npm run clean <span class="o">&amp;&amp;</span> npm run build:website

 PASS   dom  ui/components/Header.spec.tsx
Bundling asset Default/LambdalithFn/Code/Stage...
 PASS   dom  ui/components/TextArea.spec.tsx

<span class="o">&gt;</span> cdk-esbuild-s3-website@0.0.1 clean /Users/mattmorgan/mine/rego.fyi
<span class="o">&gt;</span> rimraf cdk.out coverage website/js


<span class="o">&gt;</span> cdk-esbuild-s3-website@0.0.1 clean /Users/mattmorgan/mine/rego.fyi
<span class="o">&gt;</span> rimraf cdk.out coverage website/js

Bundling asset ApiTestStack/LambdalithFn/Code/Stage...
 PASS   node  cdk/lambda.spec.ts
 PASS   dom  ui/components/RequestControl.spec.tsx

<span class="o">&gt;</span> cdk-esbuild-s3-website@0.0.1 build:website /Users/mattmorgan/mine/rego.fyi
<span class="o">&gt;</span> <span class="nv">NODE_ENV</span><span class="o">=</span>production ts-node <span class="nt">--files</span> esbuild.ts build

 PASS   dom  ui/App.spec.tsx

<span class="o">&gt;</span> cdk-esbuild-s3-website@0.0.1 build:website /Users/mattmorgan/mine/rego.fyi
<span class="o">&gt;</span> <span class="nv">NODE_ENV</span><span class="o">=</span>production ts-node <span class="nt">--files</span> esbuild.ts build

 PASS   node  cdk/restApi.spec.ts
Running build...
Running build...
Bundling asset TestStack/AuthZFun/Code/Stage...
 PASS   node  cdk/website.spec.ts <span class="o">(</span>7.308 s<span class="o">)</span>
go version go1.16 darwin/amd64
Bundling asset TestStack/LambdalithFn/Code/Stage...
 PASS   node  cdk/rego.fyi-stack.spec.ts <span class="o">(</span>8.261 s<span class="o">)</span>
<span class="nt">-----------------------</span>|---------|----------|---------|---------|-------------------
File                   | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line <span class="c">#s</span>
<span class="nt">-----------------------</span>|---------|----------|---------|---------|-------------------
All files              |     100 |      100 |     100 |     100 |
 cdk                   |     100 |      100 |     100 |     100 |
  getCFAndZone.ts      |     100 |      100 |     100 |     100 |
  lambda.ts            |     100 |      100 |     100 |     100 |
  rego.fyi-stack.ts    |     100 |      100 |     100 |     100 |
  restApi.ts           |     100 |      100 |     100 |     100 |
  website.ts           |     100 |      100 |     100 |     100 |
 fns/ts                |     100 |      100 |     100 |     100 |
  lambdalith.ts        |     100 |      100 |     100 |     100 |
 opa                   |     100 |      100 |     100 |     100 |
  policy.rego          |     100 |      100 |     100 |     100 |
 ui                    |     100 |      100 |     100 |     100 |
  App.tsx              |     100 |      100 |     100 |     100 |
 ui/components         |     100 |      100 |     100 |     100 |
  Header.tsx           |     100 |      100 |     100 |     100 |
  RequestControl.tsx   |     100 |      100 |     100 |     100 |
  Sidebar.tsx          |     100 |      100 |     100 |     100 |
  TextArea.tsx         |     100 |      100 |     100 |     100 |
 ui/pages              |     100 |      100 |     100 |     100 |
  Rego.tsx             |     100 |      100 |     100 |     100 |
 ui/providers          |     100 |      100 |     100 |     100 |
  PayloadsProvider.tsx |     100 |      100 |     100 |     100 |
<span class="nt">----------------------------</span>|---------|----------|---------|---------|-------------------

Test Suites: 10 passed, 10 total
Tests:       27 passed, 27 total
Snapshots:   6 passed, 6 total
Time:        8.804 s, estimated 9 s
</code></pre>
<div class="highlight__panel js-actions-panel">
<div class="highlight__panel-action js-fullscreen-code-action">
    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title>
    <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
</svg>

    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title>
    <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
</svg>

</div>
</div>
</div>



<p>Thanks to <a href="https://github.com/elthrasher/rego.fyi/blob/main/jest.config.js#L28">jest projects</a>, I'm able to run my <code>.tsx</code> tests with the <code>jsdom</code> test environment and the <code>.ts</code> tests with <code>node</code>. Fullstack testing!</p>

<h2>
  <a name="conclusion" href="#conclusion">
  </a>
  Conclusion<a name="conclusion"></a>
</h2>

<p>My success at getting this working as a RequestAuthorizer makes a very compelling case for introducing OPA into serverless projects. We can join the delegation of complex authorization rules with <a href="https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-method-request-validation.html">API Gateway request validation</a> and find ourselves in a world where our function handlers are very simple - or maybe even <a href="https://dev.to/elthrasher/aws-cdk-api-gateway-service-integration-with-dynamodb-2ek0">skip them entirely</a>.</p>

<p><a href="https://publicdomainreview.org/collection/theatrum-chemicum">COVER IMAGE</a></p>

</div></article> <div class="aside-username-wrapper" data-v-3bf13c85><aside class="aside-username-block" data-v-29ea5fa2 data-v-3bf13c85><div class="username-heading loading" data-v-29ea5fa2><div class="vue-content-placeholders vue-content-placeholders-is-animated" data-v-29ea5fa2><div class="vue-content-placeholders-heading" data-v-29ea5fa2><div class="vue-content-placeholders-heading__img"></div> <div class="vue-content-placeholders-heading__content"><div class="vue-content-placeholders-heading__title"></div> <div class="vue-content-placeholders-heading__subtitle"></div></div></div></div></div> <div class="info" data-v-29ea5fa2><div class="vue-content-placeholders vue-content-placeholders-is-animated" data-v-29ea5fa2><div class="vue-content-placeholders-text" data-v-29ea5fa2><div class="vue-content-placeholders-text__line"></div><div class="vue-content-placeholders-text__line"></div><div class="vue-content-placeholders-text__line"></div></div></div></div></aside></div></div> <div class="comments-block" data-v-54aa1ab4 data-v-3bf13c85><!----> <a href="https://dev.to/elthrasher/rego-fyi-a-study-in-serverless-authorization-with-open-policy-agent-1ipi" target="_blank" rel="nofollow noopener noreferer" class="add-comment" data-v-54aa1ab4>
    Add comment
  </a></div></div> <footer class="w-full py-8"><div class="max-w-screen-xl mx-auto px-4"><ul class="
        max-w-screen-md
        mx-auto
        text-lg
        font-light
        md:flex flex-wrap
        md:justify-between

      "><li class="my-2"><a href="#" class="
            text-gray-400
            hover:text-gray-800
            dark:text-gray-300 dark:hover:text-white
            transition-colors
            duration-200
          ">
          FAQ
        </a></li> <li class="my-2"><a href="#" class="
            text-gray-400
            hover:text-gray-800
            dark:text-gray-300 dark:hover:text-white
            transition-colors
            duration-200
          ">
          Configuration
        </a></li> <li class="my-2"><a href="#" class="
            text-gray-400
            hover:text-gray-800
            dark:text-gray-300 dark:hover:text-white
            transition-colors
            duration-200
          ">
          Github
        </a></li> <li class="my-2"><a href="#" class="
            text-gray-400
            hover:text-gray-800
            dark:text-gray-300 dark:hover:text-white
            transition-colors
            duration-200
          ">
          LinkedIn
        </a></li></ul> <div class="pt-8 flex max-w-xs mx-auto items-center justify-between"><a href="#" class="
          text-gray-400
          hover:text-gray-800
          dark:hover:text-white
          transition-colors
          duration-200
        "><svg width="20" height="20" fill="currentColor" viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg" class="
            text-xl
            hover:text-gray-800
            dark:hover:text-white
            transition-colors
            duration-200
          "><path d="M1343 12v264h-157q-86 0-116 36t-30 108v189h293l-39 296h-254v759h-306v-759h-255v-296h255v-218q0-186 104-288.5t277-102.5q147 0 228 12z"></path></svg></a> <a href="#" class="
          text-gray-400
          hover:text-gray-800
          dark:hover:text-white
          transition-colors
          duration-200
        "><svg width="20" height="20" fill="currentColor" viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg" class="
            text-xl
            hover:text-gray-800
            dark:hover:text-white
            transition-colors
            duration-200
          "><path d="M1684 408q-67 98-162 167 1 14 1 42 0 130-38 259.5t-115.5 248.5-184.5 210.5-258 146-323 54.5q-271 0-496-145 35 4 78 4 225 0 401-138-105-2-188-64.5t-114-159.5q33 5 61 5 43 0 85-11-112-23-185.5-111.5t-73.5-205.5v-4q68 38 146 41-66-44-105-115t-39-154q0-88 44-163 121 149 294.5 238.5t371.5 99.5q-8-38-8-74 0-134 94.5-228.5t228.5-94.5q140 0 236 102 109-21 205-78-37 115-142 178 93-10 186-50z"></path></svg></a> <a href="#" class="
          text-gray-400
          hover:text-gray-800
          dark:hover:text-white
          transition-colors
          duration-200
        "><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 1792 1792" class="
            text-xl
            hover:text-gray-800
            dark:hover:text-white
            transition-colors
            duration-200
          "><path d="M896 128q209 0 385.5 103t279.5 279.5 103 385.5q0 251-146.5 451.5t-378.5 277.5q-27 5-40-7t-13-30q0-3 .5-76.5t.5-134.5q0-97-52-142 57-6 102.5-18t94-39 81-66.5 53-105 20.5-150.5q0-119-79-206 37-91-8-204-28-9-81 11t-92 44l-38 24q-93-26-192-26t-192 26q-16-11-42.5-27t-83.5-38.5-85-13.5q-45 113-8 204-79 87-79 206 0 85 20.5 150t52.5 105 80.5 67 94 39 102.5 18q-39 36-49 103-21 10-45 15t-57 5-65.5-21.5-55.5-62.5q-19-32-48.5-52t-49.5-24l-20-3q-21 0-29 4.5t-5 11.5 9 14 13 12l7 5q22 10 43.5 38t31.5 51l10 23q13 38 44 61.5t67 30 69.5 7 55.5-3.5l23-4q0 38 .5 88.5t.5 54.5q0 18-13 30t-40 7q-232-77-378.5-277.5t-146.5-451.5q0-209 103-385.5t279.5-279.5 385.5-103zm-477 1103q3-7-7-12-10-3-13 2-3 7 7 12 9 6 13-2zm31 34q7-5-2-16-10-9-16-3-7 5 2 16 10 10 16 3zm30 45q9-7 0-19-8-13-17-6-9 5 0 18t17 7zm42 42q8-8-4-19-12-12-20-3-9 8 4 19 12 12 20 3zm57 25q3-11-13-16-15-4-19 7t13 15q15 6 19-6zm63 5q0-13-17-11-16 0-16 11 0 13 17 11 16 0 16-11zm58-10q-2-11-18-9-16 3-14 15t18 8 14-14z"></path></svg></a> <a href="#" class="
          text-gray-400
          hover:text-gray-800
          dark:hover:text-white
          transition-colors
          duration-200
        "><svg width="20" height="20" fill="currentColor" viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg" class="
            text-xl
            hover:text-gray-800
            dark:hover:text-white
            transition-colors
            duration-200
          "><path d="M477 625v991h-330v-991h330zm21-306q1 73-50.5 122t-135.5 49h-2q-82 0-132-49t-50-122q0-74 51.5-122.5t134.5-48.5 133 48.5 51 122.5zm1166 729v568h-329v-530q0-105-40.5-164.5t-126.5-59.5q-63 0-105.5 34.5t-63.5 85.5q-11 30-11 81v553h-329q2-399 2-647t-1-296l-1-48h329v144h-2q20-32 41-56t56.5-52 87-43.5 114.5-15.5q171 0 275 113.5t104 332.5z"></path></svg></a> <a href="#" class="
          text-gray-400
          hover:text-gray-800
          dark:hover:text-white
          transition-colors
          duration-200
        "><svg width="20" height="20" fill="currentColor" viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg" class="
            text-xl
            hover:text-gray-800
            dark:hover:text-white
            transition-colors
            duration-200
          "><path d="M1551 1476q15-6 26-3t11 17.5-15 33.5q-13 16-44 43.5t-95.5 68-141 74-188 58-229.5 24.5q-119 0-238-31t-209-76.5-172.5-104-132.5-105-84-87.5q-8-9-10-16.5t1-12 8-7 11.5-2 11.5 4.5q192 117 300 166 389 176 799 90 190-40 391-135zm207-115q11 16 2.5 69.5t-28.5 102.5q-34 83-85 124-17 14-26 9t0-24q21-45 44.5-121.5t6.5-98.5q-5-7-15.5-11.5t-27-6-29.5-2.5-35 0-31.5 2-31 3-22.5 2q-6 1-13 1.5t-11 1-8.5 1-7 .5h-10l-3-.5-2-1.5-1.5-3q-6-16 47-40t103-30q46-7 108-1t76 24zm-394-443q0 31 13.5 64t32 58 37.5 46 33 32l13 11-227 224q-40-37-79-75.5t-58-58.5l-19-20q-11-11-25-33-38 59-97.5 102.5t-127.5 63.5-140 23-137.5-21-117.5-65.5-83-113-31-162.5q0-84 28-154t72-116.5 106.5-83 122.5-57 130-34.5 119.5-18.5 99.5-6.5v-127q0-65-21-97-34-53-121-53-6 0-16.5 1t-40.5 12-56 29.5-56 59.5-48 96l-294-27q0-60 22-119t67-113 108-95 151.5-65.5 190.5-24.5q100 0 181 25t129.5 61.5 81 83 45 86 12.5 73.5v589zm-672 21q0 86 70 133 66 44 139 22 84-25 114-123 14-45 14-101v-162q-59 2-111 12t-106.5 33.5-87 71-32.5 114.5z"></path></svg></a></div> <div class="
        text-center
        pt-10
        sm:pt-12
        font-light
        flex
        items-center
        justify-center
      "><form class="
          flex flex-col
          md:flex-row
          w-3/4
          md:w-full
          max-w-sm
          md:space-x-3
          space-y-3
          md:space-y-0
          justify-center
        "><div class="relative"><input type="text" id=""form-subscribe-Subscribe" placeholder="Email" class="
              rounded-lg
              border-transparent
              flex-1
              appearance-none
              border border-gray-300
              w-full
              py-2
              px-4
              bg-white
              text-gray-700
              placeholder-gray-400
              shadow-sm
              text-base
              focus:outline-none
              focus:ring-2
              focus:ring-gray-400
              focus:border-transparent
            "></div> <button type="submit" class="
            flex-shrink-0
            px-4
            py-2
            text-black
            font-semibold
            bg-white
            rounded-lg
            shadow-md
            hover:bg-gray-800 hover:text-white
            focus:outline-none
            focus:ring-2
            focus:ring-white
            focus:ring-offset-2
            focus:ring-offset-white
          ">
          Subscribe
        </button></form></div> <div class="
        text-center text-gray-500
        dark:text-gray-200
        pt-10
        sm:pt-12
        font-light
        flex
        items-center
        justify-center
      ">
      Created by Samar
    </div></div></footer></div></div></div><script defer src="/_nuxt/static/1634322943/articles/elthrasher/628138/state.js"></script><script src="/_nuxt/548109a.js" defer></script><script src="/_nuxt/c3ddcce.js" defer></script><script src="/_nuxt/84567ea.js" defer></script><script src="/_nuxt/ad2e88f.js" defer></script><script src="/_nuxt/a9b0fbe.js" defer></script>
  </body>
</html>
