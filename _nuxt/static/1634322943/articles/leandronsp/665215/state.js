window.__NUXT__=(function(a,b,c,d,e){return {staticAssetsBase:"\u002F_nuxt\u002Fstatic\u002F1634322943",layout:"default",error:a,state:{currentArticle:{type_of:"article",id:665215,title:"Deploy to Kubernetes using Github Actions (including Slack notification)",description:"Deploy to Kubernetes using Github Actions",readable_publish_date:"Apr 14",slug:"deploy-to-kubernetes-using-github-actions-including-slack-notification-11je",path:"\u002Fleandronsp\u002Fdeploy-to-kubernetes-using-github-actions-including-slack-notification-11je",url:c,comments_count:6,public_reactions_count:d,collection_id:a,published_timestamp:e,positive_reactions_count:d,cover_image:"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--y_s7PRBD--\u002Fc_imagga_scale,f_auto,fl_progressive,h_420,q_auto,w_1000\u002Fhttps:\u002F\u002Fdev-to-uploads.s3.amazonaws.com\u002Fuploads\u002Farticles\u002Famdtmuxrrcu6gtwjbsag.png",social_image:"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--5a9Fao5D--\u002Fc_imagga_scale,f_auto,fl_progressive,h_500,q_auto,w_1000\u002Fhttps:\u002F\u002Fdev-to-uploads.s3.amazonaws.com\u002Fuploads\u002Farticles\u002Famdtmuxrrcu6gtwjbsag.png",canonical_url:c,created_at:"2021-04-13T22:32:41Z",edited_at:a,crossposted_at:a,published_at:e,last_comment_at:"2021-09-02T13:21:32Z",reading_time_minutes:4,tag_list:"github, aws, eks, kubernetes",tags:["github","aws","eks","kubernetes"],body_html:"\u003Cp\u003EIn this guide we'll cover the full cycle of deploying to Kubernetes using \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Ffeatures\u002Factions\"\u003EGithub Actions\u003C\u002Fa\u003E. Batteries included:\u003C\u002Fp\u003E\n\n\u003Cul\u003E\n\u003Cli\u003EKubernetes cluster running in \u003Ca href=\"https:\u002F\u002Fdocs.aws.amazon.com\u002Feks\u002Flatest\u002Fuserguide\u002Fwhat-is-eks.html\"\u003EAWS EKS\u003C\u002Fa\u003E\n\u003C\u002Fli\u003E\n\u003Cli\u003EDocker images stored in \u003Ca href=\"https:\u002F\u002Faws.amazon.com\u002Fecr\u002F\"\u003EAWS ECR\u003C\u002Fa\u003E\n\u003C\u002Fli\u003E\n\u003Cli\u003E\n\u003Cstrong\u003EBonus:\u003C\u002Fstrong\u003E notification to \u003Cem\u003ESlack\u003C\u002Fem\u003E\n\u003C\u002Fli\u003E\n\u003C\u002Ful\u003E\n\n\u003Cp\u003EThe Github workflow will be triggered at \u003Cem\u003Eevery commit on pull request\u003C\u002Fem\u003E, and its steps are described as follows:\u003C\u002Fp\u003E\n\n\u003Cul\u003E\n\u003Cli\u003Egit checkout\u003C\u002Fli\u003E\n\u003Cli\u003Elogin to AWS ECR (credentials needed)\u003C\u002Fli\u003E\n\u003Cli\u003Ebuild Docker image\u003C\u002Fli\u003E\n\u003Cli\u003Epush Docker image to ECR\u003C\u002Fli\u003E\n\u003Cli\u003Edeploy to EKS using \u003Ccode\u003Ekubectl\u003C\u002Fcode\u003E\n\u003C\u002Fli\u003E\n\u003Cli\u003Esend notification to Slack (needs webhook URL)\u003C\u002Fli\u003E\n\u003C\u002Ful\u003E\n\n\u003Ch2\u003E\n  \u003Ca name=\"github-action\" href=\"#github-action\"\u003E\n  \u003C\u002Fa\u003E\n  Github Action\n\u003C\u002Fh2\u003E\n\n\u003Cp\u003ELet's place our file under \u003Ccode\u003E.github\u002Fworkflows\u002Frelease.yml\u003C\u002Fcode\u003E. Then, we start by configuring the workflow trigger:\u003Cbr\u003E\n\u003C\u002Fp\u003E\n\n\u003Cdiv class=\"highlight js-code-highlight\"\u003E\n\u003Cpre class=\"highlight yaml\"\u003E\u003Ccode\u003E\u003Cspan class=\"na\"\u003Ename\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003ERelease\u003C\u002Fspan\u003E\n\n\u003Cspan class=\"na\"\u003Eon\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E\n  \u003Cspan class=\"na\"\u003Epull_request\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E\n    \u003Cspan class=\"na\"\u003Ebranches\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"pi\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\"nv\"\u003Emain\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E]\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cdiv class=\"highlight__panel js-actions-panel\"\u003E\n\u003Cdiv class=\"highlight__panel-action js-fullscreen-code-action\"\u003E\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"\u003E\u003Ctitle\u003EEnter fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"\u003E\u003Ctitle\u003EExit fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\n\n\n\u003Cp\u003ESuch trigger will run right after we open and at every commit on the pull request.\u003C\u002Fp\u003E\n\n\u003Cp\u003ENext, we define the env variables that will be used across steps:\u003Cbr\u003E\n\u003C\u002Fp\u003E\n\n\u003Cdiv class=\"highlight js-code-highlight\"\u003E\n\u003Cpre class=\"highlight yaml\"\u003E\u003Ccode\u003E\u003Cspan class=\"na\"\u003Eenv\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E\n  \u003Cspan class=\"na\"\u003ERELEASE_REVISION\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s2\"\u003E\"\u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003Epr-${{\u003C\u002Fspan\u003E\u003Cspan class=\"nv\"\u003E \u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003Egithub.event.pull_request.number\u003C\u002Fspan\u003E\u003Cspan class=\"nv\"\u003E \u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003E}}-${{\u003C\u002Fspan\u003E\u003Cspan class=\"nv\"\u003E \u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003Egithub.event.pull_request.head.sha\u003C\u002Fspan\u003E\u003Cspan class=\"nv\"\u003E \u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003E}}\"\u003C\u002Fspan\u003E\n  \u003Cspan class=\"na\"\u003EAWS_ACCESS_KEY_ID\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003E${{ secrets.AWS_ACCESS_KEY_ID }}\u003C\u002Fspan\u003E\n  \u003Cspan class=\"na\"\u003EAWS_SECRET_ACCESS_KEY\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003E${{ secrets.AWS_SECRET_ACCESS_KEY }}\u003C\u002Fspan\u003E\n  \u003Cspan class=\"na\"\u003EAWS_REGION\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003E${{ secrets.AWS_REGION }}\u003C\u002Fspan\u003E\n  \u003Cspan class=\"na\"\u003EKUBE_CONFIG_DATA\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003E${{ secrets.KUBE_CONFIG_DATA }}\u003C\u002Fspan\u003E\n  \u003Cspan class=\"na\"\u003EKUBE_NAMESPACE\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003Eproduction\u003C\u002Fspan\u003E\n  \u003Cspan class=\"na\"\u003EECR_REPOSITORY\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003Emy-cool-application\u003C\u002Fspan\u003E\n  \u003Cspan class=\"na\"\u003ESLACK_WEBHOOK_URL\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003E${{ secrets.SLACK_WEBHOOK_URL }}\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cdiv class=\"highlight__panel js-actions-panel\"\u003E\n\u003Cdiv class=\"highlight__panel-action js-fullscreen-code-action\"\u003E\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"\u003E\u003Ctitle\u003EEnter fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"\u003E\u003Ctitle\u003EExit fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\n\n\n\u003Cp\u003EEnv explained:\u003C\u002Fp\u003E\n\n\u003Cul\u003E\n\u003Cli\u003E\n\u003Ccode\u003ERELEASE_REVISION\u003C\u002Fcode\u003E: the tag that we'll use on the Docker image\u003C\u002Fli\u003E\n\u003Cli\u003E\n\u003Ccode\u003EAWS_ACCESS_KEY_ID | AWS_SECRET_ACCESS_KEY\u003C\u002Fcode\u003E: used in \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Faws-actions\u002Fconfigure-aws-credentials\"\u003Econfigure aws credentials action\u003C\u002Fa\u003E\n\u003C\u002Fli\u003E\n\u003Cli\u003E\n\u003Ccode\u003EKUBE_CONFIG_DATA\u003C\u002Fcode\u003E: used in \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fkodermax\u002Fkubectl-aws-eks\"\u003Ekubectl aws eks action\u003C\u002Fa\u003E\n\u003C\u002Fli\u003E\n\u003Cli\u003E\n\u003Ccode\u003EECR_REPOSITORY\u003C\u002Fcode\u003E: used in \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Faws-actions\u002Famazon-ecr-login\"\u003Eaws ecr action\u003C\u002Fa\u003E\n\u003C\u002Fli\u003E\n\u003Cli\u003E\n\u003Ccode\u003ESLACK_WEBHOOK_URL\u003C\u002Fcode\u003E: used in \u003Ca href=\"https:\u002F\u002Fgithub.com\u002FrtCamp\u002Faction-slack-notify\"\u003Eslack notification action\u003C\u002Fa\u003E\n\u003C\u002Fli\u003E\n\u003C\u002Ful\u003E\n\n\u003Cp\u003ENow, let's start writing the job, after which we'll declare the steps:\u003Cbr\u003E\n\u003C\u002Fp\u003E\n\n\u003Cdiv class=\"highlight js-code-highlight\"\u003E\n\u003Cpre class=\"highlight yaml\"\u003E\u003Ccode\u003E\u003Cspan class=\"na\"\u003Ejobs\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E                                            \n  \u003Cspan class=\"na\"\u003Erelease\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E                                       \n    \u003Cspan class=\"na\"\u003Ename\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003ERelease\u003C\u002Fspan\u003E                                \n    \u003Cspan class=\"na\"\u003Eruns-on\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003Eubuntu-latest\u003C\u002Fspan\u003E                       \n    \u003Cspan class=\"na\"\u003Esteps\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E                                       \n     \u003Cspan class=\"s\"\u003E... [steps be at this level]\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cdiv class=\"highlight__panel js-actions-panel\"\u003E\n\u003Cdiv class=\"highlight__panel-action js-fullscreen-code-action\"\u003E\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"\u003E\u003Ctitle\u003EEnter fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"\u003E\u003Ctitle\u003EExit fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\n\n\n\u003Ch4\u003E\n  \u003Ca name=\"step-cancel-previous-runs\" href=\"#step-cancel-previous-runs\"\u003E\n  \u003C\u002Fa\u003E\n  Step - Cancel Previous Runs\n\u003C\u002Fh4\u003E\n\n\u003Cp\u003EThis step instructs Github to cancel any current run for this job on this very repository.\u003Cbr\u003E\n\u003C\u002Fp\u003E\n\n\u003Cdiv class=\"highlight js-code-highlight\"\u003E\n\u003Cpre class=\"highlight yaml\"\u003E\u003Ccode\u003E\u003Cspan class=\"pi\"\u003E-\u003C\u002Fspan\u003E \u003Cspan class=\"na\"\u003Ename\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003ECancel Previous Runs\u003C\u002Fspan\u003E               \n  \u003Cspan class=\"na\"\u003Euses\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003Estyfle\u002Fcancel-workflow-action@0.4.1\u003C\u002Fspan\u003E\n  \u003Cspan class=\"na\"\u003Ewith\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E                                    \n    \u003Cspan class=\"na\"\u003Eaccess_token\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003E${{ github.token }}\u003C\u002Fspan\u003E      \n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cdiv class=\"highlight__panel js-actions-panel\"\u003E\n\u003Cdiv class=\"highlight__panel-action js-fullscreen-code-action\"\u003E\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"\u003E\u003Ctitle\u003EEnter fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"\u003E\u003Ctitle\u003EExit fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\n\n\n\u003Ch4\u003E\n  \u003Ca name=\"step-checkout\" href=\"#step-checkout\"\u003E\n  \u003C\u002Fa\u003E\n  Step - Checkout\n\u003C\u002Fh4\u003E\n\n\u003Cp\u003EPerforms the git checkout at this specific commit.\u003Cbr\u003E\n\u003C\u002Fp\u003E\n\n\u003Cdiv class=\"highlight js-code-highlight\"\u003E\n\u003Cpre class=\"highlight yaml\"\u003E\u003Ccode\u003E\u003Cspan class=\"pi\"\u003E-\u003C\u002Fspan\u003E \u003Cspan class=\"na\"\u003Ename\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003ECheckout\u003C\u002Fspan\u003E                                  \n  \u003Cspan class=\"na\"\u003Euses\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003Eactions\u002Fcheckout@v2\u003C\u002Fspan\u003E                       \n  \u003Cspan class=\"na\"\u003Ewith\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E                                           \n    \u003Cspan class=\"na\"\u003Eref\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003E${{ github.event.pull_request.head.sha }}\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cdiv class=\"highlight__panel js-actions-panel\"\u003E\n\u003Cdiv class=\"highlight__panel-action js-fullscreen-code-action\"\u003E\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"\u003E\u003Ctitle\u003EEnter fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"\u003E\u003Ctitle\u003EExit fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\n\n\n\u003Ch4\u003E\n  \u003Ca name=\"step-configure-aws-credentials\" href=\"#step-configure-aws-credentials\"\u003E\n  \u003C\u002Fa\u003E\n  Step - Configure AWS credentials\n\u003C\u002Fh4\u003E\n\n\u003Cp\u003EThis steps uses the AWS credentials defined in the \u003Ccode\u003Eenv\u003C\u002Fcode\u003E section.\u003Cbr\u003E\n\u003C\u002Fp\u003E\n\n\u003Cdiv class=\"highlight js-code-highlight\"\u003E\n\u003Cpre class=\"highlight yaml\"\u003E\u003Ccode\u003E\u003Cspan class=\"pi\"\u003E-\u003C\u002Fspan\u003E \u003Cspan class=\"na\"\u003Ename\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003EConfigure AWS credentials\u003C\u002Fspan\u003E                          \n  \u003Cspan class=\"na\"\u003Euses\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003Eaws-actions\u002Fconfigure-aws-credentials@v1\u003C\u002Fspan\u003E           \n  \u003Cspan class=\"na\"\u003Ewith\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E                                                    \n    \u003Cspan class=\"na\"\u003Eaws-access-key-id\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003E${{ env.AWS_ACCESS_KEY_ID }}\u003C\u002Fspan\u003E        \n    \u003Cspan class=\"na\"\u003Eaws-secret-access-key\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003E${{ env.AWS_SECRET_ACCESS_KEY }}\u003C\u002Fspan\u003E\n    \u003Cspan class=\"na\"\u003Eaws-region\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003E${{ env.AWS_REGION }}\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cdiv class=\"highlight__panel js-actions-panel\"\u003E\n\u003Cdiv class=\"highlight__panel-action js-fullscreen-code-action\"\u003E\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"\u003E\u003Ctitle\u003EEnter fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"\u003E\u003Ctitle\u003EExit fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\n\n\n\u003Ch4\u003E\n  \u003Ca name=\"step-login-to-aws-ecr\" href=\"#step-login-to-aws-ecr\"\u003E\n  \u003C\u002Fa\u003E\n  Step - Login to AWS ECR\n\u003C\u002Fh4\u003E\n\n\u003Cp\u003EPerforms the login to AWS ECR, using the AWS credentials configured in the previous step.\u003Cbr\u003E\n\u003C\u002Fp\u003E\n\n\u003Cdiv class=\"highlight js-code-highlight\"\u003E\n\u003Cpre class=\"highlight yaml\"\u003E\u003Ccode\u003E\u003Cspan class=\"pi\"\u003E-\u003C\u002Fspan\u003E \u003Cspan class=\"na\"\u003Ename\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003ELogin to Amazon ECR\u003C\u002Fspan\u003E            \n  \u003Cspan class=\"na\"\u003Eid\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003Elogin-ecr\u003C\u002Fspan\u003E                        \n  \u003Cspan class=\"na\"\u003Euses\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003Eaws-actions\u002Famazon-ecr-login@v1\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cdiv class=\"highlight__panel js-actions-panel\"\u003E\n\u003Cdiv class=\"highlight__panel-action js-fullscreen-code-action\"\u003E\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"\u003E\u003Ctitle\u003EEnter fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"\u003E\u003Ctitle\u003EExit fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\n\n\n\u003Ch4\u003E\n  \u003Ca name=\"step-setup-docker-buildx-cache\" href=\"#step-setup-docker-buildx-cache\"\u003E\n  \u003C\u002Fa\u003E\n  Step - Setup Docker buildx cache\n\u003C\u002Fh4\u003E\n\n\u003Cp\u003EThese two steps are very important for the performance of building image. A few key notes:\u003C\u002Fp\u003E\n\n\u003Cul\u003E\n\u003Cli\u003EGithub Actions, like every CI runner in the cloud, is \u003Cem\u003Eephemeral\u003C\u002Fem\u003E, which means a new instance is virtualized every time we perform a new workflow job\u003C\u002Fli\u003E\n\u003Cli\u003EDue to this ephemerality, we cannot rely on the native Docker layer caching\u003C\u002Fli\u003E\n\u003C\u002Ful\u003E\n\n\u003Cp\u003EThe above constraints would make our build time very slow, since every layer in \u003Cstrong\u003EDockerfile\u003C\u002Fstrong\u003E will be evaluated across builds.\u003C\u002Fp\u003E\n\n\u003Cp\u003EBut thanks to this \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fdocker\u002Fsetup-buildx-action\"\u003Eaction\u003C\u002Fa\u003E, we can make use of the \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fmoby\u002Fbuildkit\"\u003Ebuildkit CLI\u003C\u002Fa\u003E to cache Docker layers. Then, in combination with \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Factions\u002Fcache\"\u003Enative Github actions cache\u003C\u002Fa\u003E, we can rely on this cache strategy, thus optimizing build time.\u003Cbr\u003E\n\u003C\u002Fp\u003E\n\n\u003Cdiv class=\"highlight js-code-highlight\"\u003E\n\u003Cpre class=\"highlight yaml\"\u003E\u003Ccode\u003E\u003Cspan class=\"pi\"\u003E-\u003C\u002Fspan\u003E \u003Cspan class=\"na\"\u003Ename\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003ESet up Docker Buildx\u003C\u002Fspan\u003E                             \n  \u003Cspan class=\"na\"\u003Eid\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003Ebuildx\u003C\u002Fspan\u003E                                             \n  \u003Cspan class=\"na\"\u003Euses\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003Edocker\u002Fsetup-buildx-action@master\u003C\u002Fspan\u003E                \n\u003Cspan class=\"pi\"\u003E-\u003C\u002Fspan\u003E \u003Cspan class=\"na\"\u003Ename\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003EDocker cache layers\u003C\u002Fspan\u003E                              \n  \u003Cspan class=\"na\"\u003Euses\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003Eactions\u002Fcache@v2\u003C\u002Fspan\u003E                                 \n  \u003Cspan class=\"na\"\u003Ewith\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E                                                  \n    \u003Cspan class=\"na\"\u003Epath\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003E\u002Ftmp\u002F.buildx-cache\u003C\u002Fspan\u003E                             \n    \u003Cspan class=\"na\"\u003Ekey\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003E${{ runner.os }}-single-buildx-${{ github.sha }}\u003C\u002Fspan\u003E\n    \u003Cspan class=\"na\"\u003Erestore-keys\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"pi\"\u003E|\u003C\u002Fspan\u003E                                      \n      \u003Cspan class=\"s\"\u003E${{ runner.os }}-single-buildx                     \u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cdiv class=\"highlight__panel js-actions-panel\"\u003E\n\u003Cdiv class=\"highlight__panel-action js-fullscreen-code-action\"\u003E\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"\u003E\u003Ctitle\u003EEnter fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"\u003E\u003Ctitle\u003EExit fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\n\n\n\u003Ch4\u003E\n  \u003Ca name=\"step-build-amp-push-the-image-to-the-registry\" href=\"#step-build-amp-push-the-image-to-the-registry\"\u003E\n  \u003C\u002Fa\u003E\n  Step - Build &amp; Push the image to the registry\n\u003C\u002Fh4\u003E\n\n\u003Cp\u003EThis step covers building the Docker image with \u003Ccode\u003Ebuildx\u003C\u002Fcode\u003E to optimize build time, and pushing it to AWS ECR, which was previously configured in \"Login to Amazon ECR\". \u003C\u002Fp\u003E\n\n\u003Cp\u003EThe example assumes we have a target named \"release\" in the Dockerfile.\u003Cbr\u003E\n\u003C\u002Fp\u003E\n\n\u003Cdiv class=\"highlight js-code-highlight\"\u003E\n\u003Cpre class=\"highlight yaml\"\u003E\u003Ccode\u003E\u003Cspan class=\"pi\"\u003E-\u003C\u002Fspan\u003E \u003Cspan class=\"na\"\u003Ename\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003EBuild &amp; Push Image\u003C\u002Fspan\u003E                                                                                      \n  \u003Cspan class=\"na\"\u003Eenv\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E                                                                                                          \n    \u003Cspan class=\"na\"\u003EECR_REGISTRY\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003E${{ steps.login-ecr.outputs.registry }}\u003C\u002Fspan\u003E                                                       \n    \u003Cspan class=\"na\"\u003ERELEASE_IMAGE\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003E${{ steps.login-ecr.outputs.registry }}\u002F${{ env.ECR_REPOSITORY }}:${{ env.RELEASE_REVISION }}\u003C\u002Fspan\u003E\n  \u003Cspan class=\"na\"\u003Erun\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"pi\"\u003E|\u003C\u002Fspan\u003E\n    \u003Cspan class=\"s\"\u003Edocker buildx create --use\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\"s\"\u003Edocker buildx build \\                                \u003C\u002Fspan\u003E\n      \u003Cspan class=\"s\"\u003E--cache-from=type=local,src=\u002Ftmp\u002F.buildx-cache \\   \u003C\u002Fspan\u003E\n      \u003Cspan class=\"s\"\u003E--cache-to=type=local,dest=\u002Ftmp\u002F.buildx-cache-new \\\u003C\u002Fspan\u003E\n      \u003Cspan class=\"s\"\u003E--tag ${{ env.RELEASE_IMAGE }} \\                           \u003C\u002Fspan\u003E\n      \u003Cspan class=\"s\"\u003E--target release \\                                 \u003C\u002Fspan\u003E\n      \u003Cspan class=\"s\"\u003E--push \\                                           \u003C\u002Fspan\u003E\n      \u003Cspan class=\"s\"\u003E.                                                  \u003C\u002Fspan\u003E\n\n    \u003Cspan class=\"s\"\u003Erm -rf \u002Ftmp\u002F.buildx-cache\u003C\u002Fspan\u003E\n    \u003Cspan class=\"s\"\u003Emv \u002Ftmp\u002F.buildx-cache-new \u002Ftmp\u002F.buildx-cache\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cdiv class=\"highlight__panel js-actions-panel\"\u003E\n\u003Cdiv class=\"highlight__panel-action js-fullscreen-code-action\"\u003E\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"\u003E\u003Ctitle\u003EEnter fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"\u003E\u003Ctitle\u003EExit fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\n\n\n\u003Cp\u003EStep explained:\u003C\u002Fp\u003E\n\n\u003Cul\u003E\n\u003Cli\u003E\n\u003Ccode\u003Edocker buildx create --use\u003C\u002Fcode\u003E: creates a new build context for buildx and sets it as the current context\u003C\u002Fli\u003E\n\u003Cli\u003E\n\u003Ccode\u003Edocker buildx build ...\u003C\u002Fcode\u003E: builds the image using the cache configured\u002Frestored in the previous steps \"Docker cache layers\". After build, it uploads the image to the pre-configured registry using the \u003Ccode\u003E--push\u003C\u002Fcode\u003E option\u003C\u002Fli\u003E\n\u003Cli\u003E\n\u003Ccode\u003Erm | mv ...\u003C\u002Fcode\u003E: we have to renew the cache at every run, otherwise we may reach the 5GB limit of storage on Githb Actions\u003C\u002Fli\u003E\n\u003C\u002Ful\u003E\n\n\u003Ch4\u003E\n  \u003Ca name=\"step-deploy-to-kubernetes-cluster\" href=\"#step-deploy-to-kubernetes-cluster\"\u003E\n  \u003C\u002Fa\u003E\n  Step - Deploy to Kubernetes cluster\n\u003C\u002Fh4\u003E\n\n\u003Cp\u003EOnce we have the image uploaded to the registry, we can send a command to kubernetes to perform the deploy.\u003Cbr\u003E\n\u003C\u002Fp\u003E\n\n\u003Cdiv class=\"highlight js-code-highlight\"\u003E\n\u003Cpre class=\"highlight yaml\"\u003E\u003Ccode\u003E\u003Cspan class=\"pi\"\u003E-\u003C\u002Fspan\u003E \u003Cspan class=\"na\"\u003Ename\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003EDeploy to Kubernetes cluster\u003C\u002Fspan\u003E                                                                            \n  \u003Cspan class=\"na\"\u003Euses\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003Ekodermax\u002Fkubectl-aws-eks@master\u003C\u002Fspan\u003E                                                                         \n  \u003Cspan class=\"na\"\u003Eenv\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E                                                                                                          \n    \u003Cspan class=\"na\"\u003ERELEASE_IMAGE\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003E${{ steps.login-ecr.outputs.registry }}\u002F${{ env.ECR_REPOSITORY }}:${{ env.RELEASE_REVISION }}\u003C\u002Fspan\u003E\n  \u003Cspan class=\"na\"\u003Ewith\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E                                                                                                         \n    \u003Cspan class=\"na\"\u003Eargs\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003Eset image deployment\u002Fmy-pod app=${{ env.RELEASE_IMAGE }} --record -n $KUBE_NAMESPACE\u003C\u002Fspan\u003E   \n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cdiv class=\"highlight__panel js-actions-panel\"\u003E\n\u003Cdiv class=\"highlight__panel-action js-fullscreen-code-action\"\u003E\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"\u003E\u003Ctitle\u003EEnter fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"\u003E\u003Ctitle\u003EExit fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\n\n\n\u003Cp\u003EHere we are using \u003Ccode\u003Ekubectl set image\u003C\u002Fcode\u003E but it could be \u003Ccode\u003Ekubectl rollout\u003C\u002Fcode\u003E or any other command, as needed.\u003C\u002Fp\u003E\n\n\u003Cp\u003EAdditionally, we can include a step to check the deployment:\u003Cbr\u003E\n\u003C\u002Fp\u003E\n\n\u003Cdiv class=\"highlight js-code-highlight\"\u003E\n\u003Cpre class=\"highlight yaml\"\u003E\u003Ccode\u003E\u003Cspan class=\"pi\"\u003E-\u003C\u002Fspan\u003E \u003Cspan class=\"na\"\u003Ename\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003EVerify Kubernetes deployment\u003C\u002Fspan\u003E                               \n  \u003Cspan class=\"na\"\u003Euses\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003Ekodermax\u002Fkubectl-aws-eks@master\u003C\u002Fspan\u003E                            \n  \u003Cspan class=\"na\"\u003Ewith\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E                                                            \n    \u003Cspan class=\"na\"\u003Eargs\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003Erollout status deploy my-pod -n $KUBE_NAMESPACE\u003C\u002Fspan\u003E \n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cdiv class=\"highlight__panel js-actions-panel\"\u003E\n\u003Cdiv class=\"highlight__panel-action js-fullscreen-code-action\"\u003E\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"\u003E\u003Ctitle\u003EEnter fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"\u003E\u003Ctitle\u003EExit fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\n\n\n\u003Ch4\u003E\n  \u003Ca name=\"step-slack-notification\" href=\"#step-slack-notification\"\u003E\n  \u003C\u002Fa\u003E\n  Step - Slack notification\n\u003C\u002Fh4\u003E\n\n\u003Cp\u003EAfter a succeeded deployment, we can use \u003Ca href=\"https:\u002F\u002Fgithub.com\u002FrtCamp\u002Faction-slack-notify\"\u003Ethis action\u003C\u002Fa\u003E to send a notification to Slack.\u003Cbr\u003E\n\u003C\u002Fp\u003E\n\n\u003Cdiv class=\"highlight js-code-highlight\"\u003E\n\u003Cpre class=\"highlight yaml\"\u003E\u003Ccode\u003E\u003Cspan class=\"pi\"\u003E-\u003C\u002Fspan\u003E \u003Cspan class=\"na\"\u003Ename\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003ESlack notification\u003C\u002Fspan\u003E                                \n  \u003Cspan class=\"na\"\u003Euses\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003ErtCamp\u002Faction-slack-notify@master\u003C\u002Fspan\u003E                 \n  \u003Cspan class=\"na\"\u003Eenv\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E                                                    \n    \u003Cspan class=\"na\"\u003ESLACK_CHANNEL\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003Emy_cool_channel\u003C\u002Fspan\u003E                   \n    \u003Cspan class=\"na\"\u003ESLACK_MESSAGE\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s1\"\u003E'\u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003EJust\u003C\u002Fspan\u003E\u003Cspan class=\"nv\"\u003E \u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003Edeployed\u003C\u002Fspan\u003E\u003Cspan class=\"nv\"\u003E \u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003Eour\u003C\u002Fspan\u003E\u003Cspan class=\"nv\"\u003E \u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003Ecool\u003C\u002Fspan\u003E\u003Cspan class=\"nv\"\u003E \u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003Eapplication!'\u003C\u002Fspan\u003E\n    \u003Cspan class=\"na\"\u003ESLACK_TITLE\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s1\"\u003E'\u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003EDeploy'\u003C\u002Fspan\u003E                         \n    \u003Cspan class=\"na\"\u003ESLACK_USERNAME\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s1\"\u003E'\u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003ESome\u003C\u002Fspan\u003E\u003Cspan class=\"nv\"\u003E \u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003EBot'\u003C\u002Fspan\u003E                           \n    \u003Cspan class=\"na\"\u003ESLACK_ICON\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s2\"\u003E\"\u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003E[icon\u003C\u002Fspan\u003E\u003Cspan class=\"nv\"\u003E \u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003EURL]\"\u003C\u002Fspan\u003E\n    \u003Cspan class=\"na\"\u003ESLACK_COLOR\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s1\"\u003E'\u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003E#228B22'\u003C\u002Fspan\u003E                                \n    \u003Cspan class=\"na\"\u003ESLACK_WEBHOOK\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003E${{ secrets.SLACK_WEBHOOK_URL }}\u003C\u002Fspan\u003E       \n    \u003Cspan class=\"na\"\u003EMSG_MINIMAL\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"no\"\u003Etrue\u003C\u002Fspan\u003E  \n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cdiv class=\"highlight__panel js-actions-panel\"\u003E\n\u003Cdiv class=\"highlight__panel-action js-fullscreen-code-action\"\u003E\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"\u003E\u003Ctitle\u003EEnter fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"\u003E\u003Ctitle\u003EExit fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\n\n\n\u003Ch2\u003E\n  \u003Ca name=\"wrapping-up\" href=\"#wrapping-up\"\u003E\n  \u003C\u002Fa\u003E\n  Wrapping up\n\u003C\u002Fh2\u003E\n\n\u003Cp\u003EIn this guide we configured the full cycle of building a Docker image, uploading it to a registry, performing the deployment to Kubernetes and sending a notification to Slack.\u003C\u002Fp\u003E\n\n\u003Cp\u003EIn the upcoming posts we'll see how to optimize build time of dependencies' installation inside the Docker image (a.k.a \u003Ccode\u003Ebundle install\u003C\u002Fcode\u003E for Ruby developers), using a cache strategy that relies on AWS S3. \u003C\u002Fp\u003E\n\n",body_markdown:"---\ntitle: Deploy to Kubernetes using Github Actions (including Slack notification)\npublished: true\ndescription: Deploy to Kubernetes using Github Actions\ntags: github,aws,eks,kubernetes\ncover_image: https:\u002F\u002Fdev-to-uploads.s3.amazonaws.com\u002Fuploads\u002Farticles\u002Famdtmuxrrcu6gtwjbsag.png\n---\nIn this guide we'll cover the full cycle of deploying to Kubernetes using [Github Actions](https:\u002F\u002Fgithub.com\u002Ffeatures\u002Factions). Batteries included:\n\n- Kubernetes cluster running in [AWS EKS](https:\u002F\u002Fdocs.aws.amazon.com\u002Feks\u002Flatest\u002Fuserguide\u002Fwhat-is-eks.html)\n- Docker images stored in [AWS ECR](https:\u002F\u002Faws.amazon.com\u002Fecr\u002F)\n- **Bonus:** notification to _Slack_\n\nThe Github workflow will be triggered at _every commit on pull request_, and its steps are described as follows:\n\n- git checkout\n- login to AWS ECR (credentials needed)\n- build Docker image\n- push Docker image to ECR\n- deploy to EKS using `kubectl`\n- send notification to Slack (needs webhook URL)\n\n## Github Action\nLet's place our file under `.github\u002Fworkflows\u002Frelease.yml`. Then, we start by configuring the workflow trigger:\n```yaml\nname: Release\n\non:\n  pull_request:\n    branches: [main]\n```\nSuch trigger will run right after we open and at every commit on the pull request.\n\nNext, we define the env variables that will be used across steps:\n```yaml\nenv:\n  RELEASE_REVISION: \"pr-${{ github.event.pull_request.number }}-${{ github.event.pull_request.head.sha }}\"\n  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}\n  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}\n  AWS_REGION: ${{ secrets.AWS_REGION }}\n  KUBE_CONFIG_DATA: ${{ secrets.KUBE_CONFIG_DATA }}\n  KUBE_NAMESPACE: production\n  ECR_REPOSITORY: my-cool-application\n  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}\n```\nEnv explained:\n- `RELEASE_REVISION`: the tag that we'll use on the Docker image\n- `AWS_ACCESS_KEY_ID | AWS_SECRET_ACCESS_KEY`: used in [configure aws credentials action](https:\u002F\u002Fgithub.com\u002Faws-actions\u002Fconfigure-aws-credentials)\n- `KUBE_CONFIG_DATA`: used in [kubectl aws eks action](https:\u002F\u002Fgithub.com\u002Fkodermax\u002Fkubectl-aws-eks)\n- `ECR_REPOSITORY`: used in [aws ecr action](https:\u002F\u002Fgithub.com\u002Faws-actions\u002Famazon-ecr-login)\n- `SLACK_WEBHOOK_URL`: used in [slack notification action](https:\u002F\u002Fgithub.com\u002FrtCamp\u002Faction-slack-notify)\n\nNow, let's start writing the job, after which we'll declare the steps:\n```yaml\njobs:                                            \n  release:                                       \n    name: Release                                \n    runs-on: ubuntu-latest                       \n    steps:                                       \n     ... [steps be at this level]\n```  \n#### Step - Cancel Previous Runs\nThis step instructs Github to cancel any current run for this job on this very repository.   \n```yaml\n- name: Cancel Previous Runs               \n  uses: styfle\u002Fcancel-workflow-action@0.4.1\n  with:                                    \n    access_token: ${{ github.token }}      \n```\n#### Step - Checkout\nPerforms the git checkout at this specific commit.\n```yaml\n- name: Checkout                                  \n  uses: actions\u002Fcheckout@v2                       \n  with:                                           \n    ref: ${{ github.event.pull_request.head.sha }}\n```\n#### Step - Configure AWS credentials\nThis steps uses the AWS credentials defined in the `env` section.\n```yaml\n- name: Configure AWS credentials                          \n  uses: aws-actions\u002Fconfigure-aws-credentials@v1           \n  with:                                                    \n    aws-access-key-id: ${{ env.AWS_ACCESS_KEY_ID }}        \n    aws-secret-access-key: ${{ env.AWS_SECRET_ACCESS_KEY }}\n    aws-region: ${{ env.AWS_REGION }}\n```\n#### Step - Login to AWS ECR\nPerforms the login to AWS ECR, using the AWS credentials configured in the previous step.\n```yaml\n- name: Login to Amazon ECR            \n  id: login-ecr                        \n  uses: aws-actions\u002Famazon-ecr-login@v1\n```\n#### Step - Setup Docker buildx cache\nThese two steps are very important for the performance of building image. A few key notes:\n- Github Actions, like every CI runner in the cloud, is _ephemeral_, which means a new instance is virtualized every time we perform a new workflow job\n- Due to this ephemerality, we cannot rely on the native Docker layer caching\n\nThe above constraints would make our build time very slow, since every layer in **Dockerfile** will be evaluated across builds.\n\nBut thanks to this [action](https:\u002F\u002Fgithub.com\u002Fdocker\u002Fsetup-buildx-action), we can make use of the [buildkit CLI](https:\u002F\u002Fgithub.com\u002Fmoby\u002Fbuildkit) to cache Docker layers. Then, in combination with [native Github actions cache](https:\u002F\u002Fgithub.com\u002Factions\u002Fcache), we can rely on this cache strategy, thus optimizing build time.\n```yaml\n- name: Set up Docker Buildx                             \n  id: buildx                                             \n  uses: docker\u002Fsetup-buildx-action@master                \n- name: Docker cache layers                              \n  uses: actions\u002Fcache@v2                                 \n  with:                                                  \n    path: \u002Ftmp\u002F.buildx-cache                             \n    key: ${{ runner.os }}-single-buildx-${{ github.sha }}\n    restore-keys: |                                      \n      ${{ runner.os }}-single-buildx                     \n```\n#### Step - Build & Push the image to the registry\nThis step covers building the Docker image with `buildx` to optimize build time, and pushing it to AWS ECR, which was previously configured in \"Login to Amazon ECR\". \n\nThe example assumes we have a target named \"release\" in the Dockerfile.\n```yaml\n- name: Build & Push Image                                                                                      \n  env:                                                                                                          \n    ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}                                                       \n    RELEASE_IMAGE: ${{ steps.login-ecr.outputs.registry }}\u002F${{ env.ECR_REPOSITORY }}:${{ env.RELEASE_REVISION }}\n  run: |\n    docker buildx create --use\n\n    docker buildx build \\                                \n      --cache-from=type=local,src=\u002Ftmp\u002F.buildx-cache \\   \n      --cache-to=type=local,dest=\u002Ftmp\u002F.buildx-cache-new \\\n      --tag ${{ env.RELEASE_IMAGE }} \\                           \n      --target release \\                                 \n      --push \\                                           \n      .                                                  \n    \n    rm -rf \u002Ftmp\u002F.buildx-cache\n    mv \u002Ftmp\u002F.buildx-cache-new \u002Ftmp\u002F.buildx-cache\n```\nStep explained:\n\n- `docker buildx create --use`: creates a new build context for buildx and sets it as the current context\n- `docker buildx build ...`: builds the image using the cache configured\u002Frestored in the previous steps \"Docker cache layers\". After build, it uploads the image to the pre-configured registry using the `--push` option\n- `rm | mv ...`: we have to renew the cache at every run, otherwise we may reach the 5GB limit of storage on Githb Actions\n\n#### Step - Deploy to Kubernetes cluster\nOnce we have the image uploaded to the registry, we can send a command to kubernetes to perform the deploy.\n```yaml\n- name: Deploy to Kubernetes cluster                                                                            \n  uses: kodermax\u002Fkubectl-aws-eks@master                                                                         \n  env:                                                                                                          \n    RELEASE_IMAGE: ${{ steps.login-ecr.outputs.registry }}\u002F${{ env.ECR_REPOSITORY }}:${{ env.RELEASE_REVISION }}\n  with:                                                                                                         \n    args: set image deployment\u002Fmy-pod app=${{ env.RELEASE_IMAGE }} --record -n $KUBE_NAMESPACE   \n```\nHere we are using `kubectl set image` but it could be `kubectl rollout` or any other command, as needed.\n\nAdditionally, we can include a step to check the deployment:\n```yaml\n- name: Verify Kubernetes deployment                               \n  uses: kodermax\u002Fkubectl-aws-eks@master                            \n  with:                                                            \n    args: rollout status deploy my-pod -n $KUBE_NAMESPACE \n```\n#### Step - Slack notification\nAfter a succeeded deployment, we can use [this action](https:\u002F\u002Fgithub.com\u002FrtCamp\u002Faction-slack-notify) to send a notification to Slack. \n```yaml\n- name: Slack notification                                \n  uses: rtCamp\u002Faction-slack-notify@master                 \n  env:                                                    \n    SLACK_CHANNEL: my_cool_channel                   \n    SLACK_MESSAGE: 'Just deployed our cool application!'\n    SLACK_TITLE: 'Deploy'                         \n    SLACK_USERNAME: 'Some Bot'                           \n    SLACK_ICON: \"[icon URL]\"\n    SLACK_COLOR: '#228B22'                                \n    SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}       \n    MSG_MINIMAL: true  \n```           \n## Wrapping up\nIn this guide we configured the full cycle of building a Docker image, uploading it to a registry, performing the deployment to Kubernetes and sending a notification to Slack.\n\nIn the upcoming posts we'll see how to optimize build time of dependencies' installation inside the Docker image (a.k.a `bundle install` for Ruby developers), using a cache strategy that relies on AWS S3. ",user:{name:"Leandro Proença",username:b,twitter_username:b,github_username:b,website_url:"https:\u002F\u002Fleandronsp.com",profile_image:"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--2BjrgRmA--\u002Fc_fill,f_auto,fl_progressive,h_640,q_auto,w_640\u002Fhttps:\u002F\u002Fdev-to-uploads.s3.amazonaws.com\u002Fuploads\u002Fuser\u002Fprofile_image\u002F29160\u002Fd11ee609-254e-46e0-afe8-66f31ffc194b.jpeg",profile_image_90:"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs---99OEc2e--\u002Fc_fill,f_auto,fl_progressive,h_90,q_auto,w_90\u002Fhttps:\u002F\u002Fdev-to-uploads.s3.amazonaws.com\u002Fuploads\u002Fuser\u002Fprofile_image\u002F29160\u002Fd11ee609-254e-46e0-afe8-66f31ffc194b.jpeg"}}},serverRendered:true,routePath:"\u002Farticles\u002Fleandronsp\u002F665215",config:{_app:{basePath:"\u002F",assetsPath:"\u002F_nuxt\u002F",cdnURL:a}}}}(null,"leandronsp","https:\u002F\u002Fdev.to\u002Fleandronsp\u002Fdeploy-to-kubernetes-using-github-actions-including-slack-notification-11je",13,"2021-04-14T23:48:05Z"));