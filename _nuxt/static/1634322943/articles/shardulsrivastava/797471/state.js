window.__NUXT__=(function(a,b,c,d,e){return {staticAssetsBase:"\u002F_nuxt\u002Fstatic\u002F1634322943",layout:"default",error:a,state:{currentArticle:{type_of:"article",id:797471,title:"EKS IAM Deep Dive",description:"Amazon EKS cluster consists of Managed NodeGroups, Self Managed NodeGroups and Fargate profiles....",readable_publish_date:"Aug 19",slug:"eks-iam-deep-dive-136d",path:"\u002Faws-builders\u002Feks-iam-deep-dive-136d",url:"https:\u002F\u002Fdev.to\u002Faws-builders\u002Feks-iam-deep-dive-136d",comments_count:0,public_reactions_count:c,collection_id:a,published_timestamp:b,positive_reactions_count:c,cover_image:a,social_image:"https:\u002F\u002Fdev.to\u002Fsocial_previews\u002Farticle\u002F797471.png",canonical_url:"https:\u002F\u002Fshardul.dev\u002Feks-auth-deep-dive\u002F",created_at:b,edited_at:"2021-09-17T21:05:08Z",crossposted_at:a,published_at:b,last_comment_at:b,reading_time_minutes:9,tag_list:"kubernetes, aws, iam, eks",tags:["kubernetes","aws","iam","eks"],body_html:"\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--f6kwThZZ--\u002Fc_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880\u002Fhttps:\u002F\u002Fdev-to-uploads.s3.amazonaws.com\u002Fuploads\u002Farticles\u002Fvai1pgujygh2h9vxoz0g.png\" class=\"article-body-image-wrapper\"\u003E\u003Cimg src=\"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--f6kwThZZ--\u002Fc_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880\u002Fhttps:\u002F\u002Fdev-to-uploads.s3.amazonaws.com\u002Fuploads\u002Farticles\u002Fvai1pgujygh2h9vxoz0g.png\" alt=\"aws-eks-iam\" loading=\"lazy\"\u003E\u003C\u002Fa\u003E\u003C\u002Fp\u003E\n\n\u003Cp\u003EAmazon EKS cluster consists of \u003Ca href=\"https:\u002F\u002Fdocs.aws.amazon.com\u002Feks\u002Flatest\u002Fuserguide\u002Fmanaged-node-groups.html\"\u003EManaged NodeGroups\u003C\u002Fa\u003E, \u003Ca href=\"https:\u002F\u002Fdocs.aws.amazon.com\u002Feks\u002Flatest\u002Fuserguide\u002Fworker.html\"\u003ESelf Managed NodeGroups\u003C\u002Fa\u003E and \u003Ca href=\"https:\u002F\u002Fdocs.aws.amazon.com\u002Feks\u002Flatest\u002Fuserguide\u002Ffargate-profile.html\"\u003EFargate profiles\u003C\u002Fa\u003E. NodeGroups are autoscaling groups behind the scene, while Fargate is serverless and creates one fargate node per pod.\u003C\u002Fp\u003E\n\n\u003Cp\u003EIAM permissions in EKS can be defined in two ways:\u003C\u002Fp\u003E\n\n\u003Col\u003E\n\u003Cli\u003EIAM Role for NodeGroups\u003C\u002Fli\u003E\n\u003Cli\u003EIAM role for Service Accounts(IRSA)\u003C\u002Fli\u003E\n\u003C\u002Fol\u003E\n\n\u003Ch2\u003E\n  \u003Ca name=\"iam-role-for-nodegroups\" href=\"#iam-role-for-nodegroups\"\u003E\n  \u003C\u002Fa\u003E\n  IAM Role for NodeGroups\n\u003C\u002Fh2\u003E\n\n\u003Cp\u003EWhenever we create an EKS cluster using \u003Ccode\u003Eeksctl\u003C\u002Fcode\u003E with node groups like below :\u003Cbr\u003E\n\u003C\u002Fp\u003E\n\n\u003Cdiv class=\"highlight js-code-highlight\"\u003E\n\u003Cpre class=\"highlight yaml\"\u003E\u003Ccode\u003E\u003Cspan class=\"na\"\u003EapiVersion\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003Eeksctl.io\u002Fv1alpha5\u003C\u002Fspan\u003E\n\u003Cspan class=\"na\"\u003Ekind\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003EClusterConfig\u003C\u002Fspan\u003E\n\n\u003Cspan class=\"na\"\u003Emetadata\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E\n  \u003Cspan class=\"na\"\u003Ename\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003Emonitoring-cluster\u003C\u002Fspan\u003E\n  \u003Cspan class=\"na\"\u003Eregion\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003Eus-east-1\u003C\u002Fspan\u003E\n  \u003Cspan class=\"na\"\u003Eversion\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s2\"\u003E\"\u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003E1.21\"\u003C\u002Fspan\u003E\n\n\u003Cspan class=\"na\"\u003EavailabilityZones\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \n  \u003Cspan class=\"pi\"\u003E-\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003Eus-east-1a\u003C\u002Fspan\u003E\n  \u003Cspan class=\"pi\"\u003E-\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003Eus-east-1b\u003C\u002Fspan\u003E\n  \u003Cspan class=\"pi\"\u003E-\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003Eus-east-1c\u003C\u002Fspan\u003E\n\n\u003Cspan class=\"na\"\u003EmanagedNodeGroups\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E\n  \u003Cspan class=\"pi\"\u003E-\u003C\u002Fspan\u003E \u003Cspan class=\"na\"\u003Ename\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003Emanaged-ng-1\u003C\u002Fspan\u003E\n    \u003Cspan class=\"na\"\u003EinstanceType\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003Et3a.medium\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cdiv class=\"highlight__panel js-actions-panel\"\u003E\n\u003Cdiv class=\"highlight__panel-action js-fullscreen-code-action\"\u003E\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"\u003E\u003Ctitle\u003EEnter fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"\u003E\u003Ctitle\u003EExit fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\n\n\u003Cp\u003E\u003Ccode\u003Eeksctl\u003C\u002Fcode\u003E automatically creates an IAM role with minimum IAM permissions required for the cluster to work and attaches it to the nodes part of the node group. All the pods running on these nodes inherit these permissions.\u003C\u002Fp\u003E\n\n\u003Cp\u003EThis role has 3 IAM policies attached that give basic access to the node :\u003C\u002Fp\u003E\n\n\u003Col\u003E\n\u003Cli\u003E\n\u003Ccode\u003EAmazonEKSWorkerNodePolicy\u003C\u002Fcode\u003E - This policy allows EKS worker nodes to connect to EKS clusters.\u003C\u002Fli\u003E\n\u003Cli\u003E\n\u003Ccode\u003EAmazonEC2ContainerRegistryReadOnly\u003C\u002Fcode\u003E - This policy gives read-only access to ECR.\u003C\u002Fli\u003E\n\u003Cli\u003E\n\u003Ccode\u003EAmazonEKS_CNI_Policy\u003C\u002Fcode\u003E - This policy is required for \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Faws\u002Famazon-vpc-cni-k8s#setup\"\u003Eamazon-vpc-cni\u003C\u002Fa\u003E plugin to function properly on nodes which is deployed as part of \u003Ccode\u003Eaws-node\u003C\u002Fcode\u003E daemonset in \u003Ccode\u003Ekube-system\u003C\u002Fcode\u003E namespace.\u003C\u002Fli\u003E\n\u003C\u002Fol\u003E\n\n\u003Cp\u003EThese permissions may not be enough if you are running workloads that require various other IAM permissions. \u003Ccode\u003Eeksctl\u003C\u002Fcode\u003E provides several ways to define additional permissions for the Node.\u003C\u002Fp\u003E\n\u003Ch3\u003E\n  \u003Ca name=\"attach-iam-policies-using-arn-to-the-node-group\" href=\"#attach-iam-policies-using-arn-to-the-node-group\"\u003E\n  \u003C\u002Fa\u003E\n  Attach IAM Policies using ARN to the Node Group.\n\u003C\u002Fh3\u003E\n\n\u003Cp\u003E\u003Ccode\u003Eeksctl\u003C\u002Fcode\u003E allows you to attach IAM policies to a node group using \u003Ccode\u003EattachPolicyARNs\u003C\u002Fcode\u003E.\u003Cbr\u003E\n\u003C\u002Fp\u003E\n\u003Cdiv class=\"highlight js-code-highlight\"\u003E\n\u003Cpre class=\"highlight yaml\"\u003E\u003Ccode\u003E\u003Cspan class=\"na\"\u003EmanagedNodeGroups\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E\n  \u003Cspan class=\"pi\"\u003E-\u003C\u002Fspan\u003E \u003Cspan class=\"na\"\u003Ename\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003Emanaged-ng-1\u003C\u002Fspan\u003E\n    \u003Cspan class=\"na\"\u003Eiam\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E\n      \u003Cspan class=\"na\"\u003EattachPolicyARNs\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E\n      \u003Cspan class=\"c1\"\u003E# Mandatory IAM Policies for NodeGroup.\u003C\u002Fspan\u003E\n      \u003Cspan class=\"pi\"\u003E-\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003Earn:aws:iam::aws:policy\u002FAmazonEKSWorkerNodePolicy\u003C\u002Fspan\u003E\n      \u003Cspan class=\"pi\"\u003E-\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003Earn:aws:iam::aws:policy\u002FAmazonEKS_CNI_Policy\u003C\u002Fspan\u003E\n      \u003Cspan class=\"pi\"\u003E-\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003Earn:aws:iam::aws:policy\u002FAmazonEC2ContainerRegistryReadOnly\u003C\u002Fspan\u003E\n\n      \u003Cspan class=\"c1\"\u003E# AWS Managed or Customer Managed IAM Policy ARN.\u003C\u002Fspan\u003E\n      \u003Cspan class=\"pi\"\u003E-\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003Earn:aws:iam::aws:policy\u002FAmazonS3FullAccess\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cdiv class=\"highlight__panel js-actions-panel\"\u003E\n\u003Cdiv class=\"highlight__panel-action js-fullscreen-code-action\"\u003E\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"\u003E\u003Ctitle\u003EEnter fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"\u003E\u003Ctitle\u003EExit fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\n\n\u003Cp\u003EPlease note that while specifying IAM policy ARNs using \u003Ccode\u003EattachPolicyARNs\u003C\u002Fcode\u003E, it's mandatory to include the above 3 IAM policies as they are required for the node to function properly.\u003C\u002Fp\u003E\n\n\u003Cp\u003EIf you missed specifying these 3 IAM policies, you will get an error like this :\u003Cbr\u003E\n\u003C\u002Fp\u003E\n\u003Cdiv class=\"highlight js-code-highlight\"\u003E\n\u003Cpre class=\"highlight shell\"\u003E\u003Ccode\u003EAWS::EKS::Nodegroup\u002FManagedNodeGroup: CREATE_FAILED – \u003Cspan class=\"s2\"\u003E\"The provided role doesn't have the Amazon EKS Managed Policies associated with it. Please ensure the following policies [arn:aws:iam::aws:policy\u002FAmazonEKSWorkerNodePolicy, arn:aws:iam::aws:policy\u002FAmazonEC2ContainerRegistryReadOnly] are attached \"\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cdiv class=\"highlight__panel js-actions-panel\"\u003E\n\u003Cdiv class=\"highlight__panel-action js-fullscreen-code-action\"\u003E\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"\u003E\u003Ctitle\u003EEnter fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"\u003E\u003Ctitle\u003EExit fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\n\u003Ch3\u003E\n  \u003Ca name=\"attach-iam-role-and-instance-profile-to-the-node-group\" href=\"#attach-iam-role-and-instance-profile-to-the-node-group\"\u003E\n  \u003C\u002Fa\u003E\n  Attach IAM Role and Instance Profile to the Node Group\n\u003C\u002Fh3\u003E\n\n\u003Cp\u003EIf you have an existing \u003Ccode\u003EIAM Role\u003C\u002Fcode\u003E and \u003Ccode\u003EInstance Profile\u003C\u002Fcode\u003E, then you can define that for a node group :\u003Cbr\u003E\n\u003C\u002Fp\u003E\n\u003Cdiv class=\"highlight js-code-highlight\"\u003E\n\u003Cpre class=\"highlight yaml\"\u003E\u003Ccode\u003E\u003Cspan class=\"na\"\u003EmanagedNodeGroups\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E\n  \u003Cspan class=\"pi\"\u003E-\u003C\u002Fspan\u003E \u003Cspan class=\"na\"\u003Ename\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003Emanaged-ng-1\u003C\u002Fspan\u003E\n    \u003Cspan class=\"na\"\u003Eiam\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E\n      \u003Cspan class=\"na\"\u003EinstanceProfileARN\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s2\"\u003E\"\u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003E&lt;Instance\u003C\u002Fspan\u003E\u003Cspan class=\"nv\"\u003E \u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003EProfile\u003C\u002Fspan\u003E\u003Cspan class=\"nv\"\u003E \u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003EARN&gt;\"\u003C\u002Fspan\u003E\n      \u003Cspan class=\"na\"\u003EinstanceRoleARN\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s2\"\u003E\"\u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003E&lt;IAM\u003C\u002Fspan\u003E\u003Cspan class=\"nv\"\u003E \u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003ERole\u003C\u002Fspan\u003E\u003Cspan class=\"nv\"\u003E \u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003EARN&gt;\"\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cdiv class=\"highlight__panel js-actions-panel\"\u003E\n\u003Cdiv class=\"highlight__panel-action js-fullscreen-code-action\"\u003E\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"\u003E\u003Ctitle\u003EEnter fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"\u003E\u003Ctitle\u003EExit fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\n\u003Ch3\u003E\n  \u003Ca name=\"attach-addons-iam-policy\" href=\"#attach-addons-iam-policy\"\u003E\n  \u003C\u002Fa\u003E\n  Attach Addons IAM Policy\n\u003C\u002Fh3\u003E\n\n\u003Cp\u003E\u003Ccode\u003Eeksctl\u003C\u002Fcode\u003E provides out-of-box IAM policies for the cluster add-ons such as \u003Ccode\u003Ecluster autoscaler\u003C\u002Fcode\u003E, \u003Ccode\u003Eexternal DNS\u003C\u002Fcode\u003E, \u003Ccode\u003Ecert-manager\u003C\u002Fcode\u003E.\u003Cbr\u003E\n\u003C\u002Fp\u003E\n\u003Cdiv class=\"highlight js-code-highlight\"\u003E\n\u003Cpre class=\"highlight yaml\"\u003E\u003Ccode\u003E\u003Cspan class=\"na\"\u003EmanagedNodeGroups\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E\n  \u003Cspan class=\"pi\"\u003E-\u003C\u002Fspan\u003E \u003Cspan class=\"na\"\u003Ename\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003Emanaged-ng-1\u003C\u002Fspan\u003E\n    \u003Cspan class=\"na\"\u003Eiam\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E\n      \u003Cspan class=\"na\"\u003EwithAddonPolicies\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E\n        \u003Cspan class=\"na\"\u003EimageBuilder\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"no\"\u003Etrue\u003C\u002Fspan\u003E\n        \u003Cspan class=\"na\"\u003EautoScaler\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"no\"\u003Etrue\u003C\u002Fspan\u003E\n        \u003Cspan class=\"na\"\u003EexternalDNS\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"no\"\u003Etrue\u003C\u002Fspan\u003E\n        \u003Cspan class=\"na\"\u003EcertManager\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"no\"\u003Etrue\u003C\u002Fspan\u003E\n        \u003Cspan class=\"na\"\u003EappMesh\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"no\"\u003Etrue\u003C\u002Fspan\u003E\n        \u003Cspan class=\"na\"\u003Eebs\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"no\"\u003Etrue\u003C\u002Fspan\u003E\n        \u003Cspan class=\"na\"\u003Efsx\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"no\"\u003Etrue\u003C\u002Fspan\u003E\n        \u003Cspan class=\"na\"\u003Eefs\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"no\"\u003Etrue\u003C\u002Fspan\u003E\n        \u003Cspan class=\"na\"\u003EalbIngress\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"no\"\u003Etrue\u003C\u002Fspan\u003E\n        \u003Cspan class=\"na\"\u003ExRay\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"no\"\u003Etrue\u003C\u002Fspan\u003E\n        \u003Cspan class=\"na\"\u003EcloudWatch\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"no\"\u003Etrue\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cdiv class=\"highlight__panel js-actions-panel\"\u003E\n\u003Cdiv class=\"highlight__panel-action js-fullscreen-code-action\"\u003E\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"\u003E\u003Ctitle\u003EEnter fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"\u003E\u003Ctitle\u003EExit fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\n\n\u003Col\u003E\n\u003Cli\u003E\u003Cp\u003E\u003Ccode\u003EimageBuilder\u003C\u002Fcode\u003E - Full ECR access with \u003Ccode\u003EAmazonEC2ContainerRegistryPowerUser\u003C\u002Fcode\u003E.\u003C\u002Fp\u003E\u003C\u002Fli\u003E\n\u003Cli\u003E\u003Cp\u003E\u003Ccode\u003EautoScaler\u003C\u002Fcode\u003E - IAM policy for \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fkubernetes\u002Fautoscaler\u002Ftree\u002Fmaster\u002Fcluster-autoscaler\u002Fcloudprovider\u002Faws#iam-policy\"\u003ECluster Autoscaler\u003C\u002Fa\u003E.\u003C\u002Fp\u003E\u003C\u002Fli\u003E\n\u003Cli\u003E\u003Cp\u003E\u003Ccode\u003EexternalDNS\u003C\u002Fcode\u003E - IAM policy for \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fkubernetes-sigs\u002Fexternal-dns\u002Fblob\u002Fmaster\u002Fdocs\u002Ftutorials\u002Faws.md#iam-policy\"\u003EExternal DNS\u003C\u002Fa\u003E.\u003C\u002Fp\u003E\u003C\u002Fli\u003E\n\u003Cli\u003E\u003Cp\u003E\u003Ccode\u003EcertManager\u003C\u002Fcode\u003E - IAM Policy for \u003Ca href=\"https:\u002F\u002Fcert-manager.io\u002Fdocs\u002Fconfiguration\u002Facme\u002Fdns01\u002Froute53\u002F#set-up-an-iam-role\"\u003ECert Manager\u003C\u002Fa\u003E.\u003C\u002Fp\u003E\u003C\u002Fli\u003E\n\u003Cli\u003E\u003Cp\u003E\u003Ccode\u003EappMesh\u003C\u002Fcode\u003E - IAM policy for \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Faws\u002Faws-app-mesh-controller-for-k8s\u002Fblob\u002Fmaster\u002Fconfig\u002Fiam\u002Fcontroller-iam-policy.json\"\u003EAWS App Mesh\u003C\u002Fa\u003E.\u003C\u002Fp\u003E\u003C\u002Fli\u003E\n\u003Cli\u003E\u003Cp\u003E\u003Ccode\u003Eebs\u003C\u002Fcode\u003E - IAM Policy for \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fkubernetes-sigs\u002Faws-ebs-csi-driver\u002Fblob\u002Fmaster\u002Fdocs\u002Fexample-iam-policy.json\"\u003EAWS EBS CSI Driver\u003C\u002Fa\u003E.\u003C\u002Fp\u003E\u003C\u002Fli\u003E\n\u003Cli\u003E\u003Cp\u003E\u003Ccode\u003Efsx\u003C\u002Fcode\u003E - IAM Policy for \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fkubernetes-sigs\u002Faws-fsx-csi-driver\u002Ftree\u002Fmaster\u002Fdocs#installation\"\u003EAWS FSX Lustre\u003C\u002Fa\u003E.\u003C\u002Fp\u003E\u003C\u002Fli\u003E\n\u003Cli\u003E\u003Cp\u003E\u003Ccode\u003Eefs\u003C\u002Fcode\u003E - IAM Policy for \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fkubernetes-sigs\u002Faws-efs-csi-driver\u002Fblob\u002Fmaster\u002Fdocs\u002Fiam-policy-example.json\"\u003EAWS EFS CSI Driver\u003C\u002Fa\u003E.\u003C\u002Fp\u003E\u003C\u002Fli\u003E\n\u003Cli\u003E\u003Cp\u003E\u003Ccode\u003EalbIngress\u003C\u002Fcode\u003E - IAM Policy for \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fkubernetes-sigs\u002Faws-load-balancer-controller\u002Fblob\u002Fmain\u002Fdocs\u002Finstall\u002Fiam_policy.json\"\u003EALB Ingress Controller\u003C\u002Fa\u003E.\u003C\u002Fp\u003E\u003C\u002Fli\u003E\n\u003Cli\u003E\u003Cp\u003E\u003Ccode\u003ExRay\u003C\u002Fcode\u003E - IAM Policy \u003Ccode\u003EAWSXRayDaemonWriteAccess\u003C\u002Fcode\u003E for \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Faws\u002Faws-xray-daemon\"\u003EAWS X-ray Daemon\u003C\u002Fa\u003E \u003C\u002Fp\u003E\u003C\u002Fli\u003E\n\u003Cli\u003E\u003Cp\u003E\u003Ccode\u003EcloudWatch\u003C\u002Fcode\u003E - IAM Policy \u003Ccode\u003ECloudWatchAgentServerPolicy\u003C\u002Fcode\u003E for \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Faws\u002Famazon-cloudwatch-agent\"\u003EAWS Cloudwatch Agent\u003C\u002Fa\u003E.\u003C\u002Fp\u003E\u003C\u002Fli\u003E\n\u003C\u002Fol\u003E\n\n\u003Cp\u003EWhile all the above options allow you to define IAM permissions for the node group, there is a problem with defining IAM permissions at the node level.\u003C\u002Fp\u003E\n\n\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--ffH75DXS--\u002Fc_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880\u002Fhttps:\u002F\u002Fdev-to-uploads.s3.amazonaws.com\u002Fuploads\u002Farticles\u002Fot1yz308b4adguc5wcme.jpeg\" class=\"article-body-image-wrapper\"\u003E\u003Cimg src=\"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--ffH75DXS--\u002Fc_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880\u002Fhttps:\u002F\u002Fdev-to-uploads.s3.amazonaws.com\u002Fuploads\u002Farticles\u002Fot1yz308b4adguc5wcme.jpeg\" alt=\"problem\" loading=\"lazy\"\u003E\u003C\u002Fa\u003E\u003C\u002Fp\u003E\n\n\u003Cp\u003EAll the pods running on nodes part of the node group will have these permissions thus not adhering to the \u003Cstrong\u003Eprinciple of least privilege\u003C\u002Fstrong\u003E. For example, if we attach \u003Ccode\u003EEC2 Admin\u003C\u002Fcode\u003E and \u003Ccode\u003ECloudformation\u003C\u002Fcode\u003E permissions to the node group to run \u003Ccode\u003ECI server\u003C\u002Fcode\u003E, any other pods running on this node group will effectively inherit these permissions.\u003C\u002Fp\u003E\n\n\u003Cp\u003EOne way to overcome this problem is to create a separate node group for the CI server. ( Use \u003Ca href=\"https:\u002F\u002Fkubernetes.io\u002Fdocs\u002Fconcepts\u002Fscheduling-eviction\u002Ftaint-and-toleration\u002F#concepts\"\u003Etaints\u003C\u002Fa\u003E and \u003Ca href=\"https:\u002F\u002Fkubernetes.io\u002Fdocs\u002Fconcepts\u002Fscheduling-eviction\u002Fassign-pod-node\u002F#node-affinity\"\u003Eaffinity\u003C\u002Fa\u003E to ensure only CI pods are deployed on this node group)\u003C\u002Fp\u003E\n\n\u003Cp\u003EHowever AWS access is not just required for CI servers, many applications use AWS services such as \u003Ccode\u003ES3\u003C\u002Fcode\u003E, \u003Ccode\u003ESQS\u003C\u002Fcode\u003E, and \u003Ccode\u003EKMS\u003C\u002Fcode\u003E and would require fine-grained IAM permissions. Creating one node group for every such application would not be an ideal solution and can lead to \u003Cstrong\u003Emaintenance issues\u003C\u002Fstrong\u003E, \u003Cstrong\u003Ehigher cost\u003C\u002Fstrong\u003E, and \u003Cstrong\u003Elow resource consumption\u003C\u002Fstrong\u003E.\u003C\u002Fp\u003E\n\n\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--B-XGZ7Ih--\u002Fc_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880\u002Fhttps:\u002F\u002Fdev-to-uploads.s3.amazonaws.com\u002Fuploads\u002Farticles\u002Fb1bzi3gm71dyrfkdfvji.jpeg\" class=\"article-body-image-wrapper\"\u003E\u003Cimg src=\"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--B-XGZ7Ih--\u002Fc_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880\u002Fhttps:\u002F\u002Fdev-to-uploads.s3.amazonaws.com\u002Fuploads\u002Farticles\u002Fb1bzi3gm71dyrfkdfvji.jpeg\" alt=\"solution\" loading=\"lazy\"\u003E\u003C\u002Fa\u003E\u003C\u002Fp\u003E\n\u003Ch2\u003E\n  \u003Ca name=\"iam-roles-for-service-accounts\" href=\"#iam-roles-for-service-accounts\"\u003E\n  \u003C\u002Fa\u003E\n  IAM Roles for Service Accounts\n\u003C\u002Fh2\u003E\n\n\u003Cp\u003EAmazon EKS supports \u003Ccode\u003EIAM Roles for Service Accounts (IRSA)\u003C\u002Fcode\u003E that allows us to map AWS IAM Roles to Kubernetes Service Accounts. With IRSA, instead of defining IAM permissions on the node, we can attach an \u003Cstrong\u003EIAM role\u003C\u002Fstrong\u003E to a \u003Cstrong\u003EKubernetes Service Account\u003C\u002Fstrong\u003E and attach the service account to the \u003Cstrong\u003Epod\u002Fdeployment\u003C\u002Fstrong\u003E.\u003C\u002Fp\u003E\n\n\u003Cp\u003EIAM role is added to the Kubernetes service account by adding annotation \u003Ccode\u003Eeks.amazonaws.com\u002Frole-arn\u003C\u002Fcode\u003E with value as the \u003Ccode\u003EIAM Role ARN\u003C\u002Fcode\u003E.\u003Cbr\u003E\n\u003C\u002Fp\u003E\n\u003Cdiv class=\"highlight js-code-highlight\"\u003E\n\u003Cpre class=\"highlight yaml\"\u003E\u003Ccode\u003E\u003Cspan class=\"na\"\u003EapiVersion\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003Ev1\u003C\u002Fspan\u003E\n\u003Cspan class=\"na\"\u003Ekind\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003EServiceAccount\u003C\u002Fspan\u003E\n\u003Cspan class=\"na\"\u003Emetadata\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E\n  \u003Cspan class=\"na\"\u003Ename\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003Emy-serviceaccount\u003C\u002Fspan\u003E\n  \u003Cspan class=\"na\"\u003Eannotations\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E\n    \u003Cspan class=\"s\"\u003Eeks.amazonaws.com\u002Frole-arn\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s2\"\u003E\"\u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003E&lt;IAM\u003C\u002Fspan\u003E\u003Cspan class=\"nv\"\u003E \u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003ERole\u003C\u002Fspan\u003E\u003Cspan class=\"nv\"\u003E \u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003EARN&gt;\"\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cdiv class=\"highlight__panel js-actions-panel\"\u003E\n\u003Cdiv class=\"highlight__panel-action js-fullscreen-code-action\"\u003E\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"\u003E\u003Ctitle\u003EEnter fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"\u003E\u003Ctitle\u003EExit fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\n\n\u003Cp\u003EEKS create a Mutating Admission Webhook \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Faws\u002Famazon-eks-pod-identity-webhook\u002F\"\u003Epod-identity-webhook\u003C\u002Fa\u003E and uses it to intercept the pod creation request and update the pod spec to include IAM credentials.\u003C\u002Fp\u003E\n\n\u003Cp\u003ECheck the \u003Ca href=\"https:\u002F\u002Fkubernetes.io\u002Fdocs\u002Freference\u002Faccess-authn-authz\u002Fadmission-controllers\u002F#mutatingadmissionwebhook\"\u003EMutating Admission Webhooks\u003C\u002Fa\u003E in the cluster:\u003Cbr\u003E\n\u003C\u002Fp\u003E\n\u003Cdiv class=\"highlight js-code-highlight\"\u003E\n\u003Cpre class=\"highlight shell\"\u003E\u003Ccode\u003Ekubectl get mutatingwebhookconfigurations.admissionregistration.k8s.io\n\nNAME                                             WEBHOOKS   AGE\n0500-amazon-eks-fargate-mutation.amazonaws.com   2          21m\npod-identity-webhook                             1          28m\nvpc-resource-mutating-webhook                    1          28m\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cdiv class=\"highlight__panel js-actions-panel\"\u003E\n\u003Cdiv class=\"highlight__panel-action js-fullscreen-code-action\"\u003E\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"\u003E\u003Ctitle\u003EEnter fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"\u003E\u003Ctitle\u003EExit fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\n\n\u003Cp\u003E\u003Ccode\u003Epod-identity-webhook\u003C\u002Fcode\u003E supports several configuration options:\u003C\u002Fp\u003E\n\n\u003Col\u003E\n\u003Cli\u003E\n\u003Ccode\u003Eeks.amazonaws.com\u002Frole-arn\u003C\u002Fcode\u003E - IAM Role ARN to attach to the service account.\u003C\u002Fli\u003E\n\u003Cli\u003E\n\u003Ccode\u003Eeks.amazonaws.com\u002Faudience\u003C\u002Fcode\u003E - Intended autience of the \u003Ca href=\"https:\u002F\u002Fkubernetes.io\u002Fdocs\u002Ftasks\u002Fconfigure-pod-container\u002Fconfigure-service-account\u002F#service-account-token-volume-projection\"\u003Etoken\u003C\u002Fa\u003E, defaults to \"sts.amazonaws.com\" if not set.\u003C\u002Fli\u003E\n\u003Cli\u003E\n\u003Ccode\u003Eeks.amazonaws.com\u002Fsts-regional-endpoints\u003C\u002Fcode\u003E - AWS STS is a global service, however, we can use regional STS endpoints to reduce latency. Set \u003Ccode\u003Etrue\u003C\u002Fcode\u003E to use regional STS endpoints.\u003C\u002Fli\u003E\n\u003Cli\u003E\n\u003Ccode\u003Eeks.amazonaws.com\u002Ftoken-expiration\u003C\u002Fcode\u003E - AWS STS Token expiration duration, default is \u003Ccode\u003E86400 seconds\u003C\u002Fcode\u003E or \u003Ccode\u003E24 hours\u003C\u002Fcode\u003E. We can override this value by defining it at the \u003Ccode\u003Epod level\u003C\u002Fcode\u003E.\u003C\u002Fli\u003E\n\u003Cli\u003E\n\u003Ccode\u003Eeks.amazonaws.com\u002Fskip-containers\u003C\u002Fcode\u003E - A comma-separated list of containers to skip adding volume and environment variables. \u003Ccode\u003EThis annotation is only supported at the pod level.\u003C\u002Fcode\u003E\n\u003C\u002Fli\u003E\n\u003C\u002Fol\u003E\n\u003Cdiv class=\"highlight js-code-highlight\"\u003E\n\u003Cpre class=\"highlight yaml\"\u003E\u003Ccode\u003E\u003Cspan class=\"na\"\u003EapiVersion\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003Ev1\u003C\u002Fspan\u003E\n\u003Cspan class=\"na\"\u003Ekind\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003EServiceAccount\u003C\u002Fspan\u003E\n\u003Cspan class=\"na\"\u003Emetadata\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E\n  \u003Cspan class=\"na\"\u003Ename\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003Emy-serviceaccount\u003C\u002Fspan\u003E\n  \u003Cspan class=\"na\"\u003Eannotations\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E\n    \u003Cspan class=\"s\"\u003Eeks.amazonaws.com\u002Frole-arn\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s2\"\u003E\"\u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003E&lt;IAM\u003C\u002Fspan\u003E\u003Cspan class=\"nv\"\u003E \u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003ERole\u003C\u002Fspan\u003E\u003Cspan class=\"nv\"\u003E \u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003EARN&gt;\"\u003C\u002Fspan\u003E\n    \u003Cspan class=\"s\"\u003Eeks.amazonaws.com\u002Faudience\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s2\"\u003E\"\u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003Ests.amazonaws.com\"\u003C\u002Fspan\u003E\n    \u003Cspan class=\"s\"\u003Eeks.amazonaws.com\u002Fsts-regional-endpoints\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s2\"\u003E\"\u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003Etrue\"\u003C\u002Fspan\u003E\n    \u003Cspan class=\"s\"\u003Eeks.amazonaws.com\u002Ftoken-expiration\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s2\"\u003E\"\u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003E86400\"\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cdiv class=\"highlight__panel js-actions-panel\"\u003E\n\u003Cdiv class=\"highlight__panel-action js-fullscreen-code-action\"\u003E\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"\u003E\u003Ctitle\u003EEnter fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"\u003E\u003Ctitle\u003EExit fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\n\u003Ch3\u003E\n  \u003Ca name=\"how-irsa-works\" href=\"#how-irsa-works\"\u003E\n  \u003C\u002Fa\u003E\n  How IRSA Works\n\u003C\u002Fh3\u003E\n\n\u003Cp\u003EWhen you define the IAM role for a service account using \u003Ccode\u003Eeks.amazonaws.com\u002Frole-arn\u003C\u002Fcode\u003E annotation and add this service account to the pod, \u003Ccode\u003Epod-identity-webhook\u003C\u002Fcode\u003E mutates the pod spec to add \u003Ccode\u003Eenvironment variables\u003C\u002Fcode\u003E and \u003Ca href=\"https:\u002F\u002Fkubernetes.io\u002Fdocs\u002Fconcepts\u002Fstorage\u002Fvolumes\u002F#projected\"\u003Eprojected mount volumes\u003C\u002Fa\u003E.\u003C\u002Fp\u003E\n\n\u003Cp\u003EThese are the environment variables added by \u003Ccode\u003Epod-identity-webhook\u003C\u002Fcode\u003E in the pod spec:\u003Cbr\u003E\n\u003C\u002Fp\u003E\n\u003Cdiv class=\"highlight js-code-highlight\"\u003E\n\u003Cpre class=\"highlight yaml\"\u003E\u003Ccode\u003E  \u003Cspan class=\"na\"\u003Eenv\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E\n    \u003Cspan class=\"pi\"\u003E-\u003C\u002Fspan\u003E \u003Cspan class=\"na\"\u003Ename\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003EAWS_DEFAULT_REGION\u003C\u002Fspan\u003E\n      \u003Cspan class=\"na\"\u003Evalue\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003Eus-east-1\u003C\u002Fspan\u003E\n    \u003Cspan class=\"pi\"\u003E-\u003C\u002Fspan\u003E \u003Cspan class=\"na\"\u003Ename\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003EAWS_REGION\u003C\u002Fspan\u003E\n      \u003Cspan class=\"na\"\u003Evalue\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003Eus-east-1\u003C\u002Fspan\u003E\n    \u003Cspan class=\"pi\"\u003E-\u003C\u002Fspan\u003E \u003Cspan class=\"na\"\u003Ename\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003EAWS_ROLE_ARN\u003C\u002Fspan\u003E\n      \u003Cspan class=\"na\"\u003Evalue\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s2\"\u003E\"\u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003E&lt;IAM\u003C\u002Fspan\u003E\u003Cspan class=\"nv\"\u003E \u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003EROLE\u003C\u002Fspan\u003E\u003Cspan class=\"nv\"\u003E \u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003EARN&gt;\"\u003C\u002Fspan\u003E\n    \u003Cspan class=\"pi\"\u003E-\u003C\u002Fspan\u003E \u003Cspan class=\"na\"\u003Ename\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003EAWS_WEB_IDENTITY_TOKEN_FILE\u003C\u002Fspan\u003E\n      \u003Cspan class=\"na\"\u003Evalue\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s2\"\u003E\"\u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003E\u002Fvar\u002Frun\u002Fsecrets\u002Feks.amazonaws.com\u002Fserviceaccount\u002Ftoken\"\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cdiv class=\"highlight__panel js-actions-panel\"\u003E\n\u003Cdiv class=\"highlight__panel-action js-fullscreen-code-action\"\u003E\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"\u003E\u003Ctitle\u003EEnter fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"\u003E\u003Ctitle\u003EExit fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\n\n\u003Col\u003E\n\u003Cli\u003E\u003Cp\u003E\u003Ccode\u003EAWS_DEFAULT_REGION\u003C\u002Fcode\u003E and \u003Ccode\u003EAWS_REGION\u003C\u002Fcode\u003E - Cluster Region \u003C\u002Fp\u003E\u003C\u002Fli\u003E\n\u003Cli\u003E\u003Cp\u003E\u003Ccode\u003EAWS_ROLE_ARN\u003C\u002Fcode\u003E - IAM Role ARN.\u003C\u002Fp\u003E\u003C\u002Fli\u003E\n\u003Cli\u003E\u003Cp\u003E\u003Ccode\u003EAWS_WEB_IDENTITY_TOKEN_FILE\u003C\u002Fcode\u003E - Path to the tokens file\u003C\u002Fp\u003E\u003C\u002Fli\u003E\n\u003C\u002Fol\u003E\n\n\u003Cp\u003E\u003Ccode\u003Epod-identity-webhook\u003C\u002Fcode\u003E also adds a projected volume for service account token:\u003Cbr\u003E\n\u003C\u002Fp\u003E\n\u003Cdiv class=\"highlight js-code-highlight\"\u003E\n\u003Cpre class=\"highlight yaml\"\u003E\u003Ccode\u003E    \u003Cspan class=\"na\"\u003EvolumeMounts\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E\n    \u003Cspan class=\"pi\"\u003E-\u003C\u002Fspan\u003E \u003Cspan class=\"na\"\u003EmountPath\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s2\"\u003E\"\u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003E\u002Fvar\u002Frun\u002Fsecrets\u002Feks.amazonaws.com\u002Fserviceaccount\"\u003C\u002Fspan\u003E\n      \u003Cspan class=\"na\"\u003Ename\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003Eaws-iam-token\u003C\u002Fspan\u003E\n  \u003Cspan class=\"na\"\u003Evolumes\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E\n  \u003Cspan class=\"pi\"\u003E-\u003C\u002Fspan\u003E \u003Cspan class=\"na\"\u003Ename\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003Eaws-iam-token\u003C\u002Fspan\u003E\n    \u003Cspan class=\"na\"\u003Eprojected\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E\n      \u003Cspan class=\"na\"\u003Esources\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E\n      \u003Cspan class=\"pi\"\u003E-\u003C\u002Fspan\u003E \u003Cspan class=\"na\"\u003EserviceAccountToken\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E\n          \u003Cspan class=\"na\"\u003Eaudience\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s2\"\u003E\"\u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003Ests.amazonaws.com\"\u003C\u002Fspan\u003E\n          \u003Cspan class=\"na\"\u003EexpirationSeconds\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E86400\u003C\u002Fspan\u003E\n          \u003Cspan class=\"na\"\u003Epath\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003Etoken\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cdiv class=\"highlight__panel js-actions-panel\"\u003E\n\u003Cdiv class=\"highlight__panel-action js-fullscreen-code-action\"\u003E\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"\u003E\u003Ctitle\u003EEnter fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"\u003E\u003Ctitle\u003EExit fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\n\n\u003Cp\u003Ea projected volume is created with the name \u003Ccode\u003Eaws-iam-token\u003C\u002Fcode\u003E and mounted to the container at \u003Ccode\u003E\u002Fvar\u002Frun\u002Fsecrets\u002Feks.amazonaws.com\u002Fserviceaccount\u003C\u002Fcode\u003E.\u003C\u002Fp\u003E\n\n\u003Cp\u003E\u003Cstrong\u003ELet's test it out.\u003C\u002Fstrong\u003E\u003C\u002Fp\u003E\n\n\u003Cul\u003E\n\u003Cli\u003ECreate an EKS cluster with a Managed NodeGroup and an IAM service account \u003Ccode\u003Es3-reader\u003C\u002Fcode\u003E in the default namespace with \u003Ccode\u003EAmazonS3ReadOnlyAccess\u003C\u002Fcode\u003E IAM permissions :\n\u003C\u002Fli\u003E\n\u003C\u002Ful\u003E\n\u003Cdiv class=\"highlight js-code-highlight\"\u003E\n\u003Cpre class=\"highlight yaml\"\u003E\u003Ccode\u003E\u003Cspan class=\"na\"\u003EapiVersion\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003Eeksctl.io\u002Fv1alpha5\u003C\u002Fspan\u003E\n\u003Cspan class=\"na\"\u003Ekind\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003EClusterConfig\u003C\u002Fspan\u003E\n\u003Cspan class=\"na\"\u003Emetadata\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E\n  \u003Cspan class=\"na\"\u003Ename\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003Eiam-cluster\u003C\u002Fspan\u003E\n  \u003Cspan class=\"na\"\u003Eregion\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003Eus-east-1\u003C\u002Fspan\u003E\n  \u003Cspan class=\"na\"\u003Eversion\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s2\"\u003E\"\u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003E1.21\"\u003C\u002Fspan\u003E\n\u003Cspan class=\"na\"\u003EavailabilityZones\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \n  \u003Cspan class=\"pi\"\u003E-\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003Eus-east-1a\u003C\u002Fspan\u003E\n  \u003Cspan class=\"pi\"\u003E-\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003Eus-east-1b\u003C\u002Fspan\u003E\n  \u003Cspan class=\"pi\"\u003E-\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003Eus-east-1c\u003C\u002Fspan\u003E\n\u003Cspan class=\"na\"\u003Eiam\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E\n  \u003Cspan class=\"na\"\u003EwithOIDC\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"no\"\u003Etrue\u003C\u002Fspan\u003E\n  \u003Cspan class=\"na\"\u003EserviceAccounts\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E\n  \u003Cspan class=\"pi\"\u003E-\u003C\u002Fspan\u003E \u003Cspan class=\"na\"\u003Emetadata\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E\n      \u003Cspan class=\"na\"\u003Ename\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003Es3-reader\u003C\u002Fspan\u003E\n    \u003Cspan class=\"na\"\u003EattachPolicyARNs\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E\n    \u003Cspan class=\"pi\"\u003E-\u003C\u002Fspan\u003E \u003Cspan class=\"s2\"\u003E\"\u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003Earn:aws:iam::aws:policy\u002FAmazonS3ReadOnlyAccess\"\u003C\u002Fspan\u003E\n\u003Cspan class=\"na\"\u003EmanagedNodeGroups\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E\n  \u003Cspan class=\"pi\"\u003E-\u003C\u002Fspan\u003E \u003Cspan class=\"na\"\u003Ename\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003Emanaged-ng-1\u003C\u002Fspan\u003E\n    \u003Cspan class=\"na\"\u003EinstanceType\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003Et3a.medium\u003C\u002Fspan\u003E\n    \u003Cspan class=\"na\"\u003EminSize\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E1\u003C\u002Fspan\u003E\n    \u003Cspan class=\"na\"\u003EmaxSize\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E4\u003C\u002Fspan\u003E\n    \u003Cspan class=\"na\"\u003EdesiredCapacity\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E4\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cdiv class=\"highlight__panel js-actions-panel\"\u003E\n\u003Cdiv class=\"highlight__panel-action js-fullscreen-code-action\"\u003E\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"\u003E\u003Ctitle\u003EEnter fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"\u003E\u003Ctitle\u003EExit fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\n\n\u003Cp\u003E\u003Cstrong\u003ENote:\u003C\u002Fstrong\u003E  We can also attach IAM Role directly using \u003Ccode\u003EattachRoleARN\u003C\u002Fcode\u003E. However, the role should have below \u003Ccode\u003Etrust policy\u003C\u002Fcode\u003E to allow the pods to use this role :\u003Cbr\u003E\n\u003C\u002Fp\u003E\n\u003Cdiv class=\"highlight js-code-highlight\"\u003E\n\u003Cpre class=\"highlight json\"\u003E\u003Ccode\u003E\u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n \u003C\u002Fspan\u003E\u003Cspan class=\"nl\"\u003E\"Version\"\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E \u003C\u002Fspan\u003E\u003Cspan class=\"s2\"\u003E\"2012-10-17\"\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n \u003C\u002Fspan\u003E\u003Cspan class=\"nl\"\u003E\"Statement\"\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E \u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n  \u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n   \u003C\u002Fspan\u003E\u003Cspan class=\"nl\"\u003E\"Effect\"\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E \u003C\u002Fspan\u003E\u003Cspan class=\"s2\"\u003E\"Allow\"\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n   \u003C\u002Fspan\u003E\u003Cspan class=\"nl\"\u003E\"Principal\"\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E \u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n    \u003C\u002Fspan\u003E\u003Cspan class=\"nl\"\u003E\"Federated\"\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E \u003C\u002Fspan\u003E\u003Cspan class=\"s2\"\u003E\"arn:aws:iam::&lt;AWS_ACCOUNT_ID&gt;:oidc-provider\u002Foidc.&lt;REGION&gt;.eks.amazonaws.com\u002F&lt;CLUSTER_ID&gt;\"\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n   \u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E},\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n   \u003C\u002Fspan\u003E\u003Cspan class=\"nl\"\u003E\"Action\"\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E \u003C\u002Fspan\u003E\u003Cspan class=\"s2\"\u003E\"sts:AssumeRoleWithWebIdentity\"\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n   \u003C\u002Fspan\u003E\u003Cspan class=\"nl\"\u003E\"Condition\"\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E \u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n    \u003C\u002Fspan\u003E\u003Cspan class=\"nl\"\u003E\"StringEquals\"\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E \u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n     \u003C\u002Fspan\u003E\u003Cspan class=\"nl\"\u003E\"oidc.&lt;REGION&gt;.eks.amazonaws.com\u002F&lt;CLUSTER_ID&gt;:sub\"\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E \u003C\u002Fspan\u003E\u003Cspan class=\"s2\"\u003E\"system:serviceaccount:default:my-serviceaccount\"\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n    \u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E},\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n    \u003C\u002Fspan\u003E\u003Cspan class=\"nl\"\u003E\"StringLike\"\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E \u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n     \u003C\u002Fspan\u003E\u003Cspan class=\"nl\"\u003E\"oidc.&lt;REGION&gt;.eks.amazonaws.com\u002FCLUSTER_ID:sub\"\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E \u003C\u002Fspan\u003E\u003Cspan class=\"s2\"\u003E\"system:serviceaccount:default:*\"\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n    \u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E}\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n   \u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E}\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n  \u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E}\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n \u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E]\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E}\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cdiv class=\"highlight__panel js-actions-panel\"\u003E\n\u003Cdiv class=\"highlight__panel-action js-fullscreen-code-action\"\u003E\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"\u003E\u003Ctitle\u003EEnter fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"\u003E\u003Ctitle\u003EExit fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\n\n\u003Cul\u003E\n\u003Cli\u003ECheck the role created by \u003Ccode\u003Eeksctl\u003C\u002Fcode\u003E for service account \u003Ccode\u003Es3-reader\u003C\u002Fcode\u003E\n\u003C\u002Fli\u003E\n\u003C\u002Ful\u003E\n\u003Cdiv class=\"highlight js-code-highlight\"\u003E\n\u003Cpre class=\"highlight shell\"\u003E\u003Ccode\u003Eeksctl get iamserviceaccount s3-reader \u003Cspan class=\"nt\"\u003E--cluster\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003Eiam-cluster \u003Cspan class=\"nt\"\u003E--region\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003Eus-east-1\n2021-08-25 02:51:14 \u003Cspan class=\"o\"\u003E[\u003C\u002Fspan\u003Eℹ]  eksctl version 0.61.0\n2021-08-25 02:51:14 \u003Cspan class=\"o\"\u003E[\u003C\u002Fspan\u003Eℹ]  using region us-east-1\nNAMESPACE NAME    ROLE ARN\ndefault   s3-reader &lt;IAM ROLE ARN&gt;\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cdiv class=\"highlight__panel js-actions-panel\"\u003E\n\u003Cdiv class=\"highlight__panel-action js-fullscreen-code-action\"\u003E\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"\u003E\u003Ctitle\u003EEnter fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"\u003E\u003Ctitle\u003EExit fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\n\n\u003Cul\u003E\n\u003Cli\u003ECheck the service account to verify \u003Ccode\u003Eeks.amazonaws.com\u002Frole-arn\u003C\u002Fcode\u003E annotation:\n\u003C\u002Fli\u003E\n\u003C\u002Ful\u003E\n\u003Cdiv class=\"highlight js-code-highlight\"\u003E\n\u003Cpre class=\"highlight shell\"\u003E\u003Ccode\u003Ekubectl get sa s3-reader \u003Cspan class=\"nt\"\u003E-oyaml\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cdiv class=\"highlight__panel js-actions-panel\"\u003E\n\u003Cdiv class=\"highlight__panel-action js-fullscreen-code-action\"\u003E\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"\u003E\u003Ctitle\u003EEnter fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"\u003E\u003Ctitle\u003EExit fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\n\n\n\u003Cdiv class=\"highlight js-code-highlight\"\u003E\n\u003Cpre class=\"highlight yaml\"\u003E\u003Ccode\u003E\u003Cspan class=\"na\"\u003EapiVersion\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003Ev1\u003C\u002Fspan\u003E\n\u003Cspan class=\"na\"\u003Ekind\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003EServiceAccount\u003C\u002Fspan\u003E\n\u003Cspan class=\"na\"\u003Emetadata\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E\n  \u003Cspan class=\"na\"\u003Eannotations\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E\n    \u003Cspan class=\"s\"\u003Eeks.amazonaws.com\u002Frole-arn\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003E&lt;IAM ROLE ARN&gt;\u003C\u002Fspan\u003E\n  \u003Cspan class=\"na\"\u003Elabels\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E\n    \u003Cspan class=\"s\"\u003Eapp.kubernetes.io\u002Fmanaged-by\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003Eeksctl\u003C\u002Fspan\u003E\n  \u003Cspan class=\"na\"\u003Ename\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003Es3-reader\u003C\u002Fspan\u003E\n  \u003Cspan class=\"na\"\u003Enamespace\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003Edefault\u003C\u002Fspan\u003E\n\u003Cspan class=\"na\"\u003Esecrets\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E\n\u003Cspan class=\"pi\"\u003E-\u003C\u002Fspan\u003E \u003Cspan class=\"na\"\u003Ename\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003Es3-reader-token-5hnn7\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cdiv class=\"highlight__panel js-actions-panel\"\u003E\n\u003Cdiv class=\"highlight__panel-action js-fullscreen-code-action\"\u003E\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"\u003E\u003Ctitle\u003EEnter fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"\u003E\u003Ctitle\u003EExit fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\n\n\u003Cp\u003Ewe can see that \u003Ccode\u003Eeksctl\u003C\u002Fcode\u003E has created the IAM role, service account and automatically added the annotation to the service account.\u003C\u002Fp\u003E\n\n\u003Cul\u003E\n\u003Cli\u003ESince \u003Ccode\u003Eeksctl\u003C\u002Fcode\u003E doesn't support all the annotations, let's add them manually:\n\u003C\u002Fli\u003E\n\u003C\u002Ful\u003E\n\u003Cdiv class=\"highlight js-code-highlight\"\u003E\n\u003Cpre class=\"highlight shell\"\u003E\u003Ccode\u003Ekubectl annotate \u003Cspan class=\"se\"\u003E\\\u003C\u002Fspan\u003E\n  sa s3-reader \u003Cspan class=\"se\"\u003E\\\u003C\u002Fspan\u003E\n    \u003Cspan class=\"s2\"\u003E\"eks.amazonaws.com\u002Faudience=test\"\u003C\u002Fspan\u003E \u003Cspan class=\"se\"\u003E\\\u003C\u002Fspan\u003E\n    \u003Cspan class=\"s2\"\u003E\"eks.amazonaws.com\u002Ftoken-expiration=43200\"\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cdiv class=\"highlight__panel js-actions-panel\"\u003E\n\u003Cdiv class=\"highlight__panel-action js-fullscreen-code-action\"\u003E\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"\u003E\u003Ctitle\u003EEnter fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"\u003E\u003Ctitle\u003EExit fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\n\n\u003Cp\u003E\u003Cstrong\u003ENote:\u003C\u002Fstrong\u003E As of \u003Ccode\u003EEKS v1.21\u003C\u002Fcode\u003E, \u003Ccode\u003Eeks.amazonaws.com\u002Fsts-regional-endpoints\u003C\u002Fcode\u003E annotation doesn't work due to this issue.\u003C\u002Fp\u003E\n\n\n\u003Cdiv class=\"ltag_github-liquid-tag\"\u003E\n  \u003Ch1\u003E\n    \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Faws\u002Famazon-eks-pod-identity-webhook\u002Fissues\u002F110\"\u003E\n      \u003Cimg class=\"github-logo\" alt=\"GitHub logo\" src=\"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--i3JOwpme--\u002Fc_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880\u002Fhttps:\u002F\u002Fdev.to\u002Fassets\u002Fgithub-logo-ba8488d21cd8ee1fee097b8410db9deaa41d0ca30b004c0c63de0a479114156f.svg\" loading=\"lazy\"\u003E\n      \u003Cspan class=\"issue-title\"\u003E\n        eks.amazonaws.com\u002Fsts-regional-endpoints has no effect\n      \u003C\u002Fspan\u003E\n      \u003Cspan class=\"issue-number\"\u003E#110\u003C\u002Fspan\u003E\n    \u003C\u002Fa\u003E\n  \u003C\u002Fh1\u003E\n  \u003Cdiv class=\"github-thread\"\u003E\n    \u003Cdiv class=\"timeline-comment-header\"\u003E\n      \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Farunvelsriram\"\u003E\n        \u003Cimg class=\"github-liquid-tag-img\" src=\"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--q4D3WthY--\u002Fc_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880\u002Fhttps:\u002F\u002Favatars.githubusercontent.com\u002Fu\u002F6568319%3Fv%3D4\" alt=\"arunvelsriram avatar\" loading=\"lazy\"\u003E\n      \u003C\u002Fa\u003E\n      \u003Cdiv class=\"timeline-comment-header-text\"\u003E\n        \u003Cstrong\u003E\n          \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Farunvelsriram\"\u003Earunvelsriram\u003C\u002Fa\u003E\n        \u003C\u002Fstrong\u003E posted on \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Faws\u002Famazon-eks-pod-identity-webhook\u002Fissues\u002F110\"\u003E\u003Ctime datetime=\"2021-03-19T17:10:31Z\"\u003EMar 19, 2021\u003C\u002Ftime\u003E\u003C\u002Fa\u003E\n      \u003C\u002Fdiv\u003E\n    \u003C\u002Fdiv\u003E\n    \u003Cdiv class=\"ltag-github-body\"\u003E\n      \n\u003Cp\u003E\u003Cstrong\u003EWhat happened\u003C\u002Fstrong\u003E:\u003C\u002Fp\u003E\n\u003Cp\u003E\u003Ccode\u003Eeks.amazonaws.com\u002Fsts-regional-endpoints: \"true\"\u003C\u002Fcode\u003E annotation is not injecting \u003Ccode\u003EAWS_STS_REGIONAL_ENDPOINTS=regional\u003C\u002Fcode\u003E to the Pods.\u003C\u002Fp\u003E\n\u003Cp\u003E\u003Cstrong\u003EWhat you expected to happen\u003C\u002Fstrong\u003E:\u003C\u002Fp\u003E\n\u003Cp\u003E\u003Ccode\u003EAWS_STS_REGIONAL_ENDPOINTS=regional\u003C\u002Fcode\u003E is injected in to the Pods.\u003C\u002Fp\u003E\n\u003Cp\u003E\u003Cstrong\u003EHow to reproduce it (as minimally and precisely as possible)\u003C\u002Fstrong\u003E:\u003C\u002Fp\u003E\n\u003Col\u003E\n\u003Cli\u003ECreate a serviceaccount as mentioned in the README with annotation \u003Ccode\u003Eeks.amazonaws.com\u002Fsts-regional-endpoints: \"true\"\u003C\u002Fcode\u003E\n\u003C\u002Fli\u003E\n\u003Cli\u003ECreate a Pod, using that serviceaccount\u003C\u002Fli\u003E\n\u003C\u002Fol\u003E\n\u003Cp\u003E\u003Cstrong\u003EAnything else we need to know?\u003C\u002Fstrong\u003E:\u003C\u002Fp\u003E\n\u003Cp\u003EI noticed that in the README there are two versions of the annotation:\u003C\u002Fp\u003E\n\u003Cul\u003E\n\u003Cli\u003E\n\u003Ccode\u003Eeks.amazonaws.com\u002Fsts-regional-endpoints: \"true\"\u003C\u002Fcode\u003E - \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Faws\u002Famazon-eks-pod-identity-webhook\u002Fblob\u002Fmaster\u002FREADME.md#eks-walkthrough\"\u003Ehttps:\u002F\u002Fgithub.com\u002Faws\u002Famazon-eks-pod-identity-webhook\u002Fblob\u002Fmaster\u002FREADME.md#eks-walkthrough\u003C\u002Fa\u003E\n\u003C\u002Fli\u003E\n\u003Cli\u003E\n\u003Ccode\u003Eeks.amazonaws.com\u002Fsts-regional-endpoint: \"true\"\u003C\u002Fcode\u003E - \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Faws\u002Famazon-eks-pod-identity-webhook\u002Fblob\u002Fmaster\u002FREADME.md#aws_sts_regional_endpoints-injection\"\u003Ehttps:\u002F\u002Fgithub.com\u002Faws\u002Famazon-eks-pod-identity-webhook\u002Fblob\u002Fmaster\u002FREADME.md#aws_sts_regional_endpoints-injection\u003C\u002Fa\u003E\n\u003C\u002Fli\u003E\n\u003C\u002Ful\u003E\n\u003Cp\u003EWhich one is correct?\u003C\u002Fp\u003E\n\u003Cp\u003E\u003Cstrong\u003EEnvironment\u003C\u002Fstrong\u003E:\u003C\u002Fp\u003E\n\u003Cul\u003E\n\u003Cli\u003EAWS Region: ap-south-1\u003C\u002Fli\u003E\n\u003Cli\u003EEKS Platform version (if using EKS, run \u003Ccode\u003Eaws eks describe-cluster --name &lt;name&gt; --query cluster.platformVersion\u003C\u002Fcode\u003E): eks.1\u003C\u002Fli\u003E\n\u003Cli\u003EKubernetes version (if using EKS, run \u003Ccode\u003Eaws eks describe-cluster --name &lt;name&gt; --query cluster.version\u003C\u002Fcode\u003E): 1.19\u003C\u002Fli\u003E\n\u003Cli\u003EWebhook Version: Am using AWS EKS, so not sure how to find the version\u003C\u002Fli\u003E\n\u003C\u002Ful\u003E\n\n\n    \u003C\u002Fdiv\u003E\n    \u003Cdiv class=\"gh-btn-container\"\u003E\u003Ca class=\"gh-btn\" href=\"https:\u002F\u002Fgithub.com\u002Faws\u002Famazon-eks-pod-identity-webhook\u002Fissues\u002F110\"\u003EView on GitHub\u003C\u002Fa\u003E\u003C\u002Fdiv\u003E\n  \u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\n\n\n\u003Cp\u003EBy default \u003Ccode\u003Eeks.amazonaws.com\u002Faudience\u003C\u002Fcode\u003E is set to \u003Ccode\u003Ests.amazonaws.com\u003C\u002Fcode\u003E but we can set it to any value. To allow a different value for \u003Ccode\u003Eaudience\u003C\u002Fcode\u003E, we have to add this value in the \u003Ccode\u003EAudiences\u003C\u002Fcode\u003E section of the \u003Ccode\u003EOIDC Provider\u003C\u002Fcode\u003E and update the \u003Ccode\u003Etrust policy\u003C\u002Fcode\u003E of the IAM Role to allow this audience.\u003C\u002Fp\u003E\n\n\u003Cul\u003E\n\u003Cli\u003E Go to \u003Ca href=\"https:\u002F\u002Fconsole.aws.amazon.com\u002Fiamv2\u002Fhome\"\u003EIAM Console\u003C\u002Fa\u003E, click on \u003Ccode\u003EIdentity Providers\u003C\u002Fcode\u003E and add the audience to the \u003Ccode\u003EOIDC Identity provider\u003C\u002Fcode\u003E:\u003C\u002Fli\u003E\n\u003C\u002Ful\u003E\n\n\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--5FQkBkuW--\u002Fc_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880\u002Fhttps:\u002F\u002Fdev-to-uploads.s3.amazonaws.com\u002Fuploads\u002Farticles\u002F1dwuj8anj8r01yrc8495.png\" class=\"article-body-image-wrapper\"\u003E\u003Cimg src=\"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--5FQkBkuW--\u002Fc_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880\u002Fhttps:\u002F\u002Fdev-to-uploads.s3.amazonaws.com\u002Fuploads\u002Farticles\u002F1dwuj8anj8r01yrc8495.png\" alt=\"oidc-audience\" loading=\"lazy\"\u003E\u003C\u002Fa\u003E\u003C\u002Fp\u003E\n\n\u003Cul\u003E\n\u003Cli\u003EModify the trust policy of the IAM Role used with the service account to add this \u003Ccode\u003Eaudience\u003C\u002Fcode\u003E :\n\u003C\u002Fli\u003E\n\u003C\u002Ful\u003E\n\n\u003Cdiv class=\"highlight js-code-highlight\"\u003E\n\u003Cpre class=\"highlight json\"\u003E\u003Ccode\u003E\u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n  \u003C\u002Fspan\u003E\u003Cspan class=\"nl\"\u003E\"Version\"\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E \u003C\u002Fspan\u003E\u003Cspan class=\"s2\"\u003E\"2012-10-17\"\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n  \u003C\u002Fspan\u003E\u003Cspan class=\"nl\"\u003E\"Statement\"\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E \u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n    \u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n      \u003C\u002Fspan\u003E\u003Cspan class=\"nl\"\u003E\"Effect\"\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E \u003C\u002Fspan\u003E\u003Cspan class=\"s2\"\u003E\"Allow\"\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n      \u003C\u002Fspan\u003E\u003Cspan class=\"nl\"\u003E\"Principal\"\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E \u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n        \u003C\u002Fspan\u003E\u003Cspan class=\"nl\"\u003E\"Federated\"\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E \u003C\u002Fspan\u003E\u003Cspan class=\"s2\"\u003E\"arn:aws:iam::&lt;AWS_ACCOUNT_ID&gt;:oidc-provider\u002Foidc.eks.&lt;REGION&gt;.amazonaws.com\u002Fid\u002F&lt;CLUSTER_ID&gt;\"\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n      \u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E},\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n      \u003C\u002Fspan\u003E\u003Cspan class=\"nl\"\u003E\"Action\"\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E \u003C\u002Fspan\u003E\u003Cspan class=\"s2\"\u003E\"sts:AssumeRoleWithWebIdentity\"\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n      \u003C\u002Fspan\u003E\u003Cspan class=\"nl\"\u003E\"Condition\"\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E \u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n        \u003C\u002Fspan\u003E\u003Cspan class=\"nl\"\u003E\"StringEquals\"\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E \u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n          \u003C\u002Fspan\u003E\u003Cspan class=\"nl\"\u003E\"oidc.eks.&lt;REGION&gt;.amazonaws.com\u002Fid\u002F&lt;CLUSTER_ID&gt;:sub\"\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E \u003C\u002Fspan\u003E\u003Cspan class=\"s2\"\u003E\"system:serviceaccount:default:s3-reader\"\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n        \u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E},\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n        \u003C\u002Fspan\u003E\u003Cspan class=\"nl\"\u003E\"oidc.eks.us-east-1.amazonaws.com\u002Fid\u002F&lt;CLUSTER_ID&gt;:aud\"\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E \u003C\u002Fspan\u003E\u003Cspan class=\"s2\"\u003E\"test\"\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n      \u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E}\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n    \u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E}\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n  \u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E]\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E}\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cdiv class=\"highlight__panel js-actions-panel\"\u003E\n\u003Cdiv class=\"highlight__panel-action js-fullscreen-code-action\"\u003E\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"\u003E\u003Ctitle\u003EEnter fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"\u003E\u003Ctitle\u003EExit fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\n\n\n\u003Cul\u003E\n\u003Cli\u003ECreate a pod to test the IAM permissions:\n\u003C\u002Fli\u003E\n\u003C\u002Ful\u003E\n\n\u003Cdiv class=\"highlight js-code-highlight\"\u003E\n\u003Cpre class=\"highlight yaml\"\u003E\u003Ccode\u003E\u003Cspan class=\"na\"\u003EapiVersion\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003Ev1\u003C\u002Fspan\u003E\n\u003Cspan class=\"na\"\u003Ekind\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003EPod\u003C\u002Fspan\u003E\n\u003Cspan class=\"na\"\u003Emetadata\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E\n  \u003Cspan class=\"na\"\u003Ename\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003Eiam-test\u003C\u002Fspan\u003E\n  \u003Cspan class=\"na\"\u003Eannotations\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E\n    \u003Cspan class=\"c1\"\u003E# Skip injecting credentials to the sidecar container.\u003C\u002Fspan\u003E\n    \u003Cspan class=\"s\"\u003Eeks.amazonaws.com\u002Fskip-containers\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s2\"\u003E\"\u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003Esidecar-busybox-container\"\u003C\u002Fspan\u003E\n\u003Cspan class=\"na\"\u003Espec\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E\n  \u003Cspan class=\"na\"\u003EserviceAccountName\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003Es3-reader\u003C\u002Fspan\u003E\n  \u003Cspan class=\"na\"\u003Econtainers\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E\n  \u003Cspan class=\"pi\"\u003E-\u003C\u002Fspan\u003E \u003Cspan class=\"na\"\u003Ename\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003Eiam-test\u003C\u002Fspan\u003E\n    \u003Cspan class=\"na\"\u003Eimage\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003Eamazon\u002Faws-cli\u003C\u002Fspan\u003E\n    \u003Cspan class=\"na\"\u003Eargs\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"pi\"\u003E[\u003C\u002Fspan\u003E \u003Cspan class=\"s2\"\u003E\"\u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003Ests\"\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"s2\"\u003E\"\u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003Eget-caller-identity\"\u003C\u002Fspan\u003E \u003Cspan class=\"pi\"\u003E]\u003C\u002Fspan\u003E\n\n  \u003Cspan class=\"pi\"\u003E-\u003C\u002Fspan\u003E \u003Cspan class=\"na\"\u003Ename\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003Esidecar-busybox-container\u003C\u002Fspan\u003E\n    \u003Cspan class=\"na\"\u003Eimage\u003C\u002Fspan\u003E\u003Cspan class=\"pi\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003Eradial\u002Fbusyboxplus:curl\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cdiv class=\"highlight__panel js-actions-panel\"\u003E\n\u003Cdiv class=\"highlight__panel-action js-fullscreen-code-action\"\u003E\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"\u003E\u003Ctitle\u003EEnter fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"\u003E\u003Ctitle\u003EExit fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\n\n\n\n\n\u003Cdiv class=\"highlight js-code-highlight\"\u003E\n\u003Cpre class=\"highlight shell\"\u003E\u003Ccode\u003Ekubectl apply \u003Cspan class=\"nt\"\u003E-f\u003C\u002Fspan\u003E iam-test.yaml\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cdiv class=\"highlight__panel js-actions-panel\"\u003E\n\u003Cdiv class=\"highlight__panel-action js-fullscreen-code-action\"\u003E\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"\u003E\u003Ctitle\u003EEnter fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"\u003E\u003Ctitle\u003EExit fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\n\n\n\u003Cul\u003E\n\u003Cli\u003EOnce the pod is ready, check the environment variables in the pod:\n\u003C\u002Fli\u003E\n\u003C\u002Ful\u003E\n\n\u003Cdiv class=\"highlight js-code-highlight\"\u003E\n\u003Cpre class=\"highlight shell\"\u003E\u003Ccode\u003Ekubectl get pods iam-test \u003Cspan class=\"nt\"\u003E-ojson\u003C\u002Fspan\u003E|jq \u003Cspan class=\"nt\"\u003E-r\u003C\u002Fspan\u003E \u003Cspan class=\"s1\"\u003E'.spec.containers[0].env'\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cdiv class=\"highlight__panel js-actions-panel\"\u003E\n\u003Cdiv class=\"highlight__panel-action js-fullscreen-code-action\"\u003E\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"\u003E\u003Ctitle\u003EEnter fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"\u003E\u003Ctitle\u003EExit fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\n\n\n\n\n\u003Cdiv class=\"highlight js-code-highlight\"\u003E\n\u003Cpre class=\"highlight json\"\u003E\u003Ccode\u003E\u003Cspan class=\"p\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n  \u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n    \u003C\u002Fspan\u003E\u003Cspan class=\"nl\"\u003E\"name\"\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E \u003C\u002Fspan\u003E\u003Cspan class=\"s2\"\u003E\"AWS_DEFAULT_REGION\"\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n    \u003C\u002Fspan\u003E\u003Cspan class=\"nl\"\u003E\"value\"\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E \u003C\u002Fspan\u003E\u003Cspan class=\"s2\"\u003E\"us-east-1\"\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n  \u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E},\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n  \u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n    \u003C\u002Fspan\u003E\u003Cspan class=\"nl\"\u003E\"name\"\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E \u003C\u002Fspan\u003E\u003Cspan class=\"s2\"\u003E\"AWS_REGION\"\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n    \u003C\u002Fspan\u003E\u003Cspan class=\"nl\"\u003E\"value\"\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E \u003C\u002Fspan\u003E\u003Cspan class=\"s2\"\u003E\"us-east-1\"\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n  \u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E},\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n  \u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n    \u003C\u002Fspan\u003E\u003Cspan class=\"nl\"\u003E\"name\"\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E \u003C\u002Fspan\u003E\u003Cspan class=\"s2\"\u003E\"AWS_ROLE_ARN\"\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n    \u003C\u002Fspan\u003E\u003Cspan class=\"nl\"\u003E\"value\"\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E \u003C\u002Fspan\u003E\u003Cspan class=\"s2\"\u003E\"&lt;IAM ROLE ARN&gt;\"\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n  \u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E},\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n  \u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n    \u003C\u002Fspan\u003E\u003Cspan class=\"nl\"\u003E\"name\"\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E \u003C\u002Fspan\u003E\u003Cspan class=\"s2\"\u003E\"AWS_WEB_IDENTITY_TOKEN_FILE\"\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n    \u003C\u002Fspan\u003E\u003Cspan class=\"nl\"\u003E\"value\"\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E \u003C\u002Fspan\u003E\u003Cspan class=\"s2\"\u003E\"\u002Fvar\u002Frun\u002Fsecrets\u002Feks.amazonaws.com\u002Fserviceaccount\u002Ftoken\"\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n  \u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E}\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E]\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cdiv class=\"highlight__panel js-actions-panel\"\u003E\n\u003Cdiv class=\"highlight__panel-action js-fullscreen-code-action\"\u003E\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"\u003E\u003Ctitle\u003EEnter fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"\u003E\u003Ctitle\u003EExit fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\n\n\n\u003Cul\u003E\n\u003Cli\u003ECheck the \u003Ccode\u003Eaws-iam-token volume\u003C\u002Fcode\u003E in the pod:\n\u003C\u002Fli\u003E\n\u003C\u002Ful\u003E\n\n\u003Cdiv class=\"highlight js-code-highlight\"\u003E\n\u003Cpre class=\"highlight shell\"\u003E\u003Ccode\u003Ekubectl get pods iam-test \u003Cspan class=\"nt\"\u003E-ojson\u003C\u002Fspan\u003E|jq \u003Cspan class=\"nt\"\u003E-r\u003C\u002Fspan\u003E \u003Cspan class=\"s1\"\u003E'.spec.volumes[]| select(.name==\"aws-iam-token\")'\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cdiv class=\"highlight__panel js-actions-panel\"\u003E\n\u003Cdiv class=\"highlight__panel-action js-fullscreen-code-action\"\u003E\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"\u003E\u003Ctitle\u003EEnter fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"\u003E\u003Ctitle\u003EExit fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\n\n\n\n\n\u003Cdiv class=\"highlight js-code-highlight\"\u003E\n\u003Cpre class=\"highlight json\"\u003E\u003Ccode\u003E\u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n  \u003C\u002Fspan\u003E\u003Cspan class=\"nl\"\u003E\"name\"\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E \u003C\u002Fspan\u003E\u003Cspan class=\"s2\"\u003E\"aws-iam-token\"\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n  \u003C\u002Fspan\u003E\u003Cspan class=\"nl\"\u003E\"projected\"\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E \u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n    \u003C\u002Fspan\u003E\u003Cspan class=\"nl\"\u003E\"defaultMode\"\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E \u003C\u002Fspan\u003E\u003Cspan class=\"mi\"\u003E420\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n    \u003C\u002Fspan\u003E\u003Cspan class=\"nl\"\u003E\"sources\"\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E \u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n      \u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n        \u003C\u002Fspan\u003E\u003Cspan class=\"nl\"\u003E\"serviceAccountToken\"\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E \u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n          \u003C\u002Fspan\u003E\u003Cspan class=\"nl\"\u003E\"audience\"\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E \u003C\u002Fspan\u003E\u003Cspan class=\"s2\"\u003E\"test\"\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n          \u003C\u002Fspan\u003E\u003Cspan class=\"nl\"\u003E\"expirationSeconds\"\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E \u003C\u002Fspan\u003E\u003Cspan class=\"mi\"\u003E43200\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n          \u003C\u002Fspan\u003E\u003Cspan class=\"nl\"\u003E\"path\"\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E \u003C\u002Fspan\u003E\u003Cspan class=\"s2\"\u003E\"token\"\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n        \u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E}\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n      \u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E}\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n    \u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E]\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n  \u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E}\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E}\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cdiv class=\"highlight__panel js-actions-panel\"\u003E\n\u003Cdiv class=\"highlight__panel-action js-fullscreen-code-action\"\u003E\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"\u003E\u003Ctitle\u003EEnter fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"\u003E\u003Ctitle\u003EExit fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\n\n\n\u003Cp\u003Ewe can see that \u003Ccode\u003EexpirationSeconds\u003C\u002Fcode\u003E is \u003Ccode\u003E43200\u003C\u002Fcode\u003E as specified in the annotation \u003Ccode\u003Eeks.amazonaws.com\u002Ftoken-expiration\u003C\u002Fcode\u003E.\u003C\u002Fp\u003E\n\n\u003Cul\u003E\n\u003Cli\u003ECheck the \u003Ccode\u003EvolumeMounts\u003C\u002Fcode\u003E in the pod:\n\u003C\u002Fli\u003E\n\u003C\u002Ful\u003E\n\n\u003Cdiv class=\"highlight js-code-highlight\"\u003E\n\u003Cpre class=\"highlight shell\"\u003E\u003Ccode\u003Ekubectl get pods iam-test \u003Cspan class=\"nt\"\u003E-ojson\u003C\u002Fspan\u003E|jq \u003Cspan class=\"nt\"\u003E-r\u003C\u002Fspan\u003E \u003Cspan class=\"s1\"\u003E'.spec.containers[0].volumeMounts'\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cdiv class=\"highlight__panel js-actions-panel\"\u003E\n\u003Cdiv class=\"highlight__panel-action js-fullscreen-code-action\"\u003E\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"\u003E\u003Ctitle\u003EEnter fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"\u003E\u003Ctitle\u003EExit fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\n\n\n\n\n\u003Cdiv class=\"highlight js-code-highlight\"\u003E\n\u003Cpre class=\"highlight json\"\u003E\u003Ccode\u003E\u003Cspan class=\"p\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n  \u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n    \u003C\u002Fspan\u003E\u003Cspan class=\"nl\"\u003E\"mountPath\"\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E \u003C\u002Fspan\u003E\u003Cspan class=\"s2\"\u003E\"\u002Fvar\u002Frun\u002Fsecrets\u002Fkubernetes.io\u002Fserviceaccount\"\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n    \u003C\u002Fspan\u003E\u003Cspan class=\"nl\"\u003E\"name\"\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E \u003C\u002Fspan\u003E\u003Cspan class=\"s2\"\u003E\"kube-api-access-xjjqv\"\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n    \u003C\u002Fspan\u003E\u003Cspan class=\"nl\"\u003E\"readOnly\"\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E \u003C\u002Fspan\u003E\u003Cspan class=\"kc\"\u003Etrue\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n  \u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E},\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n  \u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n    \u003C\u002Fspan\u003E\u003Cspan class=\"nl\"\u003E\"mountPath\"\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E \u003C\u002Fspan\u003E\u003Cspan class=\"s2\"\u003E\"\u002Fvar\u002Frun\u002Fsecrets\u002Feks.amazonaws.com\u002Fserviceaccount\"\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n    \u003C\u002Fspan\u003E\u003Cspan class=\"nl\"\u003E\"name\"\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E \u003C\u002Fspan\u003E\u003Cspan class=\"s2\"\u003E\"aws-iam-token\"\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n    \u003C\u002Fspan\u003E\u003Cspan class=\"nl\"\u003E\"readOnly\"\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E \u003C\u002Fspan\u003E\u003Cspan class=\"kc\"\u003Etrue\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n  \u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E}\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E]\u003C\u002Fspan\u003E\u003Cspan class=\"w\"\u003E\n\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cdiv class=\"highlight__panel js-actions-panel\"\u003E\n\u003Cdiv class=\"highlight__panel-action js-fullscreen-code-action\"\u003E\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"\u003E\u003Ctitle\u003EEnter fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"\u003E\u003Ctitle\u003EExit fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\n\n\n\u003Cul\u003E\n\u003Cli\u003ECheck the logs of the pod \u003Ccode\u003Eiam-test\u003C\u002Fcode\u003E to see the role assumed by the pod:\n\u003C\u002Fli\u003E\n\u003C\u002Ful\u003E\n\n\u003Cdiv class=\"highlight js-code-highlight\"\u003E\n\u003Cpre class=\"highlight shell\"\u003E\u003Ccode\u003Ekubectl logs iam-test \u003Cspan class=\"nt\"\u003E-c\u003C\u002Fspan\u003E iam-test\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cdiv class=\"highlight__panel js-actions-panel\"\u003E\n\u003Cdiv class=\"highlight__panel-action js-fullscreen-code-action\"\u003E\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"\u003E\u003Ctitle\u003EEnter fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"\u003E\u003Ctitle\u003EExit fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\n\n\n",body_markdown:"![aws-eks-iam](https:\u002F\u002Fdev-to-uploads.s3.amazonaws.com\u002Fuploads\u002Farticles\u002Fvai1pgujygh2h9vxoz0g.png)\n\nAmazon EKS cluster consists of [Managed NodeGroups](https:\u002F\u002Fdocs.aws.amazon.com\u002Feks\u002Flatest\u002Fuserguide\u002Fmanaged-node-groups.html), [Self Managed NodeGroups](https:\u002F\u002Fdocs.aws.amazon.com\u002Feks\u002Flatest\u002Fuserguide\u002Fworker.html) and [Fargate profiles](https:\u002F\u002Fdocs.aws.amazon.com\u002Feks\u002Flatest\u002Fuserguide\u002Ffargate-profile.html). NodeGroups are autoscaling groups behind the scene, while Fargate is serverless and creates one fargate node per pod.\n\nIAM permissions in EKS can be defined in two ways:\n1. IAM Role for NodeGroups\n2. IAM role for Service Accounts(IRSA)\n\n\n## IAM Role for NodeGroups\nWhenever we create an EKS cluster using `eksctl` with node groups like below :\n\n```yaml\napiVersion: eksctl.io\u002Fv1alpha5\nkind: ClusterConfig\n\nmetadata:\n  name: monitoring-cluster\n  region: us-east-1\n  version: \"1.21\"\n\navailabilityZones: \n  - us-east-1a\n  - us-east-1b\n  - us-east-1c\n\nmanagedNodeGroups:\n  - name: managed-ng-1\n    instanceType: t3a.medium\n```\n\n`eksctl` automatically creates an IAM role with minimum IAM permissions required for the cluster to work and attaches it to the nodes part of the node group. All the pods running on these nodes inherit these permissions.\n\nThis role has 3 IAM policies attached that give basic access to the node :\n\n1. `AmazonEKSWorkerNodePolicy` - This policy allows EKS worker nodes to connect to EKS clusters.\n2. `AmazonEC2ContainerRegistryReadOnly` - This policy gives read-only access to ECR.\n3. `AmazonEKS_CNI_Policy` - This policy is required for [amazon-vpc-cni](https:\u002F\u002Fgithub.com\u002Faws\u002Famazon-vpc-cni-k8s#setup) plugin to function properly on nodes which is deployed as part of `aws-node` daemonset in `kube-system` namespace.\n\nThese permissions may not be enough if you are running workloads that require various other IAM permissions. `eksctl` provides several ways to define additional permissions for the Node.\n\n\n### Attach IAM Policies using ARN to the Node Group.\n\n`eksctl` allows you to attach IAM policies to a node group using `attachPolicyARNs`. \n\n\n```yaml\nmanagedNodeGroups:\n  - name: managed-ng-1\n    iam:\n      attachPolicyARNs:\n      # Mandatory IAM Policies for NodeGroup.\n      - arn:aws:iam::aws:policy\u002FAmazonEKSWorkerNodePolicy\n      - arn:aws:iam::aws:policy\u002FAmazonEKS_CNI_Policy\n      - arn:aws:iam::aws:policy\u002FAmazonEC2ContainerRegistryReadOnly\n\n      # AWS Managed or Customer Managed IAM Policy ARN.\n      - arn:aws:iam::aws:policy\u002FAmazonS3FullAccess\n```\n\nPlease note that while specifying IAM policy ARNs using `attachPolicyARNs`, it's mandatory to include the above 3 IAM policies as they are required for the node to function properly.\n\nIf you missed specifying these 3 IAM policies, you will get an error like this :\n\n```bash\nAWS::EKS::Nodegroup\u002FManagedNodeGroup: CREATE_FAILED – \"The provided role doesn't have the Amazon EKS Managed Policies associated with it. Please ensure the following policies [arn:aws:iam::aws:policy\u002FAmazonEKSWorkerNodePolicy, arn:aws:iam::aws:policy\u002FAmazonEC2ContainerRegistryReadOnly] are attached \"\n```\n\n### Attach IAM Role and Instance Profile to the Node Group\n\nIf you have an existing `IAM Role` and `Instance Profile`, then you can define that for a node group :\n\n```yaml\nmanagedNodeGroups:\n  - name: managed-ng-1\n    iam:\n      instanceProfileARN: \"\u003CInstance Profile ARN\u003E\"\n      instanceRoleARN: \"\u003CIAM Role ARN\u003E\"\n```\n\n### Attach Addons IAM Policy\n\n`eksctl` provides out-of-box IAM policies for the cluster add-ons such as `cluster autoscaler`, `external DNS`, `cert-manager`.\n\n```yaml\nmanagedNodeGroups:\n  - name: managed-ng-1\n    iam:\n      withAddonPolicies:\n        imageBuilder: true\n        autoScaler: true\n        externalDNS: true\n        certManager: true\n        appMesh: true\n        ebs: true\n        fsx: true\n        efs: true\n        albIngress: true\n        xRay: true\n        cloudWatch: true\n```\n\n1. `imageBuilder` - Full ECR access with `AmazonEC2ContainerRegistryPowerUser`.\n\n2. `autoScaler` - IAM policy for [Cluster Autoscaler](https:\u002F\u002Fgithub.com\u002Fkubernetes\u002Fautoscaler\u002Ftree\u002Fmaster\u002Fcluster-autoscaler\u002Fcloudprovider\u002Faws#iam-policy).\n\n3. `externalDNS` - IAM policy for [External DNS](https:\u002F\u002Fgithub.com\u002Fkubernetes-sigs\u002Fexternal-dns\u002Fblob\u002Fmaster\u002Fdocs\u002Ftutorials\u002Faws.md#iam-policy).\n\n4. `certManager` - IAM Policy for [Cert Manager](https:\u002F\u002Fcert-manager.io\u002Fdocs\u002Fconfiguration\u002Facme\u002Fdns01\u002Froute53\u002F#set-up-an-iam-role).\n\n5. `appMesh` - IAM policy for [AWS App Mesh](https:\u002F\u002Fgithub.com\u002Faws\u002Faws-app-mesh-controller-for-k8s\u002Fblob\u002Fmaster\u002Fconfig\u002Fiam\u002Fcontroller-iam-policy.json).\n\n6. `ebs` - IAM Policy for [AWS EBS CSI Driver](https:\u002F\u002Fgithub.com\u002Fkubernetes-sigs\u002Faws-ebs-csi-driver\u002Fblob\u002Fmaster\u002Fdocs\u002Fexample-iam-policy.json).\n\n7. `fsx` - IAM Policy for [AWS FSX Lustre](https:\u002F\u002Fgithub.com\u002Fkubernetes-sigs\u002Faws-fsx-csi-driver\u002Ftree\u002Fmaster\u002Fdocs#installation).\n\n8. `efs` - IAM Policy for [AWS EFS CSI Driver](https:\u002F\u002Fgithub.com\u002Fkubernetes-sigs\u002Faws-efs-csi-driver\u002Fblob\u002Fmaster\u002Fdocs\u002Fiam-policy-example.json).\n\n9. `albIngress` - IAM Policy for [ALB Ingress Controller](https:\u002F\u002Fgithub.com\u002Fkubernetes-sigs\u002Faws-load-balancer-controller\u002Fblob\u002Fmain\u002Fdocs\u002Finstall\u002Fiam_policy.json).\n\n10. `xRay` - IAM Policy `AWSXRayDaemonWriteAccess` for [AWS X-ray Daemon](https:\u002F\u002Fgithub.com\u002Faws\u002Faws-xray-daemon) \n\n11. `cloudWatch` - IAM Policy `CloudWatchAgentServerPolicy` for [AWS Cloudwatch Agent](https:\u002F\u002Fgithub.com\u002Faws\u002Famazon-cloudwatch-agent).\n\n\nWhile all the above options allow you to define IAM permissions for the node group, there is a problem with defining IAM permissions at the node level.\n\n![problem](https:\u002F\u002Fdev-to-uploads.s3.amazonaws.com\u002Fuploads\u002Farticles\u002Fot1yz308b4adguc5wcme.jpeg)\n\nAll the pods running on nodes part of the node group will have these permissions thus not adhering to the **principle of least privilege**. For example, if we attach `EC2 Admin` and `Cloudformation` permissions to the node group to run `CI server`, any other pods running on this node group will effectively inherit these permissions.\n\nOne way to overcome this problem is to create a separate node group for the CI server. ( Use [taints](https:\u002F\u002Fkubernetes.io\u002Fdocs\u002Fconcepts\u002Fscheduling-eviction\u002Ftaint-and-toleration\u002F#concepts) and [affinity](https:\u002F\u002Fkubernetes.io\u002Fdocs\u002Fconcepts\u002Fscheduling-eviction\u002Fassign-pod-node\u002F#node-affinity) to ensure only CI pods are deployed on this node group)\n\nHowever AWS access is not just required for CI servers, many applications use AWS services such as `S3`, `SQS`, and `KMS` and would require fine-grained IAM permissions. Creating one node group for every such application would not be an ideal solution and can lead to **maintenance issues**, **higher cost**, and **low resource consumption**.\n\n![solution](https:\u002F\u002Fdev-to-uploads.s3.amazonaws.com\u002Fuploads\u002Farticles\u002Fb1bzi3gm71dyrfkdfvji.jpeg)\n\n\n## IAM Roles for Service Accounts\n\nAmazon EKS supports `IAM Roles for Service Accounts (IRSA)` that allows us to map AWS IAM Roles to Kubernetes Service Accounts. With IRSA, instead of defining IAM permissions on the node, we can attach an **IAM role** to a **Kubernetes Service Account** and attach the service account to the **pod\u002Fdeployment**.\n\nIAM role is added to the Kubernetes service account by adding annotation `eks.amazonaws.com\u002Frole-arn` with value as the `IAM Role ARN`.\n\n```yaml\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: my-serviceaccount\n  annotations:\n    eks.amazonaws.com\u002Frole-arn: \"\u003CIAM Role ARN\u003E\"\n```\n\nEKS create a Mutating Admission Webhook [pod-identity-webhook](https:\u002F\u002Fgithub.com\u002Faws\u002Famazon-eks-pod-identity-webhook\u002F) and uses it to intercept the pod creation request and update the pod spec to include IAM credentials.\n\nCheck the [Mutating Admission Webhooks](https:\u002F\u002Fkubernetes.io\u002Fdocs\u002Freference\u002Faccess-authn-authz\u002Fadmission-controllers\u002F#mutatingadmissionwebhook) in the cluster:\n\n```bash\nkubectl get mutatingwebhookconfigurations.admissionregistration.k8s.io\n\nNAME                                             WEBHOOKS   AGE\n0500-amazon-eks-fargate-mutation.amazonaws.com   2          21m\npod-identity-webhook                             1          28m\nvpc-resource-mutating-webhook                    1          28m\n```\n\n`pod-identity-webhook` supports several configuration options:\n\n1. `eks.amazonaws.com\u002Frole-arn` - IAM Role ARN to attach to the service account.\n2. `eks.amazonaws.com\u002Faudience` - Intended autience of the [token](https:\u002F\u002Fkubernetes.io\u002Fdocs\u002Ftasks\u002Fconfigure-pod-container\u002Fconfigure-service-account\u002F#service-account-token-volume-projection), defaults to \"sts.amazonaws.com\" if not set.\n3. `eks.amazonaws.com\u002Fsts-regional-endpoints` - AWS STS is a global service, however, we can use regional STS endpoints to reduce latency. Set `true` to use regional STS endpoints.\n4. `eks.amazonaws.com\u002Ftoken-expiration` - AWS STS Token expiration duration, default is `86400 seconds` or `24 hours`. We can override this value by defining it at the `pod level`.\n5. `eks.amazonaws.com\u002Fskip-containers` - A comma-separated list of containers to skip adding volume and environment variables. `This annotation is only supported at the pod level.`\n\n\n```yaml\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: my-serviceaccount\n  annotations:\n    eks.amazonaws.com\u002Frole-arn: \"\u003CIAM Role ARN\u003E\"\n    eks.amazonaws.com\u002Faudience: \"sts.amazonaws.com\"\n    eks.amazonaws.com\u002Fsts-regional-endpoints: \"true\"\n    eks.amazonaws.com\u002Ftoken-expiration: \"86400\"\n```\n\n### How IRSA Works\n\nWhen you define the IAM role for a service account using `eks.amazonaws.com\u002Frole-arn` annotation and add this service account to the pod, `pod-identity-webhook` mutates the pod spec to add `environment variables` and [projected mount volumes](https:\u002F\u002Fkubernetes.io\u002Fdocs\u002Fconcepts\u002Fstorage\u002Fvolumes\u002F#projected).\n\nThese are the environment variables added by `pod-identity-webhook` in the pod spec:\n\n```yaml\n  env:\n    - name: AWS_DEFAULT_REGION\n      value: us-east-1\n    - name: AWS_REGION\n      value: us-east-1\n    - name: AWS_ROLE_ARN\n      value: \"\u003CIAM ROLE ARN\u003E\"\n    - name: AWS_WEB_IDENTITY_TOKEN_FILE\n      value: \"\u002Fvar\u002Frun\u002Fsecrets\u002Feks.amazonaws.com\u002Fserviceaccount\u002Ftoken\"\n```\n\n1. `AWS_DEFAULT_REGION` and `AWS_REGION` - Cluster Region \n\n2. `AWS_ROLE_ARN` - IAM Role ARN.\n\n3. `AWS_WEB_IDENTITY_TOKEN_FILE` - Path to the tokens file\n\n`pod-identity-webhook` also adds a projected volume for service account token:\n\n```yaml\n    volumeMounts:\n    - mountPath: \"\u002Fvar\u002Frun\u002Fsecrets\u002Feks.amazonaws.com\u002Fserviceaccount\"\n      name: aws-iam-token\n  volumes:\n  - name: aws-iam-token\n    projected:\n      sources:\n      - serviceAccountToken:\n          audience: \"sts.amazonaws.com\"\n          expirationSeconds: 86400\n          path: token\n```\n\na projected volume is created with the name `aws-iam-token` and mounted to the container at `\u002Fvar\u002Frun\u002Fsecrets\u002Feks.amazonaws.com\u002Fserviceaccount`.\n\n\n**Let's test it out.**\n\n* Create an EKS cluster with a Managed NodeGroup and an IAM service account `s3-reader` in the default namespace with `AmazonS3ReadOnlyAccess` IAM permissions :\n\n```yaml\napiVersion: eksctl.io\u002Fv1alpha5\nkind: ClusterConfig\nmetadata:\n  name: iam-cluster\n  region: us-east-1\n  version: \"1.21\"\navailabilityZones: \n  - us-east-1a\n  - us-east-1b\n  - us-east-1c\niam:\n  withOIDC: true\n  serviceAccounts:\n  - metadata:\n      name: s3-reader\n    attachPolicyARNs:\n    - \"arn:aws:iam::aws:policy\u002FAmazonS3ReadOnlyAccess\"\nmanagedNodeGroups:\n  - name: managed-ng-1\n    instanceType: t3a.medium\n    minSize: 1\n    maxSize: 4\n    desiredCapacity: 4\n```\n\n**Note:**  We can also attach IAM Role directly using `attachRoleARN`. However, the role should have below `trust policy` to allow the pods to use this role :\n\n```json\n{\n \"Version\": \"2012-10-17\",\n \"Statement\": [\n  {\n   \"Effect\": \"Allow\",\n   \"Principal\": {\n    \"Federated\": \"arn:aws:iam::\u003CAWS_ACCOUNT_ID\u003E:oidc-provider\u002Foidc.\u003CREGION\u003E.eks.amazonaws.com\u002F\u003CCLUSTER_ID\u003E\"\n   },\n   \"Action\": \"sts:AssumeRoleWithWebIdentity\",\n   \"Condition\": {\n    \"StringEquals\": {\n     \"oidc.\u003CREGION\u003E.eks.amazonaws.com\u002F\u003CCLUSTER_ID\u003E:sub\": \"system:serviceaccount:default:my-serviceaccount\"\n    },\n    \"StringLike\": {\n     \"oidc.\u003CREGION\u003E.eks.amazonaws.com\u002FCLUSTER_ID:sub\": \"system:serviceaccount:default:*\"\n    }\n   }\n  }\n ]\n}\n```\n\n* Check the role created by `eksctl` for service account `s3-reader`\n\n```bash\neksctl get iamserviceaccount s3-reader --cluster=iam-cluster --region=us-east-1\n2021-08-25 02:51:14 [ℹ]  eksctl version 0.61.0\n2021-08-25 02:51:14 [ℹ]  using region us-east-1\nNAMESPACE NAME    ROLE ARN\ndefault   s3-reader \u003CIAM ROLE ARN\u003E\n```\n\n* Check the service account to verify `eks.amazonaws.com\u002Frole-arn` annotation:\n\n```bash\nkubectl get sa s3-reader -oyaml\n```\n\n```yaml\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  annotations:\n    eks.amazonaws.com\u002Frole-arn: \u003CIAM ROLE ARN\u003E\n  labels:\n    app.kubernetes.io\u002Fmanaged-by: eksctl\n  name: s3-reader\n  namespace: default\nsecrets:\n- name: s3-reader-token-5hnn7\n```\n\nwe can see that `eksctl` has created the IAM role, service account and automatically added the annotation to the service account.\n\n* Since `eksctl` doesn't support all the annotations, let's add them manually:\n\n```bash\nkubectl annotate \\\n  sa s3-reader \\\n    \"eks.amazonaws.com\u002Faudience=test\" \\\n    \"eks.amazonaws.com\u002Ftoken-expiration=43200\"\n```\n\n**Note:** As of `EKS v1.21`, `eks.amazonaws.com\u002Fsts-regional-endpoints` annotation doesn't work due to this issue.\n\n{% github https:\u002F\u002Fgithub.com\u002Faws\u002Famazon-eks-pod-identity-webhook\u002Fissues\u002F110 %}\n\n\nBy default `eks.amazonaws.com\u002Faudience` is set to `sts.amazonaws.com` but we can set it to any value. To allow a different value for `audience`, we have to add this value in the `Audiences` section of the `OIDC Provider` and update the `trust policy` of the IAM Role to allow this audience.\n\n*  Go to [IAM Console](https:\u002F\u002Fconsole.aws.amazon.com\u002Fiamv2\u002Fhome), click on `Identity Providers` and add the audience to the `OIDC Identity provider`:\n\n![oidc-audience](https:\u002F\u002Fdev-to-uploads.s3.amazonaws.com\u002Fuploads\u002Farticles\u002F1dwuj8anj8r01yrc8495.png)\n\n* Modify the trust policy of the IAM Role used with the service account to add this `audience` :\n\n```json\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Effect\": \"Allow\",\n      \"Principal\": {\n        \"Federated\": \"arn:aws:iam::\u003CAWS_ACCOUNT_ID\u003E:oidc-provider\u002Foidc.eks.\u003CREGION\u003E.amazonaws.com\u002Fid\u002F\u003CCLUSTER_ID\u003E\"\n      },\n      \"Action\": \"sts:AssumeRoleWithWebIdentity\",\n      \"Condition\": {\n        \"StringEquals\": {\n          \"oidc.eks.\u003CREGION\u003E.amazonaws.com\u002Fid\u002F\u003CCLUSTER_ID\u003E:sub\": \"system:serviceaccount:default:s3-reader\"\n        },\n        \"oidc.eks.us-east-1.amazonaws.com\u002Fid\u002F\u003CCLUSTER_ID\u003E:aud\": \"test\"\n      }\n    }\n  ]\n}\n```\n\n* Create a pod to test the IAM permissions:\n\n```yaml\napiVersion: v1\nkind: Pod\nmetadata:\n  name: iam-test\n  annotations:\n    # Skip injecting credentials to the sidecar container.\n    eks.amazonaws.com\u002Fskip-containers: \"sidecar-busybox-container\"\nspec:\n  serviceAccountName: s3-reader\n  containers:\n  - name: iam-test\n    image: amazon\u002Faws-cli\n    args: [ \"sts\", \"get-caller-identity\" ]\n \n  - name: sidecar-busybox-container\n    image: radial\u002Fbusyboxplus:curl\n``` \n\n```bash\nkubectl apply -f iam-test.yaml\n```\n\n* Once the pod is ready, check the environment variables in the pod:\n\n```bash\nkubectl get pods iam-test -ojson|jq -r '.spec.containers[0].env'\n```\n\n```json\n[\n  {\n    \"name\": \"AWS_DEFAULT_REGION\",\n    \"value\": \"us-east-1\"\n  },\n  {\n    \"name\": \"AWS_REGION\",\n    \"value\": \"us-east-1\"\n  },\n  {\n    \"name\": \"AWS_ROLE_ARN\",\n    \"value\": \"\u003CIAM ROLE ARN\u003E\"\n  },\n  {\n    \"name\": \"AWS_WEB_IDENTITY_TOKEN_FILE\",\n    \"value\": \"\u002Fvar\u002Frun\u002Fsecrets\u002Feks.amazonaws.com\u002Fserviceaccount\u002Ftoken\"\n  }\n]\n```\n\n* Check the `aws-iam-token volume` in the pod:\n\n```bash\nkubectl get pods iam-test -ojson|jq -r '.spec.volumes[]| select(.name==\"aws-iam-token\")'\n```\n\n```json\n{\n  \"name\": \"aws-iam-token\",\n  \"projected\": {\n    \"defaultMode\": 420,\n    \"sources\": [\n      {\n        \"serviceAccountToken\": {\n          \"audience\": \"test\",\n          \"expirationSeconds\": 43200,\n          \"path\": \"token\"\n        }\n      }\n    ]\n  }\n}\n```\n\nwe can see that `expirationSeconds` is `43200` as specified in the annotation `eks.amazonaws.com\u002Ftoken-expiration`.\n\n* Check the `volumeMounts` in the pod:\n\n```bash\nkubectl get pods iam-test -ojson|jq -r '.spec.containers[0].volumeMounts'\n```\n\n```json\n[\n  {\n    \"mountPath\": \"\u002Fvar\u002Frun\u002Fsecrets\u002Fkubernetes.io\u002Fserviceaccount\",\n    \"name\": \"kube-api-access-xjjqv\",\n    \"readOnly\": true\n  },\n  {\n    \"mountPath\": \"\u002Fvar\u002Frun\u002Fsecrets\u002Feks.amazonaws.com\u002Fserviceaccount\",\n    \"name\": \"aws-iam-token\",\n    \"readOnly\": true\n  }\n]\n```\n\n* Check the logs of the pod `iam-test` to see the role assumed by the pod:\n\n```bash\nkubectl logs iam-test -c iam-test\n```\n",user:{name:"Shardul Srivastava",username:d,twitter_username:a,github_username:d,website_url:a,profile_image:"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--RdY5vBNI--\u002Fc_fill,f_auto,fl_progressive,h_640,q_auto,w_640\u002Fhttps:\u002F\u002Fdev-to-uploads.s3.amazonaws.com\u002Fuploads\u002Fuser\u002Fprofile_image\u002F497827\u002F8abb9931-172a-456f-8fa3-525618ac5c2d.jpeg",profile_image_90:"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--hOoqRh06--\u002Fc_fill,f_auto,fl_progressive,h_90,q_auto,w_90\u002Fhttps:\u002F\u002Fdev-to-uploads.s3.amazonaws.com\u002Fuploads\u002Fuser\u002Fprofile_image\u002F497827\u002F8abb9931-172a-456f-8fa3-525618ac5c2d.jpeg"},organization:{name:"AWS Community Builders ",username:e,slug:e,profile_image:"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--zmOZQNzv--\u002Fc_fill,f_auto,fl_progressive,h_640,q_auto,w_640\u002Fhttps:\u002F\u002Fdev-to-uploads.s3.amazonaws.com\u002Fuploads\u002Forganization\u002Fprofile_image\u002F2794\u002F88da75b6-aadd-4ea1-8083-ae2dfca8be94.png",profile_image_90:"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--vWmcJ-ty--\u002Fc_fill,f_auto,fl_progressive,h_90,q_auto,w_90\u002Fhttps:\u002F\u002Fdev-to-uploads.s3.amazonaws.com\u002Fuploads\u002Forganization\u002Fprofile_image\u002F2794\u002F88da75b6-aadd-4ea1-8083-ae2dfca8be94.png"}}},serverRendered:true,routePath:"\u002Farticles\u002Fshardulsrivastava\u002F797471",config:{_app:{basePath:"\u002F",assetsPath:"\u002F_nuxt\u002F",cdnURL:a}}}}(null,"2021-08-19T18:56:24Z",29,"shardulsrivastava","aws-builders"));