__NUXT_JSONP__("/articles/ku6ryo/840978", (function(a,b,c,d,e,f){c.type_of="article";c.id=840978;c.title="Benchmarking Next.js on Fastify custom server";c.description="Background   Next.js provides custom server feature. So I wondered how much performance...";c.readable_publish_date="Sep 26";c.slug="benchmarking-next-js-on-fastify-custom-server-mg4";c.path="\u002Fku6ryo\u002Fbenchmarking-next-js-on-fastify-custom-server-mg4";c.url=d;c.comments_count=0;c.public_reactions_count=e;c.collection_id=a;c.published_timestamp=b;c.positive_reactions_count=e;c.cover_image="https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--7bU0lWiY--\u002Fc_imagga_scale,f_auto,fl_progressive,h_420,q_auto,w_1000\u002Fhttps:\u002F\u002Fdev-to-uploads.s3.amazonaws.com\u002Fuploads\u002Farticles\u002Fo7cid5ernio582j5lxtz.png";c.social_image="https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--9Slk01tg--\u002Fc_imagga_scale,f_auto,fl_progressive,h_500,q_auto,w_1000\u002Fhttps:\u002F\u002Fdev-to-uploads.s3.amazonaws.com\u002Fuploads\u002Farticles\u002Fo7cid5ernio582j5lxtz.png";c.canonical_url=d;c.created_at="2021-09-26T08:44:24Z";c.edited_at="2021-09-26T09:35:08Z";c.crossposted_at=a;c.published_at=b;c.last_comment_at=b;c.reading_time_minutes=3;c.tag_list="nextjs, fastify";c.tags=["nextjs","fastify"];c.body_html="\u003Ch1\u003E\n  \u003Ca name=\"background\" href=\"#background\"\u003E\n  \u003C\u002Fa\u003E\n  Background\n\u003C\u002Fh1\u003E\n\n\u003Cp\u003ENext.js provides \u003Ca href=\"https:\u002F\u002Fnextjs.org\u002Fdocs\u002Fadvanced-features\u002Fcustom-server\"\u003Ecustom server feature\u003C\u002Fa\u003E. So I wondered how much performance improvements we can get from custom server with \u003Ca href=\"https:\u002F\u002Fwww.fastify.io\u002F\"\u003EFastify\u003C\u002Fa\u003E which is a fast implementation of HTTP server on Node.js.\u003C\u002Fp\u003E\n\n\u003Ch1\u003E\n  \u003Ca name=\"conclusion\" href=\"#conclusion\"\u003E\n  \u003C\u002Fa\u003E\n  Conclusion\n\u003C\u002Fh1\u003E\n\n\u003Cp\u003EFastify does not improve req\u002Fsec of page servings but do improve req\u002Fsec of API. If the server is non-Docker environment, \u003Ca href=\"https:\u002F\u002Fnodejs.org\u002Fapi\u002Fcluster.html\"\u003ENode.js cluster feature\u003C\u002Fa\u003E improves page serving too.\u003C\u002Fp\u003E\n\n\u003Ch1\u003E\n  \u003Ca name=\"implementations-with-fastify\" href=\"#implementations-with-fastify\"\u003E\n  \u003C\u002Fa\u003E\n  Implementations with Fastify\n\u003C\u002Fh1\u003E\n\n\u003Cp\u003EI prepared 3 implementations.\u003C\u002Fp\u003E\n\n\u003Cul\u003E\n\u003Cli\u003E\n\u003Cstrong\u003EAs-is\u003C\u002Fstrong\u003E. Not changing anything but adding small API code.\u003C\u002Fli\u003E\n\u003Cli\u003E\n\u003Cstrong\u003EFastify\u003C\u002Fstrong\u003E. Run Next.js on Fastify custom server.\u003C\u002Fli\u003E\n\u003Cli\u003E\n\u003Cstrong\u003EFastify cluster\u003C\u002Fstrong\u003E. Run Fastify custom server on multi-thread.\u003C\u002Fli\u003E\n\u003C\u002Ful\u003E\n\n\u003Cp\u003EI do not show the detail of my custom server implementation in this article but you can check on my \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fku6ryo\u002Fnext-fastify-benchmarking\"\u003EGithub repository\u003C\u002Fa\u003E.\u003C\u002Fp\u003E\n\n\u003Ch1\u003E\n  \u003Ca name=\"page-serving\" href=\"#page-serving\"\u003E\n  \u003C\u002Fa\u003E\n  Page serving\n\u003C\u002Fh1\u003E\n\n\u003Cp\u003EI did not change any code provided by \u003Ca href=\"https:\u002F\u002Fnextjs.org\u002Fdocs\u002Fapi-reference\u002Fcreate-next-app\"\u003Ecreate-next-app\u003C\u002Fa\u003E for page serving. I measured req\u002Fsec the 3 implementation with \u003Ca href=\"https:\u002F\u002Fwww.npmjs.com\u002Fpackage\u002Fautocannon\"\u003Eautocannon\u003C\u002Fa\u003E.\u003C\u002Fp\u003E\n\n\u003Cp\u003E\u003Cstrong\u003EFasitfy is 0.87 times of As-is. Fastify cluster is 2.9 times of As-is.\u003C\u002Fstrong\u003E\u003C\u002Fp\u003E\n\n\u003Cp\u003EThis says that if you want to use Next.js for page serving purpose, you should NOT use Fastify custom server. However, if you can use Node.js cluster, it's worth to use Fastify (or may be other HTTP server implementation).\u003C\u002Fp\u003E\n\n\u003Cp\u003E\u003Cem\u003EPlease note that if you run Next.js on Docker, cluster does not improve or even worsen the performance.\u003C\u002Fem\u003E\u003C\u002Fp\u003E\n\n\u003Ch2\u003E\n  \u003Ca name=\"asis\" href=\"#asis\"\u003E\n  \u003C\u002Fa\u003E\n  As-is\n\u003C\u002Fh2\u003E\n\n\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--q9TkTojx--\u002Fc_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880\u002Fhttps:\u002F\u002Fdev-to-uploads.s3.amazonaws.com\u002Fuploads\u002Farticles\u002Fofuhphr9oqop1rgtmtut.png\" class=\"article-body-image-wrapper\"\u003E\u003Cimg src=\"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--q9TkTojx--\u002Fc_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880\u002Fhttps:\u002F\u002Fdev-to-uploads.s3.amazonaws.com\u002Fuploads\u002Farticles\u002Fofuhphr9oqop1rgtmtut.png\" alt=\"Alt Text\" loading=\"lazy\"\u003E\u003C\u002Fa\u003E\u003C\u002Fp\u003E\n\n\u003Ch2\u003E\n  \u003Ca name=\"fastify\" href=\"#fastify\"\u003E\n  \u003C\u002Fa\u003E\n  Fastify\n\u003C\u002Fh2\u003E\n\n\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--wFpGRR6l--\u002Fc_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880\u002Fhttps:\u002F\u002Fdev-to-uploads.s3.amazonaws.com\u002Fuploads\u002Farticles\u002F4dr2w02tgbfu2eq9j59l.png\" class=\"article-body-image-wrapper\"\u003E\u003Cimg src=\"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--wFpGRR6l--\u002Fc_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880\u002Fhttps:\u002F\u002Fdev-to-uploads.s3.amazonaws.com\u002Fuploads\u002Farticles\u002F4dr2w02tgbfu2eq9j59l.png\" alt=\"Alt Text\" loading=\"lazy\"\u003E\u003C\u002Fa\u003E\u003C\u002Fp\u003E\n\n\u003Ch2\u003E\n  \u003Ca name=\"fastify-cluster\" href=\"#fastify-cluster\"\u003E\n  \u003C\u002Fa\u003E\n  Fastify cluster\n\u003C\u002Fh2\u003E\n\n\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--cRNyaDUM--\u002Fc_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880\u002Fhttps:\u002F\u002Fdev-to-uploads.s3.amazonaws.com\u002Fuploads\u002Farticles\u002Frke2ysyw13q8p4atmkcg.png\" class=\"article-body-image-wrapper\"\u003E\u003Cimg src=\"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--cRNyaDUM--\u002Fc_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880\u002Fhttps:\u002F\u002Fdev-to-uploads.s3.amazonaws.com\u002Fuploads\u002Farticles\u002Frke2ysyw13q8p4atmkcg.png\" alt=\"Alt Text\" loading=\"lazy\"\u003E\u003C\u002Fa\u003E\u003C\u002Fp\u003E\n\n\u003Ch1\u003E\n  \u003Ca name=\"api-serving\" href=\"#api-serving\"\u003E\n  \u003C\u002Fa\u003E\n  API serving\n\u003C\u002Fh1\u003E\n\n\u003Cp\u003EI added an API just serving a simple JSON \u003Ccode\u003E{ message: \"test\" }\u003C\u002Fcode\u003E to GET requests. For the as-is implementation, I created in the manner of Next.js (Created \u003Ccode\u003Epages\u002Fapi\u002Ftest.ts\u003C\u002Fcode\u003E). For other two implementations, I used Fasitfy routing (\u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fku6ryo\u002Fnext-fastify-benchmarking\u002Fblob\u002Fmain\u002Ffastify\u002Findex.ts#L9\"\u003Edetail\u003C\u002Fa\u003E).\u003C\u002Fp\u003E\n\n\u003Cp\u003E\u003Cstrong\u003EFastify showed 4.14 times of As-is' req \u002F sec and Fastify cluster showed 5.63 times of As-is.\u003C\u002Fstrong\u003E\u003C\u002Fp\u003E\n\n\u003Cp\u003EConsidering the result of page serving, if your app uses much API requests from browser comparing to page transition requests, you may use Fastify custom server without cluster even page serving performance is worse than As-is implementation. If you can use Node.js cluster, of course it's worse to use Fastify.\u003C\u002Fp\u003E\n\n\u003Ch2\u003E\n  \u003Ca name=\"asis\" href=\"#asis\"\u003E\n  \u003C\u002Fa\u003E\n  As-is\n\u003C\u002Fh2\u003E\n\n\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--s1MaiTh5--\u002Fc_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880\u002Fhttps:\u002F\u002Fdev-to-uploads.s3.amazonaws.com\u002Fuploads\u002Farticles\u002Ffjyp326t94htq7hic18y.png\" class=\"article-body-image-wrapper\"\u003E\u003Cimg src=\"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--s1MaiTh5--\u002Fc_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880\u002Fhttps:\u002F\u002Fdev-to-uploads.s3.amazonaws.com\u002Fuploads\u002Farticles\u002Ffjyp326t94htq7hic18y.png\" alt=\"Alt Text\" loading=\"lazy\"\u003E\u003C\u002Fa\u003E\u003C\u002Fp\u003E\n\n\u003Ch2\u003E\n  \u003Ca name=\"fastify\" href=\"#fastify\"\u003E\n  \u003C\u002Fa\u003E\n  Fastify\n\u003C\u002Fh2\u003E\n\n\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--pRHwczoT--\u002Fc_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880\u002Fhttps:\u002F\u002Fdev-to-uploads.s3.amazonaws.com\u002Fuploads\u002Farticles\u002Fzpudwdroymgfvdk9iomp.png\" class=\"article-body-image-wrapper\"\u003E\u003Cimg src=\"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--pRHwczoT--\u002Fc_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880\u002Fhttps:\u002F\u002Fdev-to-uploads.s3.amazonaws.com\u002Fuploads\u002Farticles\u002Fzpudwdroymgfvdk9iomp.png\" alt=\"Alt Text\" loading=\"lazy\"\u003E\u003C\u002Fa\u003E\u003C\u002Fp\u003E\n\n\u003Ch2\u003E\n  \u003Ca name=\"fastify-cluster\" href=\"#fastify-cluster\"\u003E\n  \u003C\u002Fa\u003E\n  Fastify cluster\n\u003C\u002Fh2\u003E\n\n\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--Mdn7y9h7--\u002Fc_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880\u002Fhttps:\u002F\u002Fdev-to-uploads.s3.amazonaws.com\u002Fuploads\u002Farticles\u002F5j7vjuvet5vtvpzlyfvz.png\" class=\"article-body-image-wrapper\"\u003E\u003Cimg src=\"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--Mdn7y9h7--\u002Fc_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880\u002Fhttps:\u002F\u002Fdev-to-uploads.s3.amazonaws.com\u002Fuploads\u002Farticles\u002F5j7vjuvet5vtvpzlyfvz.png\" alt=\"Alt Text\" loading=\"lazy\"\u003E\u003C\u002Fa\u003E\u003C\u002Fp\u003E\n\n\u003Ch1\u003E\n  \u003Ca name=\"setup\" href=\"#setup\"\u003E\n  \u003C\u002Fa\u003E\n  Setup\n\u003C\u002Fh1\u003E\n\n\u003Cul\u003E\n\u003Cli\u003EOS: Windows 11 Pro\u003C\u002Fli\u003E\n\u003Cli\u003ECPU: Intel(R) Core(TM) i9-9900K CPU @ 3.60GHz (8 cores \u002F 16 logical processors)\u003C\u002Fli\u003E\n\u003Cli\u003ERAM: 32 GB\u003C\u002Fli\u003E\n\u003C\u002Ful\u003E\n\n\u003Ch1\u003E\n  \u003Ca name=\"appendix-a-api-serving-in-the-manner-of-nextjs-with-fastify\" href=\"#appendix-a-api-serving-in-the-manner-of-nextjs-with-fastify\"\u003E\n  \u003C\u002Fa\u003E\n  Appendix A: API serving in the manner of Next.js with Fastify\n\u003C\u002Fh1\u003E\n\n\u003Cp\u003ECompared API implementation in the manner of Next.js \u003Ccode\u003Epages\u002Fapi\u003C\u002Fcode\u003E. Fastify shows 0.80 times of As-is req \u002F sec. Fastify cluster shows 2.31 times of As-is.\u003C\u002Fp\u003E\n\n\u003Ch2\u003E\n  \u003Ca name=\"asis\" href=\"#asis\"\u003E\n  \u003C\u002Fa\u003E\n  As-is\n\u003C\u002Fh2\u003E\n\n\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--ocOjBUs7--\u002Fc_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880\u002Fhttps:\u002F\u002Fdev-to-uploads.s3.amazonaws.com\u002Fuploads\u002Farticles\u002Fjua88sbudk40draky6os.png\" class=\"article-body-image-wrapper\"\u003E\u003Cimg src=\"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--ocOjBUs7--\u002Fc_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880\u002Fhttps:\u002F\u002Fdev-to-uploads.s3.amazonaws.com\u002Fuploads\u002Farticles\u002Fjua88sbudk40draky6os.png\" alt=\"Alt Text\" loading=\"lazy\"\u003E\u003C\u002Fa\u003E\u003C\u002Fp\u003E\n\n\u003Ch2\u003E\n  \u003Ca name=\"fastify\" href=\"#fastify\"\u003E\n  \u003C\u002Fa\u003E\n  Fastify\n\u003C\u002Fh2\u003E\n\n\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--M8AT0KuA--\u002Fc_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880\u002Fhttps:\u002F\u002Fdev-to-uploads.s3.amazonaws.com\u002Fuploads\u002Farticles\u002Fck090c55zn51larj1aob.png\" class=\"article-body-image-wrapper\"\u003E\u003Cimg src=\"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--M8AT0KuA--\u002Fc_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880\u002Fhttps:\u002F\u002Fdev-to-uploads.s3.amazonaws.com\u002Fuploads\u002Farticles\u002Fck090c55zn51larj1aob.png\" alt=\"Alt Text\" loading=\"lazy\"\u003E\u003C\u002Fa\u003E\u003C\u002Fp\u003E\n\n\u003Ch2\u003E\n  \u003Ca name=\"fastify-cluster\" href=\"#fastify-cluster\"\u003E\n  \u003C\u002Fa\u003E\n  Fastify cluster\n\u003C\u002Fh2\u003E\n\n\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--_L_zCC0l--\u002Fc_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880\u002Fhttps:\u002F\u002Fdev-to-uploads.s3.amazonaws.com\u002Fuploads\u002Farticles\u002Fhvp85807bne02405xomn.png\" class=\"article-body-image-wrapper\"\u003E\u003Cimg src=\"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--_L_zCC0l--\u002Fc_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880\u002Fhttps:\u002F\u002Fdev-to-uploads.s3.amazonaws.com\u002Fuploads\u002Farticles\u002Fhvp85807bne02405xomn.png\" alt=\"Alt Text\" loading=\"lazy\"\u003E\u003C\u002Fa\u003E\u003C\u002Fp\u003E\n\n\u003Ch1\u003E\n  \u003Ca name=\"appendix-b-page-serving-on-docker\" href=\"#appendix-b-page-serving-on-docker\"\u003E\n  \u003C\u002Fa\u003E\n  Appendix B: Page serving on Docker\n\u003C\u002Fh1\u003E\n\n\u003Cp\u003EI checked performances of Docker environments. Fastify cluster does not improve performance. Fastify shows 0.85 times of As-is req \u002F sec and Fastify cluster shows 0.83 times of As-is (It's even worse !).\u003C\u002Fp\u003E\n\n\u003Ch2\u003E\n  \u003Ca name=\"asis\" href=\"#asis\"\u003E\n  \u003C\u002Fa\u003E\n  As-is\n\u003C\u002Fh2\u003E\n\n\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--PNpnPGaO--\u002Fc_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880\u002Fhttps:\u002F\u002Fdev-to-uploads.s3.amazonaws.com\u002Fuploads\u002Farticles\u002Fc3a7q2qnrpf2uet98b44.png\" class=\"article-body-image-wrapper\"\u003E\u003Cimg src=\"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--PNpnPGaO--\u002Fc_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880\u002Fhttps:\u002F\u002Fdev-to-uploads.s3.amazonaws.com\u002Fuploads\u002Farticles\u002Fc3a7q2qnrpf2uet98b44.png\" alt=\"Alt Text\" loading=\"lazy\"\u003E\u003C\u002Fa\u003E\u003C\u002Fp\u003E\n\n\u003Ch2\u003E\n  \u003Ca name=\"fastify\" href=\"#fastify\"\u003E\n  \u003C\u002Fa\u003E\n  Fastify\n\u003C\u002Fh2\u003E\n\n\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--C8pgQzxT--\u002Fc_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880\u002Fhttps:\u002F\u002Fdev-to-uploads.s3.amazonaws.com\u002Fuploads\u002Farticles\u002F1casiha7abprwvhyvjzl.png\" class=\"article-body-image-wrapper\"\u003E\u003Cimg src=\"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--C8pgQzxT--\u002Fc_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880\u002Fhttps:\u002F\u002Fdev-to-uploads.s3.amazonaws.com\u002Fuploads\u002Farticles\u002F1casiha7abprwvhyvjzl.png\" alt=\"Alt Text\" loading=\"lazy\"\u003E\u003C\u002Fa\u003E\u003C\u002Fp\u003E\n\n\u003Ch2\u003E\n  \u003Ca name=\"fastify-cluster\" href=\"#fastify-cluster\"\u003E\n  \u003C\u002Fa\u003E\n  Fastify cluster\n\u003C\u002Fh2\u003E\n\n\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--CWqPoChc--\u002Fc_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880\u002Fhttps:\u002F\u002Fdev-to-uploads.s3.amazonaws.com\u002Fuploads\u002Farticles\u002Fgr8sunhaxovcuwi9u43r.png\" class=\"article-body-image-wrapper\"\u003E\u003Cimg src=\"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--CWqPoChc--\u002Fc_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880\u002Fhttps:\u002F\u002Fdev-to-uploads.s3.amazonaws.com\u002Fuploads\u002Farticles\u002Fgr8sunhaxovcuwi9u43r.png\" alt=\"Alt Text\" loading=\"lazy\"\u003E\u003C\u002Fa\u003E\u003C\u002Fp\u003E\n\n";c.body_markdown="# Background\nNext.js provides [custom server feature](https:\u002F\u002Fnextjs.org\u002Fdocs\u002Fadvanced-features\u002Fcustom-server). So I wondered how much performance improvements we can get from custom server with [Fastify](https:\u002F\u002Fwww.fastify.io\u002F) which is a fast implementation of HTTP server on Node.js.\n\n# Conclusion\nFastify does not improve req\u002Fsec of page servings but do improve req\u002Fsec of API. If the server is non-Docker environment, [Node.js cluster feature](https:\u002F\u002Fnodejs.org\u002Fapi\u002Fcluster.html) improves page serving too.\n\n# Implementations with Fastify\nI prepared 3 implementations.\n\n- **As-is**. Not changing anything but adding small API code.\n- **Fastify**. Run Next.js on Fastify custom server.\n- **Fastify cluster**. Run Fastify custom server on multi-thread.\n\nI do not show the detail of my custom server implementation in this article but you can check on my [Github repository](https:\u002F\u002Fgithub.com\u002Fku6ryo\u002Fnext-fastify-benchmarking).\n\n# Page serving\nI did not change any code provided by [create-next-app](https:\u002F\u002Fnextjs.org\u002Fdocs\u002Fapi-reference\u002Fcreate-next-app) for page serving. I measured req\u002Fsec the 3 implementation with [autocannon](https:\u002F\u002Fwww.npmjs.com\u002Fpackage\u002Fautocannon).\n\n**Fasitfy is 0.87 times of As-is. Fastify cluster is 2.9 times of As-is.**\n\nThis says that if you want to use Next.js for page serving purpose, you should NOT use Fastify custom server. However, if you can use Node.js cluster, it's worth to use Fastify (or may be other HTTP server implementation).\n\n*Please note that if you run Next.js on Docker, cluster does not improve or even worsen the performance.*\n\n## As-is\n![Alt Text](https:\u002F\u002Fdev-to-uploads.s3.amazonaws.com\u002Fuploads\u002Farticles\u002Fofuhphr9oqop1rgtmtut.png)\n\n## Fastify\n![Alt Text](https:\u002F\u002Fdev-to-uploads.s3.amazonaws.com\u002Fuploads\u002Farticles\u002F4dr2w02tgbfu2eq9j59l.png)\n\n## Fastify cluster\n![Alt Text](https:\u002F\u002Fdev-to-uploads.s3.amazonaws.com\u002Fuploads\u002Farticles\u002Frke2ysyw13q8p4atmkcg.png)\n\n# API serving\nI added an API just serving a simple JSON `{ message: \"test\" }` to GET requests. For the as-is implementation, I created in the manner of Next.js (Created `pages\u002Fapi\u002Ftest.ts`). For other two implementations, I used Fasitfy routing ([detail](https:\u002F\u002Fgithub.com\u002Fku6ryo\u002Fnext-fastify-benchmarking\u002Fblob\u002Fmain\u002Ffastify\u002Findex.ts#L9)).\n\n**Fastify showed 4.14 times of As-is' req \u002F sec and Fastify cluster showed 5.63 times of As-is.**\n\nConsidering the result of page serving, if your app uses much API requests from browser comparing to page transition requests, you may use Fastify custom server without cluster even page serving performance is worse than As-is implementation. If you can use Node.js cluster, of course it's worse to use Fastify.\n## As-is\n![Alt Text](https:\u002F\u002Fdev-to-uploads.s3.amazonaws.com\u002Fuploads\u002Farticles\u002Ffjyp326t94htq7hic18y.png)\n\n## Fastify\n![Alt Text](https:\u002F\u002Fdev-to-uploads.s3.amazonaws.com\u002Fuploads\u002Farticles\u002Fzpudwdroymgfvdk9iomp.png)\n\n## Fastify cluster\n![Alt Text](https:\u002F\u002Fdev-to-uploads.s3.amazonaws.com\u002Fuploads\u002Farticles\u002F5j7vjuvet5vtvpzlyfvz.png)\n\n# Setup\n- OS: Windows 11 Pro\n- CPU: Intel(R) Core(TM) i9-9900K CPU @ 3.60GHz (8 cores \u002F 16 logical processors)\n- RAM: 32 GB\n\n# Appendix A: API serving in the manner of Next.js with Fastify\n\nCompared API implementation in the manner of Next.js `pages\u002Fapi`. Fastify shows 0.80 times of As-is req \u002F sec. Fastify cluster shows 2.31 times of As-is.\n\n## As-is\n![Alt Text](https:\u002F\u002Fdev-to-uploads.s3.amazonaws.com\u002Fuploads\u002Farticles\u002Fjua88sbudk40draky6os.png)\n\n## Fastify\n![Alt Text](https:\u002F\u002Fdev-to-uploads.s3.amazonaws.com\u002Fuploads\u002Farticles\u002Fck090c55zn51larj1aob.png)\n\n## Fastify cluster\n![Alt Text](https:\u002F\u002Fdev-to-uploads.s3.amazonaws.com\u002Fuploads\u002Farticles\u002Fhvp85807bne02405xomn.png)\n\n# Appendix B: Page serving on Docker\nI checked performances of Docker environments. Fastify cluster does not improve performance. Fastify shows 0.85 times of As-is req \u002F sec and Fastify cluster shows 0.83 times of As-is (It's even worse !).\n\n## As-is\n![Alt Text](https:\u002F\u002Fdev-to-uploads.s3.amazonaws.com\u002Fuploads\u002Farticles\u002Fc3a7q2qnrpf2uet98b44.png)\n\n## Fastify\n![Alt Text](https:\u002F\u002Fdev-to-uploads.s3.amazonaws.com\u002Fuploads\u002Farticles\u002F1casiha7abprwvhyvjzl.png)\n\n## Fastify cluster\n![Alt Text](https:\u002F\u002Fdev-to-uploads.s3.amazonaws.com\u002Fuploads\u002Farticles\u002Fgr8sunhaxovcuwi9u43r.png)\n";c.user={name:"Ryo Kuroyanagi",username:f,twitter_username:a,github_username:f,website_url:a,profile_image:"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--O62mPR7J--\u002Fc_fill,f_auto,fl_progressive,h_640,q_auto,w_640\u002Fhttps:\u002F\u002Fdev-to-uploads.s3.amazonaws.com\u002Fuploads\u002Fuser\u002Fprofile_image\u002F685293\u002F2ded16ab-c722-4f05-b0c0-3dfff7bcfded.jpeg",profile_image_90:"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--0AQle0_8--\u002Fc_fill,f_auto,fl_progressive,h_90,q_auto,w_90\u002Fhttps:\u002F\u002Fdev-to-uploads.s3.amazonaws.com\u002Fuploads\u002Fuser\u002Fprofile_image\u002F685293\u002F2ded16ab-c722-4f05-b0c0-3dfff7bcfded.jpeg"};return {data:[{}],fetch:{"data-v-25febe66:0":{article:c}},mutations:[["SET_CURRENT_ARTICLE",c]]}}(null,"2021-09-26T09:19:23Z",{},"https:\u002F\u002Fdev.to\u002Fku6ryo\u002Fbenchmarking-next-js-on-fastify-custom-server-mg4",4,"ku6ryo")));