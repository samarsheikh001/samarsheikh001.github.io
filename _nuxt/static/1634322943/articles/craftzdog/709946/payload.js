__NUXT_JSONP__("/articles/craftzdog/709946", (function(a,b,c,d,e){b.type_of="article";b.id=709946;b.title="How I integrated 3D secure for recurring payments with Stripe";b.description="Hi, it's Takuya from Japan.  I'm running a SaaS app called Inkdrop which is a subscription-based serv...";b.readable_publish_date="May 31";b.slug="how-i-integrated-3d-secure-for-recurring-payments-with-stripe-dmh";b.path="\u002Fcraftzdog\u002Fhow-i-integrated-3d-secure-for-recurring-payments-with-stripe-dmh";b.url="https:\u002F\u002Fdev.to\u002Fcraftzdog\u002Fhow-i-integrated-3d-secure-for-recurring-payments-with-stripe-dmh";b.comments_count=1;b.public_reactions_count=a;b.collection_id=4653;b.published_timestamp=c;b.positive_reactions_count=a;b.cover_image="https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--qur9izKW--\u002Fc_imagga_scale,f_auto,fl_progressive,h_420,q_auto,w_1000\u002Fhttps:\u002F\u002Fdev-to-uploads.s3.amazonaws.com\u002Fuploads\u002Farticles\u002Fg7g31jd8qpooyu4r75zt.png";b.social_image="https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--zfokIC6t--\u002Fc_imagga_scale,f_auto,fl_progressive,h_500,q_auto,w_1000\u002Fhttps:\u002F\u002Fdev-to-uploads.s3.amazonaws.com\u002Fuploads\u002Farticles\u002Fg7g31jd8qpooyu4r75zt.png";b.canonical_url="https:\u002F\u002Fblog.inkdrop.info\u002Fhow-i-integrated-3d-secure-for-recurring-payments-with-stripe-a1c4891b9690";b.created_at="2021-05-27T08:36:14Z";b.edited_at=d;b.crossposted_at=d;b.published_at=c;b.last_comment_at="2021-10-02T17:04:48Z";b.reading_time_minutes=a;b.tag_list="stripe, javascript, saas";b.tags=["stripe","javascript","saas"];b.body_html="\u003Cp\u003EHi, it's \u003Ca href=\"https:\u002F\u002Ftwitter.com\u002Finkdrop_app\"\u003ETakuya\u003C\u002Fa\u003E from Japan.\u003C\u002Fp\u003E\n\n\u003Cp\u003EI'm running a SaaS app called \u003Ca href=\"https:\u002F\u002Fwww.inkdrop.app\u002F\"\u003EInkdrop\u003C\u002Fa\u003E which is a subscription-based service.\u003Cbr\u003E\nI use \u003Ca href=\"http:\u002F\u002Fstripe.com\u002F\"\u003EStripe\u003C\u002Fa\u003E to accept payments with credit cards around the world.\u003Cbr\u003E\nRecently, I've got an email from Stripe that users can't renew their subscriptions under RBI regulations in India if your website doesn't support 3D secure:\u003C\u002Fp\u003E\n\n\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fsupport.stripe.com\u002Fquestions\u002Fimportant-updates-to-rbi-regulations-on-recurring-card-payments-in-india\"\u003Ehttps:\u002F\u002Fsupport.stripe.com\u002Fquestions\u002Fimportant-updates-to-rbi-regulations-on-recurring-card-payments-in-india\u003C\u002Fa\u003E\u003C\u002Fp\u003E\n\n\u003Cp\u003EThat's going to affect my service since I have customers from India.\u003Cbr\u003E\nSo, I decided to support 3D secure authentication on my website.\u003C\u002Fp\u003E\n\n\u003Cp\u003EIn terms of implementation, there are several ways to implement a card form for recurring payments.\u003Cbr\u003E\nIf you are already using \u003Ca href=\"https:\u002F\u002Fstripe.com\u002Fdocs\u002Fbilling\u002Fsubscriptions\u002Fcheckout\"\u003EStripe Checkout\u003C\u002Fa\u003E, it's easy. All you have to do is \u003Ca href=\"https:\u002F\u002Fsupport.stripe.com\u002Fquestions\u002Fimportant-updates-to-rbi-regulations-on-recurring-card-payments-in-india\"\u003Eenable 3D Secure\u003C\u002Fa\u003E in your Billing settings. Then, Stripe basically does all nicely for you.\u003Cbr\u003E\nHowever, I was using \u003Ca href=\"https:\u002F\u002Fstripe.com\u002Fen-jp\u002Fpayments\u002Felements\"\u003EStripe Elements\u003C\u002Fa\u003E and \u003Ca href=\"https:\u002F\u002Fstripe.com\u002Fdocs\u002Fsources\"\u003ESources API\u003C\u002Fa\u003E to provide a credit card form. While it provides \u003Ca href=\"https:\u002F\u002Fstripe.dev\u002Felements-examples\u002F\"\u003Ehighly customizable form components\u003C\u002Fa\u003E, \u003Ca href=\"https:\u002F\u002Fstripe.com\u002Fdocs\u002Fpayments\u002F3d-secure#confirm-payment-intent\"\u003Eit requires an additional complicated implementation\u003C\u002Fa\u003E for 3D secure authentication. Besides, the Sources API is \u003Ca href=\"https:\u002F\u002Fstripe.com\u002Fdocs\u002Fpayments\u002Fpayment-methods\u002Ftransitioning\"\u003Eno longer recommended\u003C\u002Fa\u003E.\u003Cbr\u003E\nLooks like my code is old since I've implemented it several years ago.\u003Cbr\u003E\nI thought it's time to switch my payment logic from Stripe Elements to Stripe Checkout.\u003C\u002Fp\u003E\n\n\u003Cp\u003EIn this article, I'll share how I migrated from Stripe Elements to Stripe Checkout. It'd be also helpful for those who are planning to adopt Stripe Checkout for your website. Let's get started.\u003C\u002Fp\u003E\n\u003Ch2\u003E\n  \u003Ca name=\"understand-a-new-way-to-set-up-future-payments\" href=\"#understand-a-new-way-to-set-up-future-payments\"\u003E\n  \u003C\u002Fa\u003E\n  Understand a new way to set up future payments\n\u003C\u002Fh2\u003E\n\n\u003Cp\u003EI was so confused when reading Stripe's documentation because my knowledge was outdated.\u003Cbr\u003E\nThere are several new APIs you have to understand:\u003C\u002Fp\u003E\n\n\u003Cul\u003E\n\u003Cli\u003E\u003Ca href=\"https:\u002F\u002Fstripe.com\u002Fdocs\u002Fpayments\u002Fpayment-methods\"\u003EPayment Methods\u003C\u002Fa\u003E\u003C\u002Fli\u003E\n\u003Cli\u003E\u003Ca href=\"https:\u002F\u002Fstripe.com\u002Fdocs\u002Fpayments\u002Fsetup-intents\"\u003ESetup Intents\u003C\u002Fa\u003E\u003C\u002Fli\u003E\n\u003Cli\u003E\u003Ca href=\"https:\u002F\u002Fstripe.com\u002Fdocs\u002Fapi\u002Fcheckout\u002Fsessions\"\u003ECheckout Sessions\u003C\u002Fa\u003E\u003C\u002Fli\u003E\n\u003C\u002Ful\u003E\n\n\u003Cp\u003EI try to explain them as simple as possible:\u003Cbr\u003E\nYou've been able to use card tokens retrieved via the Sources API for recurring payments.\u003Cbr\u003E\nBut the Sources are now replaced with Payment methods and Setup intents.\u003Cbr\u003E\nYou can think like the Sources API has been subdivided into the Payment Methods API and Setup Intents API.\u003Cbr\u003E\nValid payment methods are attached to customers.\u003Cbr\u003E\nYou can use a payment method to charge a customer for recurring payments.\u003Cbr\u003E\nThe Setup Intents API allows you to set up a payment method for future payments.\u003Cbr\u003E\nStripe Checkout creates a Checkout Session for the customer. A setup intent is issued and managed by the checkout session. It attaches a payment method to the customer once successfully finished the session.\u003C\u002Fp\u003E\n\u003Ch2\u003E\n  \u003Ca name=\"enable-3d-secure\" href=\"#enable-3d-secure\"\u003E\n  \u003C\u002Fa\u003E\n  Enable 3D Secure\n\u003C\u002Fh2\u003E\n\n\u003Cp\u003EAs the latest Stripe API supports 3D Secure out of the box, you can enable it from \u003Cem\u003ESettings -&gt; Subscriptions and emails -&gt; Manage payments that require 3D Secure\u003C\u002Fem\u003E:\u003C\u002Fp\u003E\n\n\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--knjnthL3--\u002Fc_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880\u002Fhttps:\u002F\u002Fcdn-images-1.medium.com\u002Fmax\u002F2400\u002F1%2A_mfaDMipb3ToCcUso4Sa7Q.png\" class=\"article-body-image-wrapper\"\u003E\u003Cimg src=\"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--knjnthL3--\u002Fc_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880\u002Fhttps:\u002F\u002Fcdn-images-1.medium.com\u002Fmax\u002F2400\u002F1%2A_mfaDMipb3ToCcUso4Sa7Q.png\" alt=\"Settings\" loading=\"lazy\"\u003E\u003C\u002Fa\u003E\u003C\u002Fp\u003E\n\n\u003Cp\u003EThen, check your Radar rules from \u003Cem\u003ESettings -&gt; Radar rules\u003C\u002Fem\u003E:\u003C\u002Fp\u003E\n\n\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--VJJrZtZn--\u002Fc_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880\u002Fhttps:\u002F\u002Fcdn-images-1.medium.com\u002Fmax\u002F2400\u002F1%2AEmZBEt7Lj8wuYvJyss4qjw.png\" class=\"article-body-image-wrapper\"\u003E\u003Cimg src=\"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--VJJrZtZn--\u002Fc_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880\u002Fhttps:\u002F\u002Fcdn-images-1.medium.com\u002Fmax\u002F2400\u002F1%2AEmZBEt7Lj8wuYvJyss4qjw.png\" alt=\"Radar rules\" loading=\"lazy\"\u003E\u003C\u002Fa\u003E\u003Cbr\u003E\nWith this configuration, 3D secure will be requested when it is required for card. I don't know which is the best practice, so I try this rule for now.\u003C\u002Fp\u003E\n\n\u003Cp\u003ENow, you are ready to integrate it!\u003C\u002Fp\u003E\n\u003Ch2\u003E\n  \u003Ca name=\"4-pathways-users-input-their-card-information\" href=\"#4-pathways-users-input-their-card-information\"\u003E\n  \u003C\u002Fa\u003E\n  4 pathways users input their card information\n\u003C\u002Fh2\u003E\n\n\u003Cp\u003EIn Stripe, each user has a \u003Ca href=\"https:\u002F\u002Fstripe.com\u002Fdocs\u002Fapi\u002Fcustomers\"\u003ECustomer\u003C\u002Fa\u003E object, and a \u003Ca href=\"https:\u002F\u002Fstripe.com\u002Fdocs\u002Fapi\u002Fsubscriptions\"\u003ESubscription\u003C\u002Fa\u003E object is associated with each customer, which allows you to manage his\u002Fher subscription status.\u003Cbr\u003E\nInkdrop doesn't require card information when signing up because it provides free trials. Customers have the following 3 account statuses:\u003C\u002Fp\u003E\n\n\u003Col\u003E\n\u003Cli\u003E\n\u003Ccode\u003Etrial\u003C\u002Fcode\u003E - In free-trial\u003C\u002Fli\u003E\n\u003Cli\u003E\n\u003Ccode\u003Eactive\u003C\u002Fcode\u003E - Has an active subscription\u003C\u002Fli\u003E\n\u003Cli\u003E\n\u003Ccode\u003Edeactivated\u003C\u002Fcode\u003E - The subscription has been cancelled 15 days after a payment failure\u003C\u002Fli\u003E\n\u003C\u002Fol\u003E\n\n\u003Cp\u003EThat completely depends on your business design but I guess it'd be one of the common design patterns. Note that they are my application-specific statuses stored in my server.\u003Cbr\u003E\nWith those statuses, the Inkdrop users may input their card information when:\u003C\u002Fp\u003E\n\n\u003Col\u003E\n\u003Cli\u003EThe user adds\u002Fchanges\u002Fupdates the card detail\u003C\u002Fli\u003E\n\u003Cli\u003EThe user starts paying it before the trial expires\u003C\u002Fli\u003E\n\u003Cli\u003EThe trial has been expired\u003C\u002Fli\u003E\n\u003Cli\u003EThe account has been deactivated\u003C\u002Fli\u003E\n\u003C\u002Fol\u003E\n\n\u003Cp\u003EI'll explain how to deal with those cases with Stripe Checkout.\u003C\u002Fp\u003E\n\u003Ch2\u003E\n  \u003Ca name=\"1-user-addschangesupdates-card-detail\" href=\"#1-user-addschangesupdates-card-detail\"\u003E\n  \u003C\u002Fa\u003E\n  1. User adds\u002Fchanges\u002Fupdates card detail\n\u003C\u002Fh2\u003E\n\n\u003Cp\u003EThis is the simplest case.\u003Cbr\u003E\nUsers can do it anytime from the website.\u003Cbr\u003E\nHere is the billing page of Inkdrop:\u003C\u002Fp\u003E\n\n\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--W_7KxV9a--\u002Fc_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880\u002Fhttps:\u002F\u002Fcdn-images-1.medium.com\u002Fmax\u002F2600\u002F1%2A8lnOjUBEVGx6Vmo2Uk--mA.png\" class=\"article-body-image-wrapper\"\u003E\u003Cimg src=\"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--W_7KxV9a--\u002Fc_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880\u002Fhttps:\u002F\u002Fcdn-images-1.medium.com\u002Fmax\u002F2600\u002F1%2A8lnOjUBEVGx6Vmo2Uk--mA.png\" alt=\"Billing page\" loading=\"lazy\"\u003E\u003C\u002Fa\u003E\u003C\u002Fp\u003E\n\n\u003Cp\u003EYou can update the billing details on this page. Nothing special.\u003Cbr\u003E\nAnd when a user clicked \u003Cem\u003E'Change \u002F update card'\u003C\u002Fem\u003E button, it shows:\u003C\u002Fp\u003E\n\n\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--b8r2VNaN--\u002Fc_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880\u002Fhttps:\u002F\u002Fcdn-images-1.medium.com\u002Fmax\u002F2600\u002F1%2AQS7xgo_fPZa5xsgs94QkDw.png\" class=\"article-body-image-wrapper\"\u003E\u003Cimg src=\"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--b8r2VNaN--\u002Fc_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880\u002Fhttps:\u002F\u002Fcdn-images-1.medium.com\u002Fmax\u002F2600\u002F1%2AQS7xgo_fPZa5xsgs94QkDw.png\" alt=\"\" loading=\"lazy\"\u003E\u003C\u002Fa\u003E\u003Cbr\u003E\nIn this page, the website initiates a new Checkout Session by calling \u003Ca href=\"https:\u002F\u002Fstripe.com\u002Fdocs\u002Fapi\u002Fcheckout\u002Fsessions\u002Fcreate\"\u003E\u003Ccode\u003Estripe.checkout.sessions.create\u003C\u002Fcode\u003E\u003C\u002Fa\u003E on the server-side like so:\u003Cbr\u003E\n\u003C\u002Fp\u003E\n\n\u003Cdiv class=\"highlight js-code-highlight\"\u003E\n\u003Cpre class=\"highlight javascript\"\u003E\u003Ccode\u003E\u003Cspan class=\"kd\"\u003Econst\u003C\u002Fspan\u003E \u003Cspan class=\"nx\"\u003Esession\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Eawait\u003C\u002Fspan\u003E \u003Cspan class=\"nx\"\u003Estripe\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003Echeckout\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003Esessions\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003Ecreate\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E({\u003C\u002Fspan\u003E\n  \u003Cspan class=\"na\"\u003Epayment_method_types\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\"dl\"\u003E'\u003C\u002Fspan\u003E\u003Cspan class=\"s1\"\u003Ecard\u003C\u002Fspan\u003E\u003Cspan class=\"dl\"\u003E'\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E],\u003C\u002Fspan\u003E\n  \u003Cspan class=\"na\"\u003Emode\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"dl\"\u003E'\u003C\u002Fspan\u003E\u003Cspan class=\"s1\"\u003Esetup\u003C\u002Fspan\u003E\u003Cspan class=\"dl\"\u003E'\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E\n  \u003Cspan class=\"na\"\u003Ecustomer\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"nx\"\u003EcustomerId\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E\n  \u003Cspan class=\"na\"\u003Esuccess_url\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"nx\"\u003EredirectSuccessUrl\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E\n  \u003Cspan class=\"na\"\u003Ecancel_url\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"nx\"\u003Econfig\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003Eapp\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003EbaseUrl\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E+\u003C\u002Fspan\u003E \u003Cspan class=\"nx\"\u003Ecancel_url\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E\n  \u003Cspan class=\"na\"\u003Ebilling_address_collection\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"nx\"\u003EneedsBillingAddress\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E?\u003C\u002Fspan\u003E \u003Cspan class=\"dl\"\u003E'\u003C\u002Fspan\u003E\u003Cspan class=\"s1\"\u003Erequired\u003C\u002Fspan\u003E\u003Cspan class=\"dl\"\u003E'\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"dl\"\u003E'\u003C\u002Fspan\u003E\u003Cspan class=\"s1\"\u003Eauto\u003C\u002Fspan\u003E\u003Cspan class=\"dl\"\u003E'\u003C\u002Fspan\u003E\n\u003Cspan class=\"p\"\u003E})\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cdiv class=\"highlight__panel js-actions-panel\"\u003E\n\u003Cdiv class=\"highlight__panel-action js-fullscreen-code-action\"\u003E\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"\u003E\u003Ctitle\u003EEnter fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"\u003E\u003Ctitle\u003EExit fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\n\n\n\u003Cul\u003E\n\u003Cli\u003E\n\u003Ccode\u003Epayment_method_types\u003C\u002Fcode\u003E - Inkdrop only accepts credit cards, so it should be always \u003Ccode\u003E['card']\u003C\u002Fcode\u003E.\u003C\u002Fli\u003E\n\u003Cli\u003E\n\u003Ccode\u003Emode\u003C\u002Fcode\u003E - It specifies \u003Ccode\u003Emode\u003C\u002Fcode\u003E as \u003Ccode\u003E'setup'\u003C\u002Fcode\u003E so that you can use the payment method for future payments.\u003C\u002Fli\u003E\n\u003Cli\u003E\n\u003Ccode\u003Esuccess_url\u003C\u002Fcode\u003E &amp; \u003Ccode\u003Ecancel_url\u003C\u002Fcode\u003E - You can specify redirection URLs where Stripe will navigate the user after the session.\u003C\u002Fli\u003E\n\u003Cli\u003E\n\u003Ccode\u003Ebilling_address_collection\u003C\u002Fcode\u003E - If you need to collect the customer's billing address, you can do that on the Checkout page by specifying it as \u003Ccode\u003E'required'\u003C\u002Fcode\u003E\n\u003C\u002Fli\u003E\n\u003C\u002Ful\u003E\n\n\u003Cp\u003EOn the website, it retrieves the Session data from the server when opened the above page. When the user pressed 'Input Card' button, it redirects to the Checkout page like so:\u003Cbr\u003E\n\u003C\u002Fp\u003E\n\n\u003Cdiv class=\"highlight js-code-highlight\"\u003E\n\u003Cpre class=\"highlight javascript\"\u003E\u003Ccode\u003E\u003Cspan class=\"nx\"\u003Estripe\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003EredirectToCheckout\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E({\u003C\u002Fspan\u003E \u003Cspan class=\"na\"\u003EsessionId\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"nx\"\u003Esession\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003Eid\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E})\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cdiv class=\"highlight__panel js-actions-panel\"\u003E\n\u003Cdiv class=\"highlight__panel-action js-fullscreen-code-action\"\u003E\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"\u003E\u003Ctitle\u003EEnter fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"\u003E\u003Ctitle\u003EExit fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\n\n\n\u003Cp\u003EThen, the user should see a page something like:\u003C\u002Fp\u003E\n\n\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--T_el5DYx--\u002Fc_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880\u002Fhttps:\u002F\u002Fcdn-images-1.medium.com\u002Fmax\u002F1600\u002F1%2AEJhCDDQ-UwSeJIWLj7fn2g.png\" class=\"article-body-image-wrapper\"\u003E\u003Cimg src=\"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--T_el5DYx--\u002Fc_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880\u002Fhttps:\u002F\u002Fcdn-images-1.medium.com\u002Fmax\u002F1600\u002F1%2AEJhCDDQ-UwSeJIWLj7fn2g.png\" alt=\"Checkout page\" loading=\"lazy\"\u003E\u003C\u002Fa\u003E\u003C\u002Fp\u003E\n\n\u003Ch3\u003E\n  \u003Ca name=\"test-3d-secure\" href=\"#test-3d-secure\"\u003E\n  \u003C\u002Fa\u003E\n  Test 3D Secure\n\u003C\u002Fh3\u003E\n\n\u003Cp\u003EUse the test cards listed in \u003Ca href=\"https:\u002F\u002Fstripe.com\u002Fdocs\u002Ftesting#regulatory-cards\"\u003Ethis page\u003C\u002Fa\u003E to test 3D secure.\u003Cbr\u003E\nYou should get a popup iframe during a Checkout session as following:\u003C\u002Fp\u003E\n\n\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--ocBjUpUB--\u002Fc_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880\u002Fhttps:\u002F\u002Fcdn-images-1.medium.com\u002Fmax\u002F1600\u002F1%2AJzHPcrjMVeBsdHeaMiSIvg.png\" class=\"article-body-image-wrapper\"\u003E\u003Cimg src=\"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--ocBjUpUB--\u002Fc_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880\u002Fhttps:\u002F\u002Fcdn-images-1.medium.com\u002Fmax\u002F1600\u002F1%2AJzHPcrjMVeBsdHeaMiSIvg.png\" alt=\"3D secure\" loading=\"lazy\"\u003E\u003C\u002Fa\u003E\u003C\u002Fp\u003E\n\n\u003Cp\u003EPretty neat.\u003C\u002Fp\u003E\n\u003Ch3\u003E\n  \u003Ca name=\"process-new-payment-method\" href=\"#process-new-payment-method\"\u003E\n  \u003C\u002Fa\u003E\n  Process new payment method\n\u003C\u002Fh3\u003E\n\n\u003Cp\u003EAfter the user input the card information, the Checkout redirects to \u003Ccode\u003Esuccess_url\u003C\u002Fcode\u003E. While Stripe automatically attaches the new card to the Customer object, it doesn't anything else for you.\u003C\u002Fp\u003E\n\n\u003Cp\u003ESo, on the \u003Ccode\u003Esuccess_url\u003C\u002Fcode\u003E, the Inkdrop server does the following processes:\u003C\u002Fp\u003E\n\n\u003Col\u003E\n\u003Cli\u003ECheck the card brand is supported\u003C\u002Fli\u003E\n\u003Cli\u003EUse the new card as the default payment method\u003C\u002Fli\u003E\n\u003Cli\u003ERetry payment if necessary\u003C\u002Fli\u003E\n\u003C\u002Fol\u003E\n\n\u003Cp\u003EWhile Stripe accepts JCB cards through the Checkout but Inkdrop doesn't support them, it needs to verify the card brand manually like so:\u003Cbr\u003E\n\u003C\u002Fp\u003E\n\n\u003Cdiv class=\"highlight js-code-highlight\"\u003E\n\u003Cpre class=\"highlight javascript\"\u003E\u003Ccode\u003E\u003Cspan class=\"k\"\u003Eexport\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Easync\u003C\u002Fspan\u003E \u003Cspan class=\"kd\"\u003Efunction\u003C\u002Fspan\u003E \u003Cspan class=\"nx\"\u003EcheckValidPaymentMethod\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\n  \u003Cspan class=\"nx\"\u003EpaymentMethod\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"nb\"\u003EObject\u003C\u002Fspan\u003E\n\u003Cspan class=\"p\"\u003E):\u003C\u002Fspan\u003E \u003Cspan class=\"nb\"\u003EPromise\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&lt;\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E?\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003Estring\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&gt;\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E\n  \u003Cspan class=\"kd\"\u003Econst\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E \u003Cspan class=\"nx\"\u003Ecard\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E}\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"nx\"\u003EpaymentMethod\u003C\u002Fspan\u003E\n  \u003Cspan class=\"k\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003Ecard\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E&amp;&amp;\u003C\u002Fspan\u003E \u003Cspan class=\"nx\"\u003Ecard\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003Ebrand\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003EtoLowerCase\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E()\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E===\u003C\u002Fspan\u003E \u003Cspan class=\"dl\"\u003E'\u003C\u002Fspan\u003E\u003Cspan class=\"s1\"\u003Ejcb\u003C\u002Fspan\u003E\u003Cspan class=\"dl\"\u003E'\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E\n    \u003Cspan class=\"k\"\u003Eawait\u003C\u002Fspan\u003E \u003Cspan class=\"nx\"\u003Estripe\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003EpaymentMethods\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003Edetach\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003EpaymentMethod\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003Eid\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E)\u003C\u002Fspan\u003E\n    \u003Cspan class=\"k\"\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\"dl\"\u003E'\u003C\u002Fspan\u003E\u003Cspan class=\"s1\"\u003Ejcb\u003C\u002Fspan\u003E\u003Cspan class=\"dl\"\u003E'\u003C\u002Fspan\u003E\n  \u003Cspan class=\"p\"\u003E}\u003C\u002Fspan\u003E\n  \u003Cspan class=\"k\"\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\"kc\"\u003Enull\u003C\u002Fspan\u003E\n\u003Cspan class=\"p\"\u003E}\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cdiv class=\"highlight__panel js-actions-panel\"\u003E\n\u003Cdiv class=\"highlight__panel-action js-fullscreen-code-action\"\u003E\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"\u003E\u003Ctitle\u003EEnter fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"\u003E\u003Ctitle\u003EExit fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\n\n\n\u003Cp\u003EIt's necessary to set the new card as the default payment method manually on your server since Stripe only adds it to the customer:\u003Cbr\u003E\n\u003C\u002Fp\u003E\n\n\u003Cdiv class=\"highlight js-code-highlight\"\u003E\n\u003Cpre class=\"highlight javascript\"\u003E\u003Ccode\u003E\u003Cspan class=\"k\"\u003Eawait\u003C\u002Fspan\u003E \u003Cspan class=\"nx\"\u003Estripe\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003Ecustomers\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003Eupdate\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003EpaymentMethod\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003Ecustomer\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E\n  \u003Cspan class=\"na\"\u003Einvoice_settings\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E\n    \u003Cspan class=\"na\"\u003Edefault_payment_method\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"nx\"\u003EpaymentMethod\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003Eid\u003C\u002Fspan\u003E\n  \u003Cspan class=\"p\"\u003E}\u003C\u002Fspan\u003E\n\u003Cspan class=\"p\"\u003E})\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cdiv class=\"highlight__panel js-actions-panel\"\u003E\n\u003Cdiv class=\"highlight__panel-action js-fullscreen-code-action\"\u003E\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"\u003E\u003Ctitle\u003EEnter fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"\u003E\u003Ctitle\u003EExit fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\n\n\n\u003Cp\u003EIt's optional if your website provides a UI to select a default card for users.\u003C\u002Fp\u003E\n\n\u003Cp\u003EIf the user has a past-due invoice, Inkdrop retries to charge it:\u003Cbr\u003E\n\u003C\u002Fp\u003E\n\n\u003Cdiv class=\"highlight js-code-highlight\"\u003E\n\u003Cpre class=\"highlight javascript\"\u003E\u003Ccode\u003E\u003Cspan class=\"kd\"\u003Econst\u003C\u002Fspan\u003E \u003Cspan class=\"nx\"\u003Ecustomer\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Eawait\u003C\u002Fspan\u003E \u003Cspan class=\"nx\"\u003Estripe\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003Ecustomers\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003Eretrieve\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003EcustomerId\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E\n  \u003Cspan class=\"na\"\u003Eexpand\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\"dl\"\u003E'\u003C\u002Fspan\u003E\u003Cspan class=\"s1\"\u003Esubscriptions\u003C\u002Fspan\u003E\u003Cspan class=\"dl\"\u003E'\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E]\u003C\u002Fspan\u003E\n\u003Cspan class=\"p\"\u003E})\u003C\u002Fspan\u003E\n\u003Cspan class=\"kd\"\u003Econst\u003C\u002Fspan\u003E \u003Cspan class=\"nx\"\u003Esubscription\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"nx\"\u003Ecustomer\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003Esubscriptions\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003Edata\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\"mi\"\u003E0\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E]\u003C\u002Fspan\u003E\n\u003Cspan class=\"k\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003Esubscription\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003Elatest_invoice\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E\n  \u003Cspan class=\"kd\"\u003Econst\u003C\u002Fspan\u003E \u003Cspan class=\"nx\"\u003ElatestInvoice\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Eawait\u003C\u002Fspan\u003E \u003Cspan class=\"nx\"\u003Estripe\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003Einvoices\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003Eretrieve\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\n    \u003Cspan class=\"nx\"\u003Esubscription\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003Elatest_invoice\u003C\u002Fspan\u003E\n  \u003Cspan class=\"p\"\u003E)\u003C\u002Fspan\u003E\n  \u003Cspan class=\"k\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003ElatestInvoice\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E&amp;&amp;\u003C\u002Fspan\u003E \u003Cspan class=\"nx\"\u003ElatestInvoice\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003Estatus\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E===\u003C\u002Fspan\u003E \u003Cspan class=\"dl\"\u003E'\u003C\u002Fspan\u003E\u003Cspan class=\"s1\"\u003Eopen\u003C\u002Fspan\u003E\u003Cspan class=\"dl\"\u003E'\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E\n    \u003Cspan class=\"k\"\u003Eawait\u003C\u002Fspan\u003E \u003Cspan class=\"nx\"\u003Estripe\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003Einvoices\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003Epay\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003ElatestInvoice\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003Eid\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E)\u003C\u002Fspan\u003E\n  \u003Cspan class=\"p\"\u003E}\u003C\u002Fspan\u003E\n\u003Cspan class=\"p\"\u003E}\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cdiv class=\"highlight__panel js-actions-panel\"\u003E\n\u003Cdiv class=\"highlight__panel-action js-fullscreen-code-action\"\u003E\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"\u003E\u003Ctitle\u003EEnter fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"\u003E\u003Ctitle\u003EExit fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\n\n\n\u003Ch2\u003E\n  \u003Ca name=\"2-user-starts-paying-before-the-trial-expires\" href=\"#2-user-starts-paying-before-the-trial-expires\"\u003E\n  \u003C\u002Fa\u003E\n  2. User starts paying before the trial expires\n\u003C\u002Fh2\u003E\n\n\u003Cp\u003ESome users may want to finish their free trials and start subscribing to Inkdrop. Users under the free trial would see this:\u003C\u002Fp\u003E\n\n\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--DDBCr7mu--\u002Fc_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880\u002Fhttps:\u002F\u002Fcdn-images-1.medium.com\u002Fmax\u002F2400\u002F1%2A_XcLh1MtinfS4wg-QF4g8w.png\" class=\"article-body-image-wrapper\"\u003E\u003Cimg src=\"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--DDBCr7mu--\u002Fc_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880\u002Fhttps:\u002F\u002Fcdn-images-1.medium.com\u002Fmax\u002F2400\u002F1%2A_XcLh1MtinfS4wg-QF4g8w.png\" alt=\"Free trial\" loading=\"lazy\"\u003E\u003C\u002Fa\u003E\u003C\u002Fp\u003E\n\n\u003Cp\u003ETo provide a way to manually finish their free trials, you have to \u003Cstrong\u003Ecreate another subscription\u003C\u002Fstrong\u003E instead of updating the existing subscription.\u003Cbr\u003E\nActually you can do so during the redirection hook but you shouldn't because there is a UX issue where the price won't be displayed in the Checkout session if you don't specify any \u003Ccode\u003Eline_items\u003C\u002Fcode\u003E just as you saw in \u003Cem\u003Epattern 1\u003C\u002Fem\u003E.\u003Cbr\u003E\nFor example, you will see it tries to charge \u003Cstrong\u003E$0 (¥0)\u003C\u002Fstrong\u003E for the subscription when you use Apple Pay, which is kind of weird:\u003C\u002Fp\u003E\n\n\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--F1469DVP--\u002Fc_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880\u002Fhttps:\u002F\u002Fcdn-images-1.medium.com\u002Fmax\u002F1600\u002F1%2AO2G55FcfxWK1kw0UNrh19A.png\" class=\"article-body-image-wrapper\"\u003E\u003Cimg src=\"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--F1469DVP--\u002Fc_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880\u002Fhttps:\u002F\u002Fcdn-images-1.medium.com\u002Fmax\u002F1600\u002F1%2AO2G55FcfxWK1kw0UNrh19A.png\" alt=\"Apple Pay\" loading=\"lazy\"\u003E\u003C\u002Fa\u003E\u003C\u002Fp\u003E\n\n\u003Cp\u003EI hope Stripe will support updating the existing subscriptions with Checkout, but it isn't supported at the moment.\u003Cbr\u003E\nSo, you have to create another subscription \u003Cem\u003Ewithout a free trial\u003C\u002Fem\u003E and remove the old subscription to accomplish that.\u003C\u002Fp\u003E\n\n\u003Cp\u003EIn this case, create a Checkout session like so:\u003Cbr\u003E\n\u003C\u002Fp\u003E\n\n\u003Cdiv class=\"highlight js-code-highlight\"\u003E\n\u003Cpre class=\"highlight javascript\"\u003E\u003Ccode\u003E\u003Cspan class=\"kd\"\u003Econst\u003C\u002Fspan\u003E \u003Cspan class=\"nx\"\u003Esession\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Eawait\u003C\u002Fspan\u003E \u003Cspan class=\"nx\"\u003Estripe\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003Echeckout\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003Esessions\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003Ecreate\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E({\u003C\u002Fspan\u003E\n  \u003Cspan class=\"na\"\u003Epayment_method_types\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\"dl\"\u003E'\u003C\u002Fspan\u003E\u003Cspan class=\"s1\"\u003Ecard\u003C\u002Fspan\u003E\u003Cspan class=\"dl\"\u003E'\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E],\u003C\u002Fspan\u003E\n  \u003Cspan class=\"na\"\u003Emode\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"dl\"\u003E'\u003C\u002Fspan\u003E\u003Cspan class=\"s1\"\u003Esubscription\u003C\u002Fspan\u003E\u003Cspan class=\"dl\"\u003E'\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E\n  \u003Cspan class=\"na\"\u003Ecustomer\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"nx\"\u003EcustomerId\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E\n  \u003Cspan class=\"na\"\u003Esuccess_url\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"nx\"\u003EredirectSuccessUrl\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E\n  \u003Cspan class=\"na\"\u003Ecancel_url\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"nx\"\u003Econfig\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003Eapp\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003EbaseUrl\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E+\u003C\u002Fspan\u003E \u003Cspan class=\"nx\"\u003Ecancel_url\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E\n  \u003Cspan class=\"na\"\u003Ebilling_address_collection\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"nx\"\u003EneedsBillingAddress\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E?\u003C\u002Fspan\u003E \u003Cspan class=\"dl\"\u003E'\u003C\u002Fspan\u003E\u003Cspan class=\"s1\"\u003Erequired\u003C\u002Fspan\u003E\u003Cspan class=\"dl\"\u003E'\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"dl\"\u003E'\u003C\u002Fspan\u003E\u003Cspan class=\"s1\"\u003Eauto\u003C\u002Fspan\u003E\u003Cspan class=\"dl\"\u003E'\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E\n  \u003Cspan class=\"na\"\u003Eline_items\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E[\u003C\u002Fspan\u003E\n    \u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E\n      \u003Cspan class=\"na\"\u003Eprice\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"nx\"\u003Eplan\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E\n      \u003Cspan class=\"na\"\u003Equantity\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"mi\"\u003E1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E\n      \u003Cspan class=\"na\"\u003Etax_rates\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E[\u003C\u002Fspan\u003E\n        \u003Cspan class=\"nx\"\u003Ecustomer\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003Emetadata\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003Ecountry\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E===\u003C\u002Fspan\u003E \u003Cspan class=\"dl\"\u003E'\u003C\u002Fspan\u003E\u003Cspan class=\"s1\"\u003Ejapan\u003C\u002Fspan\u003E\u003Cspan class=\"dl\"\u003E'\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E?\u003C\u002Fspan\u003E \u003Cspan class=\"nx\"\u003EtaxRateJpn\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"nx\"\u003EtaxRateZero\u003C\u002Fspan\u003E\n      \u003Cspan class=\"p\"\u003E]\u003C\u002Fspan\u003E\n    \u003Cspan class=\"p\"\u003E}\u003C\u002Fspan\u003E\n  \u003Cspan class=\"p\"\u003E]\u003C\u002Fspan\u003E\n\u003Cspan class=\"p\"\u003E})\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cdiv class=\"highlight__panel js-actions-panel\"\u003E\n\u003Cdiv class=\"highlight__panel-action js-fullscreen-code-action\"\u003E\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"\u003E\u003Ctitle\u003EEnter fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"\u003E\u003Ctitle\u003EExit fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\n\n\n\u003Cul\u003E\n\u003Cli\u003E\n\u003Ccode\u003Emode\u003C\u002Fcode\u003E - It must be \u003Ccode\u003Esubscription\u003C\u002Fcode\u003E\n\u003C\u002Fli\u003E\n\u003Cli\u003E\n\u003Ccode\u003Eline_items\u003C\u002Fcode\u003E - A product to newly subscribe\u003C\u002Fli\u003E\n\u003C\u002Ful\u003E\n\n\u003Cp\u003EAs Stripe doesn't support \u003Ca href=\"https:\u002F\u002Fstripe.com\u002Fdocs\u002Fpayments\u002Fcheckout\u002Ftaxes#dynamic-tax-rates\"\u003Edynamic tax rates\u003C\u002Fa\u003E in Japan, I had to implement it myself (Please support it!). People from outside Japan are exempt from payment of a consumption tax if your business is based in Japan.\u003C\u002Fp\u003E\n\n\u003Cp\u003EBy doing so, users can see the price like this:\u003C\u002Fp\u003E\n\n\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--4S6jTdm_--\u002Fc_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880\u002Fhttps:\u002F\u002Fcdn-images-1.medium.com\u002Fmax\u002F2400\u002F1%2A2jEzJAhtJIAAfUC32FhaYg.png\" class=\"article-body-image-wrapper\"\u003E\u003Cimg src=\"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--4S6jTdm_--\u002Fc_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880\u002Fhttps:\u002F\u002Fcdn-images-1.medium.com\u002Fmax\u002F2400\u002F1%2A2jEzJAhtJIAAfUC32FhaYg.png\" alt=\"Stripe checkout with a subscription item\" loading=\"lazy\"\u003E\u003C\u002Fa\u003E\u003Cbr\u003E\nAfter a successful checkout, you can cancel the old subscription during the redirection hook:\u003Cbr\u003E\n\u003C\u002Fp\u003E\n\n\u003Cdiv class=\"highlight js-code-highlight\"\u003E\n\u003Cpre class=\"highlight javascript\"\u003E\u003Ccode\u003E\u003Cspan class=\"k\"\u003Eexport\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Easync\u003C\u002Fspan\u003E \u003Cspan class=\"kd\"\u003Efunction\u003C\u002Fspan\u003E \u003Cspan class=\"nx\"\u003EremoveOldSubscriptions\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\n  \u003Cspan class=\"nx\"\u003EcustomerId\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"nx\"\u003Estring\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E\n  \u003Cspan class=\"nx\"\u003EnewSubscription\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"nx\"\u003Estring\u003C\u002Fspan\u003E\n\u003Cspan class=\"p\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E\n  \u003Cspan class=\"kd\"\u003Econst\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E \u003Cspan class=\"na\"\u003Edata\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"nx\"\u003Esubscriptions\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E}\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Eawait\u003C\u002Fspan\u003E \u003Cspan class=\"nx\"\u003Estripe\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003Esubscriptions\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003Elist\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E({\u003C\u002Fspan\u003E\n    \u003Cspan class=\"na\"\u003Ecustomer\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"nx\"\u003EcustomerId\u003C\u002Fspan\u003E\n  \u003Cspan class=\"p\"\u003E})\u003C\u002Fspan\u003E\n  \u003Cspan class=\"kd\"\u003Econst\u003C\u002Fspan\u003E \u003Cspan class=\"nx\"\u003EactiveStatus\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Enew\u003C\u002Fspan\u003E \u003Cspan class=\"nb\"\u003ESet\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E([\u003C\u002Fspan\u003E\u003Cspan class=\"dl\"\u003E'\u003C\u002Fspan\u003E\u003Cspan class=\"s1\"\u003Etrialing\u003C\u002Fspan\u003E\u003Cspan class=\"dl\"\u003E'\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"dl\"\u003E'\u003C\u002Fspan\u003E\u003Cspan class=\"s1\"\u003Eactive\u003C\u002Fspan\u003E\u003Cspan class=\"dl\"\u003E'\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"dl\"\u003E'\u003C\u002Fspan\u003E\u003Cspan class=\"s1\"\u003Epast_due\u003C\u002Fspan\u003E\u003Cspan class=\"dl\"\u003E'\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E])\u003C\u002Fspan\u003E\n  \u003Cspan class=\"k\"\u003Efor\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"kd\"\u003Econst\u003C\u002Fspan\u003E \u003Cspan class=\"nx\"\u003Esub\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Eof\u003C\u002Fspan\u003E \u003Cspan class=\"nx\"\u003Esubscriptions\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E\n    \u003Cspan class=\"k\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003Esub\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003Eid\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E!==\u003C\u002Fspan\u003E \u003Cspan class=\"nx\"\u003EnewSubscription\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E\n      \u003Cspan class=\"k\"\u003Eawait\u003C\u002Fspan\u003E \u003Cspan class=\"nx\"\u003Estripe\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003Esubscriptions\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003Edel\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003Esub\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003Eid\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E)\u003C\u002Fspan\u003E\n    \u003Cspan class=\"p\"\u003E}\u003C\u002Fspan\u003E\n  \u003Cspan class=\"p\"\u003E}\u003C\u002Fspan\u003E\n\u003Cspan class=\"p\"\u003E}\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cdiv class=\"highlight__panel js-actions-panel\"\u003E\n\u003Cdiv class=\"highlight__panel-action js-fullscreen-code-action\"\u003E\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"\u003E\u003Ctitle\u003EEnter fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"\u003E\u003Ctitle\u003EExit fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\n\n\n\u003Ch2\u003E\n  \u003Ca name=\"3-trial-has-been-expired\" href=\"#3-trial-has-been-expired\"\u003E\n  \u003C\u002Fa\u003E\n  3. Trial has been expired\n\u003C\u002Fh2\u003E\n\n\u003Cp\u003EThis is similar to the pattern 2. Again, Checkout doesn't allow to update the existing subscription directly, you have to re-create a subscription for better UX. For that reason, you can't charge immediately from the trial expiration date. The subscription starts just on a day when the user input the card information.\u003C\u002Fp\u003E\n\n\u003Ch3\u003E\n  \u003Ca name=\"notify-users-of-the-trial-expiration-with-webhook\" href=\"#notify-users-of-the-trial-expiration-with-webhook\"\u003E\n  \u003C\u002Fa\u003E\n  Notify users of the trial expiration with webhook\n\u003C\u002Fh3\u003E\n\n\u003Cp\u003EIt'd be nice to kindly notify users that their trial has been expired.\u003C\u002Fp\u003E\n\n\u003Cp\u003E\u003Cstrong\u003EDo not send payment failure notifications\u003C\u002Fstrong\u003E because they will be surprised and get angry! In the early days, I got some complaints, screaming like \"It's a scam! 😡\" because they haven't intended to buy or inputted card information (yet). You need to kindly notify their trial expired instead.\u003Cbr\u003E\nI couldn't find that Stripe supports it, so I implemented it myself.\u003C\u002Fp\u003E\n\n\u003Cp\u003ETo accomplish that: When the trial expired and the user hasn't inputted a card, the first payment fails and an event \u003Ca href=\"https:\u002F\u002Fstripe.com\u002Fdocs\u002Fapi\u002Fevents\u002Ftypes#event_types-invoice.payment_failed\"\u003E\u003Ccode\u003Einvoice.payment_failed\u003C\u002Fcode\u003E\u003C\u002Fa\u003E fires.\u003Cbr\u003E\nYou can know the event through webhook.\u003Cbr\u003E\nIn your webhook, check if the user has any cards attached like so:\u003Cbr\u003E\n\u003C\u002Fp\u003E\n\n\u003Cdiv class=\"highlight js-code-highlight\"\u003E\n\u003Cpre class=\"highlight javascript\"\u003E\u003Ccode\u003E\u003Cspan class=\"k\"\u003Eexport\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Easync\u003C\u002Fspan\u003E \u003Cspan class=\"kd\"\u003Efunction\u003C\u002Fspan\u003E \u003Cspan class=\"nx\"\u003EcheckCustomerHasPaymentMethod\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\n  \u003Cspan class=\"nx\"\u003EcustomerId\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"nx\"\u003Estring\u003C\u002Fspan\u003E\n\u003Cspan class=\"p\"\u003E):\u003C\u002Fspan\u003E \u003Cspan class=\"nb\"\u003EPromise\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&lt;\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003Eboolean\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&gt;\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E\n  \u003Cspan class=\"kd\"\u003Econst\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E \u003Cspan class=\"na\"\u003Edata\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"nx\"\u003EpaymentMethods\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E}\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Eawait\u003C\u002Fspan\u003E \u003Cspan class=\"nx\"\u003Estripe\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003EpaymentMethods\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003Elist\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E({\u003C\u002Fspan\u003E\n    \u003Cspan class=\"na\"\u003Ecustomer\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"nx\"\u003EcustomerId\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E\n    \u003Cspan class=\"na\"\u003Etype\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"dl\"\u003E'\u003C\u002Fspan\u003E\u003Cspan class=\"s1\"\u003Ecard\u003C\u002Fspan\u003E\u003Cspan class=\"dl\"\u003E'\u003C\u002Fspan\u003E\n  \u003Cspan class=\"p\"\u003E})\u003C\u002Fspan\u003E\n  \u003Cspan class=\"k\"\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\"nx\"\u003EpaymentMethods\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003Elength\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E&gt;\u003C\u002Fspan\u003E \u003Cspan class=\"mi\"\u003E0\u003C\u002Fspan\u003E\n\u003Cspan class=\"p\"\u003E}\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cdiv class=\"highlight__panel js-actions-panel\"\u003E\n\u003Cdiv class=\"highlight__panel-action js-fullscreen-code-action\"\u003E\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"\u003E\u003Ctitle\u003EEnter fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"\u003E\u003Ctitle\u003EExit fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\n\n\n\u003Cp\u003EIf the user doesn't have a card, then check the number of charge attempts. If it was the first attempt, lock the account like so:\u003Cbr\u003E\n\u003C\u002Fp\u003E\n\n\u003Cdiv class=\"highlight js-code-highlight\"\u003E\n\u003Cpre class=\"highlight javascript\"\u003E\u003Ccode\u003E\u003Cspan class=\"kd\"\u003Econst\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E \u003Cspan class=\"na\"\u003Eobject\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"nx\"\u003Einvoice\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E}\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"nx\"\u003Eevent\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003Edata\u003C\u002Fspan\u003E \u003Cspan class=\"c1\"\u003E\u002F\u002F invoice.payment_failed\u003C\u002Fspan\u003E\n\u003Cspan class=\"kd\"\u003Econst\u003C\u002Fspan\u003E \u003Cspan class=\"nx\"\u003Ecustomer\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Eawait\u003C\u002Fspan\u003E \u003Cspan class=\"nx\"\u003Estripe\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003Ecustomers\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003Eretrieve\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003Einvoice\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003Ecustomer\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E)\u003C\u002Fspan\u003E\n\u003Cspan class=\"c1\"\u003E\u002F\u002F first attempt\u003C\u002Fspan\u003E\n\u003Cspan class=\"k\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003Einvoice\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003Eattempt_count\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E===\u003C\u002Fspan\u003E \u003Cspan class=\"mi\"\u003E1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E\n  \u003Cspan class=\"c1\"\u003E\u002F\u002F do things you need\u003C\u002Fspan\u003E\n  \u003Cspan class=\"nx\"\u003EnotifyTrialExpired\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003Ecustomer\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E)\u003C\u002Fspan\u003E\n\u003Cspan class=\"p\"\u003E}\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cdiv class=\"highlight__panel js-actions-panel\"\u003E\n\u003Cdiv class=\"highlight__panel-action js-fullscreen-code-action\"\u003E\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"\u003E\u003Ctitle\u003EEnter fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"\u003E\u003Ctitle\u003EExit fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\n\n\n\u003Cp\u003EI also display the notification about the expiration on the website like this:\u003C\u002Fp\u003E\n\n\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--grrASile--\u002Fc_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880\u002Fhttps:\u002F\u002Fcdn-images-1.medium.com\u002Fmax\u002F1600\u002F1%2AdPWvjDMfv8bNuOEEHUIsOQ.png\" class=\"article-body-image-wrapper\"\u003E\u003Cimg src=\"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--grrASile--\u002Fc_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880\u002Fhttps:\u002F\u002Fcdn-images-1.medium.com\u002Fmax\u002F1600\u002F1%2AdPWvjDMfv8bNuOEEHUIsOQ.png\" alt=\"trial expired notification\" loading=\"lazy\"\u003E\u003C\u002Fa\u003E\u003C\u002Fp\u003E\n\n\u003Ch2\u003E\n  \u003Ca name=\"4-account-has-been-deactivated\" href=\"#4-account-has-been-deactivated\"\u003E\n  \u003C\u002Fa\u003E\n  4. Account has been deactivated\n\u003C\u002Fh2\u003E\n\n\u003Cp\u003EA customer's subscription is canceled when all charge retries for a payment failed as I configured Stripe like this from \u003Cem\u003ESettings -&gt; Subscriptions and emails -&gt; Manage failed payments for subscriptions\u003C\u002Fem\u003E:\u003C\u002Fp\u003E\n\n\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--fB-W73X6--\u002Fc_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880\u002Fhttps:\u002F\u002Fcdn-images-1.medium.com\u002Fmax\u002F1600\u002F1%2AnGG4dLrd4H8A_7vqwjespQ.png\" class=\"article-body-image-wrapper\"\u003E\u003Cimg src=\"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--fB-W73X6--\u002Fc_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880\u002Fhttps:\u002F\u002Fcdn-images-1.medium.com\u002Fmax\u002F1600\u002F1%2AnGG4dLrd4H8A_7vqwjespQ.png\" alt=\"subscription status\" loading=\"lazy\"\u003E\u003C\u002Fa\u003E\u003C\u002Fp\u003E\n\n\u003Cp\u003EOn the website, it displays the account has been deactivated:\u003C\u002Fp\u003E\n\n\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--d__-66Xq--\u002Fc_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880\u002Fhttps:\u002F\u002Fcdn-images-1.medium.com\u002Fmax\u002F1600\u002F1%2ACVwYMynuAH4YtZDziTRvUQ.png\" class=\"article-body-image-wrapper\"\u003E\u003Cimg src=\"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--d__-66Xq--\u002Fc_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880\u002Fhttps:\u002F\u002Fcdn-images-1.medium.com\u002Fmax\u002F1600\u002F1%2ACVwYMynuAH4YtZDziTRvUQ.png\" alt=\"deactivated\" loading=\"lazy\"\u003E\u003C\u002Fa\u003E\u003C\u002Fp\u003E\n\n\u003Cp\u003ETo reactivate the account, you can simply create a new subscription via the Checkout. Then, process the account to reactivate in your server.\u003C\u002Fp\u003E\n\n\u003Ch2\u003E\n  \u003Ca name=\"changing-the-plan-monthly-%E2%87%84-yearly\" href=\"#changing-the-plan-monthly-%E2%87%84-yearly\"\u003E\n  \u003C\u002Fa\u003E\n  Changing the plan (Monthly ⇄ Yearly)\n\u003C\u002Fh2\u003E\n\n\u003Cp\u003EInkdrop provides monthly and annual plans.\u003Cbr\u003E\nUsers can change it anytime.\u003Cbr\u003E\nTo change the existing subscription:\u003Cbr\u003E\n\u003C\u002Fp\u003E\n\n\u003Cdiv class=\"highlight js-code-highlight\"\u003E\n\u003Cpre class=\"highlight javascript\"\u003E\u003Ccode\u003E\u003Cspan class=\"kd\"\u003Econst\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E \u003Cspan class=\"nx\"\u003Esubscription\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"nx\"\u003Ecustomer\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E}\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Eawait\u003C\u002Fspan\u003E \u003Cspan class=\"nx\"\u003EgetSubscription\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003EuserId\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E\n  \u003Cspan class=\"na\"\u003EignoreNoSubscriptions\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"kc\"\u003Efalse\u003C\u002Fspan\u003E\n\u003Cspan class=\"p\"\u003E})\u003C\u002Fspan\u003E\n\u003Cspan class=\"kd\"\u003Econst\u003C\u002Fspan\u003E \u003Cspan class=\"nx\"\u003Eitem\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"nx\"\u003Esubscription\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003Eitems\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003Edata\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\"mi\"\u003E0\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E]\u003C\u002Fspan\u003E\n\u003Cspan class=\"kd\"\u003Econst\u003C\u002Fspan\u003E \u003Cspan class=\"nx\"\u003Eparams\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"nb\"\u003EObject\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E\n  \u003Cspan class=\"na\"\u003Ecancel_at_period_end\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"kc\"\u003Efalse\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E\n  \u003Cspan class=\"c1\"\u003E\u002F\u002F avoid double-charge\u003C\u002Fspan\u003E\n  \u003Cspan class=\"na\"\u003Eproration_behavior\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"dl\"\u003E'\u003C\u002Fspan\u003E\u003Cspan class=\"s1\"\u003Ecreate_prorations\u003C\u002Fspan\u003E\u003Cspan class=\"dl\"\u003E'\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E\n  \u003Cspan class=\"na\"\u003Eitems\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E[\u003C\u002Fspan\u003E\n    \u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E\n      \u003Cspan class=\"na\"\u003Eid\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"nx\"\u003Eitem\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003Eid\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"c1\"\u003E\u002F\u002F do not forget!\u003C\u002Fspan\u003E\n      \u003Cspan class=\"na\"\u003Eprice\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"nx\"\u003Eplan\u003C\u002Fspan\u003E\n    \u003Cspan class=\"p\"\u003E}\u003C\u002Fspan\u003E\n  \u003Cspan class=\"p\"\u003E]\u003C\u002Fspan\u003E\n\u003Cspan class=\"p\"\u003E}\u003C\u002Fspan\u003E\n\u003Cspan class=\"c1\"\u003E\u002F\u002F If the free trial remains, specify the same `trial_end` value\u003C\u002Fspan\u003E\n\u003Cspan class=\"k\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003Esubscription\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003Etrial_end\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E&gt;\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E+\u003C\u002Fspan\u003E\u003Cspan class=\"k\"\u003Enew\u003C\u002Fspan\u003E \u003Cspan class=\"nb\"\u003EDate\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E()\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E\u002F\u003C\u002Fspan\u003E \u003Cspan class=\"mi\"\u003E1000\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E\n  \u003Cspan class=\"nx\"\u003Eparams\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003Etrial_end\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"nx\"\u003Esubscription\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003Etrial_end\u003C\u002Fspan\u003E\n\u003Cspan class=\"p\"\u003E}\u003C\u002Fspan\u003E\n\u003Cspan class=\"kd\"\u003Econst\u003C\u002Fspan\u003E \u003Cspan class=\"nx\"\u003EnewSubscription\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Eawait\u003C\u002Fspan\u003E \u003Cspan class=\"nx\"\u003Estripe\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003Esubscriptions\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003Eupdate\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\n  \u003Cspan class=\"nx\"\u003Esubscription\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003Eid\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E\n  \u003Cspan class=\"nx\"\u003Eparams\u003C\u002Fspan\u003E\n\u003Cspan class=\"p\"\u003E)\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cdiv class=\"highlight__panel js-actions-panel\"\u003E\n\u003Cdiv class=\"highlight__panel-action js-fullscreen-code-action\"\u003E\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"\u003E\u003Ctitle\u003EEnter fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"\u003E\u003Ctitle\u003EExit fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\n\n\n\u003Ch2\u003E\n  \u003Ca name=\"when-required-3d-secure-for-renewing-the-subscription\" href=\"#when-required-3d-secure-for-renewing-the-subscription\"\u003E\n  \u003C\u002Fa\u003E\n  When required 3D secure for renewing the subscription\n\u003C\u002Fh2\u003E\n\n\u003Cp\u003EStripe supports an option \"\u003Ca href=\"https:\u002F\u002Fstripe.com\u002Fdocs\u002Finvoicing\u002Fpaying#send-3dsecure-emails\"\u003ESend a Stripe-hosted link for cardholders to authenticate when required\u003C\u002Fa\u003E\".\u003Cbr\u003E\nSo, Stripe will automatically send a notification email to your users when required an additional action to complete the payment.\u003Cbr\u003E\nBut, it'd be also nice to display the notification on the website like so:\u003C\u002Fp\u003E\n\n\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--6BrgQQ0d--\u002Fc_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880\u002Fhttps:\u002F\u002Fcdn-images-1.medium.com\u002Fmax\u002F1600\u002F1%2AGwZm1eJWiEi5xUhWzs-9Ow.png\" class=\"article-body-image-wrapper\"\u003E\u003Cimg src=\"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--6BrgQQ0d--\u002Fc_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880\u002Fhttps:\u002F\u002Fcdn-images-1.medium.com\u002Fmax\u002F1600\u002F1%2AGwZm1eJWiEi5xUhWzs-9Ow.png\" alt=\"3D secure auth required\" loading=\"lazy\"\u003E\u003C\u002Fa\u003E\u003C\u002Fp\u003E\n\n\u003Cp\u003EYou can determine if the payment needs 3D secure authentication like so:\u003Cbr\u003E\n\u003C\u002Fp\u003E\n\n\u003Cdiv class=\"highlight js-code-highlight\"\u003E\n\u003Cpre class=\"highlight javascript\"\u003E\u003Ccode\u003E\u003Cspan class=\"nx\"\u003Esubscription\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003Estatus\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E===\u003C\u002Fspan\u003E \u003Cspan class=\"dl\"\u003E'\u003C\u002Fspan\u003E\u003Cspan class=\"s1\"\u003Epast_due\u003C\u002Fspan\u003E\u003Cspan class=\"dl\"\u003E'\u003C\u002Fspan\u003E\n\u003Cspan class=\"kd\"\u003Econst\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E \u003Cspan class=\"na\"\u003Elatest_invoice\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"nx\"\u003ElatestInvoice\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E}\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"nx\"\u003Esubscription\u003C\u002Fspan\u003E\n\u003Cspan class=\"kd\"\u003Econst\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E \u003Cspan class=\"na\"\u003Epayment_intent\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"nx\"\u003EpaymentIntent\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E}\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"nx\"\u003ElatestInvoice\u003C\u002Fspan\u003E\n\n\u003Cspan class=\"k\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\n  \u003Cspan class=\"k\"\u003Etypeof\u003C\u002Fspan\u003E \u003Cspan class=\"nx\"\u003EpaymentIntent\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E===\u003C\u002Fspan\u003E \u003Cspan class=\"dl\"\u003E'\u003C\u002Fspan\u003E\u003Cspan class=\"s1\"\u003Eobject\u003C\u002Fspan\u003E\u003Cspan class=\"dl\"\u003E'\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E&amp;&amp;\u003C\u002Fspan\u003E\n  \u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003EpaymentIntent\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003Estatus\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E===\u003C\u002Fspan\u003E \u003Cspan class=\"dl\"\u003E'\u003C\u002Fspan\u003E\u003Cspan class=\"s1\"\u003Erequires_source_action\u003C\u002Fspan\u003E\u003Cspan class=\"dl\"\u003E'\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E||\u003C\u002Fspan\u003E\n    \u003Cspan class=\"nx\"\u003EpaymentIntent\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003Estatus\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E===\u003C\u002Fspan\u003E \u003Cspan class=\"dl\"\u003E'\u003C\u002Fspan\u003E\u003Cspan class=\"s1\"\u003Erequires_action\u003C\u002Fspan\u003E\u003Cspan class=\"dl\"\u003E'\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E&amp;&amp;\u003C\u002Fspan\u003E\n  \u003Cspan class=\"nx\"\u003EpaymentIntent\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003Enext_action\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E&amp;&amp;\u003C\u002Fspan\u003E\n  \u003Cspan class=\"nx\"\u003EpaymentIntent\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003Eclient_secret\u003C\u002Fspan\u003E\n\u003Cspan class=\"p\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E\n  \u003Cspan class=\"nx\"\u003Econsole\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003Elog\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"dl\"\u003E'\u003C\u002Fspan\u003E\u003Cspan class=\"s1\"\u003EAction required\u003C\u002Fspan\u003E\u003Cspan class=\"dl\"\u003E'\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E)\u003C\u002Fspan\u003E\n\u003Cspan class=\"p\"\u003E}\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cdiv class=\"highlight__panel js-actions-panel\"\u003E\n\u003Cdiv class=\"highlight__panel-action js-fullscreen-code-action\"\u003E\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"\u003E\u003Ctitle\u003EEnter fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"\u003E\u003Ctitle\u003EExit fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\n\n\n\u003Cp\u003EThen, proceed to 3D secure authentication by calling \u003Ca href=\"https:\u002F\u002Fstripe.com\u002Fdocs\u002Fjs\u002Fpayment_intents\u002Fconfirm_card_payment\"\u003E\u003Ccode\u003EconfirmCardPayment\u003C\u002Fcode\u003E\u003C\u002Fa\u003E:\u003Cbr\u003E\n\u003C\u002Fp\u003E\n\n\u003Cdiv class=\"highlight js-code-highlight\"\u003E\n\u003Cpre class=\"highlight javascript\"\u003E\u003Ccode\u003E\u003Cspan class=\"kd\"\u003Econst\u003C\u002Fspan\u003E \u003Cspan class=\"nx\"\u003Eres\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Eawait\u003C\u002Fspan\u003E \u003Cspan class=\"nx\"\u003Estripe\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003EconfirmCardPayment\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003EpaymentIntent\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"nx\"\u003Eclient_secret\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E)\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cdiv class=\"highlight__panel js-actions-panel\"\u003E\n\u003Cdiv class=\"highlight__panel-action js-fullscreen-code-action\"\u003E\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-on\"\u003E\u003Ctitle\u003EEnter fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n    \u003Csvg xmlns=\"http:\u002F\u002Fwww.w3.org\u002F2000\u002Fsvg\" width=\"20px\" height=\"20px\" viewbox=\"0 0 24 24\" class=\"highlight-action crayons-icon highlight-action--fullscreen-off\"\u003E\u003Ctitle\u003EExit fullscreen mode\u003C\u002Ftitle\u003E\n    \u003Cpath d=\"M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z\"\u003E\u003C\u002Fpath\u003E\n\u003C\u002Fsvg\u003E\n\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\u003C\u002Fdiv\u003E\n\n\n\n\u003Ch2\u003E\n  \u003Ca name=\"upgrade-the-api-version\" href=\"#upgrade-the-api-version\"\u003E\n  \u003C\u002Fa\u003E\n  Upgrade the API version\n\u003C\u002Fh2\u003E\n\n\u003Cp\u003EWhen everything is ready to roll out, it's time to upgrade the API version. \u003Cbr\u003E\nIf you are using the old API version, you have to upgrade it to the latest version from \u003Cem\u003EDevelopers -&gt; API version\u003C\u002Fem\u003E. You should see the upgrade button if you are on the old one.\u003Cbr\u003E\nBe careful to do this because it immediately affects your production environment!\u003C\u002Fp\u003E\n\n\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--aAVLE4es--\u002Fc_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880\u002Fhttps:\u002F\u002Fcdn-images-1.medium.com\u002Fmax\u002F1600\u002F1%2A1Jk_YvpdVXydUrq-Wde6jQ.png\" class=\"article-body-image-wrapper\"\u003E\u003Cimg src=\"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--aAVLE4es--\u002Fc_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880\u002Fhttps:\u002F\u002Fcdn-images-1.medium.com\u002Fmax\u002F1600\u002F1%2A1Jk_YvpdVXydUrq-Wde6jQ.png\" alt=\"API Version\" loading=\"lazy\"\u003E\u003C\u002Fa\u003E\u003Cbr\u003E\nI hope Stripe will allow testing the new API before upgrading it because I had many unexpected errors when switching it, which I left a sour taste in my mouth:\u003C\u002Fp\u003E\n\n\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--gPlFFJkH--\u002Fc_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880\u002Fhttps:\u002F\u002Fcdn-images-1.medium.com\u002Fmax\u002F1600\u002F1%2ApWqlx1KSQIs04Safiwbuzw.png\" class=\"article-body-image-wrapper\"\u003E\u003Cimg src=\"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--gPlFFJkH--\u002Fc_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880\u002Fhttps:\u002F\u002Fcdn-images-1.medium.com\u002Fmax\u002F1600\u002F1%2ApWqlx1KSQIs04Safiwbuzw.png\" alt=\"API failures\" loading=\"lazy\"\u003E\u003C\u002Fa\u003E\u003C\u002Fp\u003E\n\n\u003Ch2\u003E\n  \u003Ca name=\"its-never-been-such-simple-without-stripe\" href=\"#its-never-been-such-simple-without-stripe\"\u003E\n  \u003C\u002Fa\u003E\n  It's never been such simple without Stripe\n\u003C\u002Fh2\u003E\n\n\u003Cp\u003EI've implemented credit card payments with PayPal in the past but it was so complicated and hard. The documentation was not clear to understand.\u003Cbr\u003E\nStripe is so easy to integrate compared to that.\u003Cbr\u003E\nI still have some small issues as I mentioned in the article, but I'm basically happy with Stripe.\u003Cbr\u003E\nBesides, Stripe's website, dashboard, and mobile app are so beautiful and I've got a lot of inspiration from them.\u003Cbr\u003E\nYou will learn their good UX practices while building your product with Stripe.\u003C\u002Fp\u003E\n\n\u003Cp\u003EThat's it! I hope it's helpful for building your SaaS business.\u003C\u002Fp\u003E\n\n\u003Ch4\u003E\n  \u003Ca name=\"follow-me-online\" href=\"#follow-me-online\"\u003E\n  \u003C\u002Fa\u003E\n  Follow me online\n\u003C\u002Fh4\u003E\n\n\u003Cul\u003E\n\u003Cli\u003ECheck out my app called \u003Ca href=\"https:\u002F\u002Fwww.inkdrop.app\u002F\"\u003EInkdrop - A Markdown note-taking app\u003C\u002Fa\u003E\n\u003C\u002Fli\u003E\n\u003Cli\u003ESubscribe Newsletter \u003Ca href=\"http:\u002F\u002Feepurl.com\u002FdNgJo6\"\u003Ehttp:\u002F\u002Feepurl.com\u002FdNgJo6\u003C\u002Fa\u003E\n\u003C\u002Fli\u003E\n\u003Cli\u003ETwitter \u003Ca href=\"https:\u002F\u002Ftwitter.com\u002Finkdrop_app\"\u003Ehttps:\u002F\u002Ftwitter.com\u002Finkdrop_app\u003C\u002Fa\u003E\n\u003C\u002Fli\u003E\n\u003Cli\u003EBlog \u003Ca href=\"https:\u002F\u002Fblog.inkdrop.info\u002F\"\u003Ehttps:\u002F\u002Fblog.inkdrop.info\u002F\u003C\u002Fa\u003E\n\u003C\u002Fli\u003E\n\u003Cli\u003EDiscord community \u003Ca href=\"https:\u002F\u002Fdiscord.gg\u002FQfsG5Kj\"\u003Ehttps:\u002F\u002Fdiscord.gg\u002FQfsG5Kj\u003C\u002Fa\u003E\n\u003C\u002Fli\u003E\n\u003Cli\u003EInstagram \u003Ca href=\"https:\u002F\u002Finstagram.com\u002Fcraftzdog\"\u003Ehttps:\u002F\u002Finstagram.com\u002Fcraftzdog\u003C\u002Fa\u003E\n\u003C\u002Fli\u003E\n\u003C\u002Ful\u003E\n\n";b.body_markdown="Hi, it's [Takuya](https:\u002F\u002Ftwitter.com\u002Finkdrop_app) from Japan.\n\nI'm running a SaaS app called [Inkdrop](https:\u002F\u002Fwww.inkdrop.app\u002F) which is a subscription-based service.\nI use [Stripe](http:\u002F\u002Fstripe.com\u002F) to accept payments with credit cards around the world.\nRecently, I've got an email from Stripe that users can't renew their subscriptions under RBI regulations in India if your website doesn't support 3D secure:\n\nhttps:\u002F\u002Fsupport.stripe.com\u002Fquestions\u002Fimportant-updates-to-rbi-regulations-on-recurring-card-payments-in-india\n\nThat's going to affect my service since I have customers from India.\nSo, I decided to support 3D secure authentication on my website.\n\nIn terms of implementation, there are several ways to implement a card form for recurring payments.\nIf you are already using [Stripe Checkout](https:\u002F\u002Fstripe.com\u002Fdocs\u002Fbilling\u002Fsubscriptions\u002Fcheckout), it's easy. All you have to do is [enable 3D Secure](https:\u002F\u002Fsupport.stripe.com\u002Fquestions\u002Fimportant-updates-to-rbi-regulations-on-recurring-card-payments-in-india) in your Billing settings. Then, Stripe basically does all nicely for you.\nHowever, I was using [Stripe Elements](https:\u002F\u002Fstripe.com\u002Fen-jp\u002Fpayments\u002Felements) and [Sources API](https:\u002F\u002Fstripe.com\u002Fdocs\u002Fsources) to provide a credit card form. While it provides [highly customizable form components](https:\u002F\u002Fstripe.dev\u002Felements-examples\u002F), [it requires an additional complicated implementation](https:\u002F\u002Fstripe.com\u002Fdocs\u002Fpayments\u002F3d-secure#confirm-payment-intent) for 3D secure authentication. Besides, the Sources API is [no longer recommended](https:\u002F\u002Fstripe.com\u002Fdocs\u002Fpayments\u002Fpayment-methods\u002Ftransitioning).\nLooks like my code is old since I've implemented it several years ago.\nI thought it's time to switch my payment logic from Stripe Elements to Stripe Checkout.\n\nIn this article, I'll share how I migrated from Stripe Elements to Stripe Checkout. It'd be also helpful for those who are planning to adopt Stripe Checkout for your website. Let's get started.\n\n## Understand a new way to set up future payments\n\nI was so confused when reading Stripe's documentation because my knowledge was outdated.\nThere are several new APIs you have to understand:\n\n* [Payment Methods](https:\u002F\u002Fstripe.com\u002Fdocs\u002Fpayments\u002Fpayment-methods)\n* [Setup Intents](https:\u002F\u002Fstripe.com\u002Fdocs\u002Fpayments\u002Fsetup-intents)\n* [Checkout Sessions](https:\u002F\u002Fstripe.com\u002Fdocs\u002Fapi\u002Fcheckout\u002Fsessions)\n\nI try to explain them as simple as possible:\nYou've been able to use card tokens retrieved via the Sources API for recurring payments.\nBut the Sources are now replaced with Payment methods and Setup intents.\nYou can think like the Sources API has been subdivided into the Payment Methods API and Setup Intents API.\nValid payment methods are attached to customers.\nYou can use a payment method to charge a customer for recurring payments.\nThe Setup Intents API allows you to set up a payment method for future payments.\nStripe Checkout creates a Checkout Session for the customer. A setup intent is issued and managed by the checkout session. It attaches a payment method to the customer once successfully finished the session.\n\n## Enable 3D Secure\n\nAs the latest Stripe API supports 3D Secure out of the box, you can enable it from *Settings -\u003E Subscriptions and emails -\u003E Manage payments that require 3D Secure*:\n\n![Settings](https:\u002F\u002Fcdn-images-1.medium.com\u002Fmax\u002F2400\u002F1*_mfaDMipb3ToCcUso4Sa7Q.png)\n\nThen, check your Radar rules from *Settings -\u003E Radar rules*:\n\n![Radar rules](https:\u002F\u002Fcdn-images-1.medium.com\u002Fmax\u002F2400\u002F1*EmZBEt7Lj8wuYvJyss4qjw.png)\nWith this configuration, 3D secure will be requested when it is required for card. I don't know which is the best practice, so I try this rule for now.\n\nNow, you are ready to integrate it!\n\n## 4 pathways users input their card information\n\nIn Stripe, each user has a [Customer](https:\u002F\u002Fstripe.com\u002Fdocs\u002Fapi\u002Fcustomers) object, and a [Subscription](https:\u002F\u002Fstripe.com\u002Fdocs\u002Fapi\u002Fsubscriptions) object is associated with each customer, which allows you to manage his\u002Fher subscription status.\nInkdrop doesn't require card information when signing up because it provides free trials. Customers have the following 3 account statuses:\n\n1. `trial` - In free-trial\n2. `active` - Has an active subscription\n3. `deactivated` - The subscription has been cancelled 15 days after a payment failure\n\nThat completely depends on your business design but I guess it'd be one of the common design patterns. Note that they are my application-specific statuses stored in my server.\nWith those statuses, the Inkdrop users may input their card information when:\n\n1. The user adds\u002Fchanges\u002Fupdates the card detail\n1. The user starts paying it before the trial expires\n1. The trial has been expired\n1. The account has been deactivated\n\nI'll explain how to deal with those cases with Stripe Checkout.\n\n## 1. User adds\u002Fchanges\u002Fupdates card detail\n\nThis is the simplest case.\nUsers can do it anytime from the website.\nHere is the billing page of Inkdrop:\n\n![Billing page](https:\u002F\u002Fcdn-images-1.medium.com\u002Fmax\u002F2600\u002F1*8lnOjUBEVGx6Vmo2Uk--mA.png)\n\nYou can update the billing details on this page. Nothing special.\nAnd when a user clicked *'Change \u002F update card'* button, it shows:\n\n![](https:\u002F\u002Fcdn-images-1.medium.com\u002Fmax\u002F2600\u002F1*QS7xgo_fPZa5xsgs94QkDw.png)\nIn this page, the website initiates a new Checkout Session by calling [`stripe.checkout.sessions.create`](https:\u002F\u002Fstripe.com\u002Fdocs\u002Fapi\u002Fcheckout\u002Fsessions\u002Fcreate) on the server-side like so:\n\n```js\nconst session = await stripe.checkout.sessions.create({\n  payment_method_types: ['card'],\n  mode: 'setup',\n  customer: customerId,\n  success_url: redirectSuccessUrl,\n  cancel_url: config.app.baseUrl + cancel_url,\n  billing_address_collection: needsBillingAddress ? 'required' : 'auto'\n})\n```\n\n* `payment_method_types` - Inkdrop only accepts credit cards, so it should be always `['card']`.\n* `mode` - It specifies `mode` as `'setup'` so that you can use the payment method for future payments.\n* `success_url` & `cancel_url` - You can specify redirection URLs where Stripe will navigate the user after the session.\n* `billing_address_collection` - If you need to collect the customer's billing address, you can do that on the Checkout page by specifying it as `'required'`\n\nOn the website, it retrieves the Session data from the server when opened the above page. When the user pressed 'Input Card' button, it redirects to the Checkout page like so:\n\n```js\nstripe.redirectToCheckout({ sessionId: session.id })\n```\n\nThen, the user should see a page something like:\n\n![Checkout page](https:\u002F\u002Fcdn-images-1.medium.com\u002Fmax\u002F1600\u002F1*EJhCDDQ-UwSeJIWLj7fn2g.png)\n\n### Test 3D Secure\n\nUse the test cards listed in [this page](https:\u002F\u002Fstripe.com\u002Fdocs\u002Ftesting#regulatory-cards) to test 3D secure.\nYou should get a popup iframe during a Checkout session as following:\n\n![3D secure](https:\u002F\u002Fcdn-images-1.medium.com\u002Fmax\u002F1600\u002F1*JzHPcrjMVeBsdHeaMiSIvg.png)\n\nPretty neat.\n\n### Process new payment method\n\nAfter the user input the card information, the Checkout redirects to `success_url`. While Stripe automatically attaches the new card to the Customer object, it doesn't anything else for you.\n\nSo, on the `success_url`, the Inkdrop server does the following processes:\n \n1. Check the card brand is supported\n2. Use the new card as the default payment method\n3. Retry payment if necessary\n\nWhile Stripe accepts JCB cards through the Checkout but Inkdrop doesn't support them, it needs to verify the card brand manually like so:\n\n```js\nexport async function checkValidPaymentMethod(\n  paymentMethod: Object\n): Promise\u003C?string\u003E {\n  const { card } = paymentMethod\n  if (card && card.brand.toLowerCase() === 'jcb') {\n    await stripe.paymentMethods.detach(paymentMethod.id)\n    return 'jcb'\n  }\n  return null\n}\n```\n\nIt's necessary to set the new card as the default payment method manually on your server since Stripe only adds it to the customer:\n\n```js\nawait stripe.customers.update(paymentMethod.customer, {\n  invoice_settings: {\n    default_payment_method: paymentMethod.id\n  }\n})\n```\n\nIt's optional if your website provides a UI to select a default card for users.\n\nIf the user has a past-due invoice, Inkdrop retries to charge it:\n\n```js\nconst customer = await stripe.customers.retrieve(customerId, {\n  expand: ['subscriptions']\n})\nconst subscription = customer.subscriptions.data[0]\nif (subscription.latest_invoice) {\n  const latestInvoice = await stripe.invoices.retrieve(\n    subscription.latest_invoice\n  )\n  if (latestInvoice && latestInvoice.status === 'open') {\n    await stripe.invoices.pay(latestInvoice.id)\n  }\n}\n```\n\n## 2. User starts paying before the trial expires\n\nSome users may want to finish their free trials and start subscribing to Inkdrop. Users under the free trial would see this:\n\n![Free trial](https:\u002F\u002Fcdn-images-1.medium.com\u002Fmax\u002F2400\u002F1*_XcLh1MtinfS4wg-QF4g8w.png)\n\nTo provide a way to manually finish their free trials, you have to **create another subscription** instead of updating the existing subscription.\nActually you can do so during the redirection hook but you shouldn't because there is a UX issue where the price won't be displayed in the Checkout session if you don't specify any `line_items` just as you saw in *pattern 1*.\nFor example, you will see it tries to charge **$0 (¥0)** for the subscription when you use Apple Pay, which is kind of weird:\n\n![Apple Pay](https:\u002F\u002Fcdn-images-1.medium.com\u002Fmax\u002F1600\u002F1*O2G55FcfxWK1kw0UNrh19A.png)\n\nI hope Stripe will support updating the existing subscriptions with Checkout, but it isn't supported at the moment.\nSo, you have to create another subscription *without a free trial* and remove the old subscription to accomplish that.\n\nIn this case, create a Checkout session like so:\n\n```js\nconst session = await stripe.checkout.sessions.create({\n  payment_method_types: ['card'],\n  mode: 'subscription',\n  customer: customerId,\n  success_url: redirectSuccessUrl,\n  cancel_url: config.app.baseUrl + cancel_url,\n  billing_address_collection: needsBillingAddress ? 'required' : 'auto',\n  line_items: [\n    {\n      price: plan,\n      quantity: 1,\n      tax_rates: [\n        customer.metadata.country === 'japan' ? taxRateJpn : taxRateZero\n      ]\n    }\n  ]\n})\n```\n\n* `mode` - It must be `subscription`\n* `line_items` - A product to newly subscribe\n\nAs Stripe doesn't support [dynamic tax rates](https:\u002F\u002Fstripe.com\u002Fdocs\u002Fpayments\u002Fcheckout\u002Ftaxes#dynamic-tax-rates) in Japan, I had to implement it myself (Please support it!). People from outside Japan are exempt from payment of a consumption tax if your business is based in Japan.\n\nBy doing so, users can see the price like this:\n\n![Stripe checkout with a subscription item](https:\u002F\u002Fcdn-images-1.medium.com\u002Fmax\u002F2400\u002F1*2jEzJAhtJIAAfUC32FhaYg.png)\nAfter a successful checkout, you can cancel the old subscription during the redirection hook:\n\n```js\nexport async function removeOldSubscriptions(\n  customerId: string,\n  newSubscription: string\n) {\n  const { data: subscriptions } = await stripe.subscriptions.list({\n    customer: customerId\n  })\n  const activeStatus = new Set(['trialing', 'active', 'past_due'])\n  for (const sub of subscriptions) {\n    if (sub.id !== newSubscription) {\n      await stripe.subscriptions.del(sub.id)\n    }\n  }\n}\n```\n\n## 3. Trial has been expired\n\nThis is similar to the pattern 2. Again, Checkout doesn't allow to update the existing subscription directly, you have to re-create a subscription for better UX. For that reason, you can't charge immediately from the trial expiration date. The subscription starts just on a day when the user input the card information.\n\n### Notify users of the trial expiration with webhook\n\nIt'd be nice to kindly notify users that their trial has been expired.\n\n**Do not send payment failure notifications** because they will be surprised and get angry! In the early days, I got some complaints, screaming like \"It's a scam! 😡\" because they haven't intended to buy or inputted card information (yet). You need to kindly notify their trial expired instead.\nI couldn't find that Stripe supports it, so I implemented it myself.\n\nTo accomplish that: When the trial expired and the user hasn't inputted a card, the first payment fails and an event [`invoice.payment_failed`](https:\u002F\u002Fstripe.com\u002Fdocs\u002Fapi\u002Fevents\u002Ftypes#event_types-invoice.payment_failed) fires.\nYou can know the event through webhook.\nIn your webhook, check if the user has any cards attached like so:\n\n```js\nexport async function checkCustomerHasPaymentMethod(\n  customerId: string\n): Promise\u003Cboolean\u003E {\n  const { data: paymentMethods } = await stripe.paymentMethods.list({\n    customer: customerId,\n    type: 'card'\n  })\n  return paymentMethods.length \u003E 0\n}\n```\n\nIf the user doesn't have a card, then check the number of charge attempts. If it was the first attempt, lock the account like so:\n\n```js\nconst { object: invoice } = event.data \u002F\u002F invoice.payment_failed\nconst customer = await stripe.customers.retrieve(invoice.customer)\n\u002F\u002F first attempt\nif (invoice.attempt_count === 1) {\n  \u002F\u002F do things you need\n  notifyTrialExpired(customer)\n}\n```\n\nI also display the notification about the expiration on the website like this:\n\n![trial expired notification](https:\u002F\u002Fcdn-images-1.medium.com\u002Fmax\u002F1600\u002F1*dPWvjDMfv8bNuOEEHUIsOQ.png)\n\n## 4. Account has been deactivated\n\nA customer's subscription is canceled when all charge retries for a payment failed as I configured Stripe like this from *Settings -\u003E Subscriptions and emails -\u003E Manage failed payments for subscriptions*:\n\n![subscription status](https:\u002F\u002Fcdn-images-1.medium.com\u002Fmax\u002F1600\u002F1*nGG4dLrd4H8A_7vqwjespQ.png)\n\nOn the website, it displays the account has been deactivated:\n\n![deactivated](https:\u002F\u002Fcdn-images-1.medium.com\u002Fmax\u002F1600\u002F1*CVwYMynuAH4YtZDziTRvUQ.png)\n\nTo reactivate the account, you can simply create a new subscription via the Checkout. Then, process the account to reactivate in your server.\n\n## Changing the plan (Monthly ⇄ Yearly)\n\nInkdrop provides monthly and annual plans.\nUsers can change it anytime.\nTo change the existing subscription:\n\n```js\nconst { subscription, customer } = await getSubscription(userId, {\n  ignoreNoSubscriptions: false\n})\nconst item = subscription.items.data[0]\nconst params: Object = {\n  cancel_at_period_end: false,\n  \u002F\u002F avoid double-charge\n  proration_behavior: 'create_prorations',\n  items: [\n    {\n      id: item.id, \u002F\u002F do not forget!\n      price: plan\n    }\n  ]\n}\n\u002F\u002F If the free trial remains, specify the same `trial_end` value\nif (subscription.trial_end \u003E +new Date() \u002F 1000) {\n  params.trial_end = subscription.trial_end\n}\nconst newSubscription = await stripe.subscriptions.update(\n  subscription.id,\n  params\n)\n```\n\n## When required 3D secure for renewing the subscription\n\nStripe supports an option \"[Send a Stripe-hosted link for cardholders to authenticate when required](https:\u002F\u002Fstripe.com\u002Fdocs\u002Finvoicing\u002Fpaying#send-3dsecure-emails)\".\nSo, Stripe will automatically send a notification email to your users when required an additional action to complete the payment.\nBut, it'd be also nice to display the notification on the website like so:\n\n![3D secure auth required](https:\u002F\u002Fcdn-images-1.medium.com\u002Fmax\u002F1600\u002F1*GwZm1eJWiEi5xUhWzs-9Ow.png)\n\nYou can determine if the payment needs 3D secure authentication like so:\n\n```js\nsubscription.status === 'past_due'\nconst { latest_invoice: latestInvoice } = subscription\nconst { payment_intent: paymentIntent } = latestInvoice\n\nif (\n  typeof paymentIntent === 'object' &&\n  (paymentIntent.status === 'requires_source_action' ||\n    paymentIntent.status === 'requires_action') &&\n  paymentIntent.next_action &&\n  paymentIntent.client_secret\n) {\n  console.log('Action required')\n}\n```\n\nThen, proceed to 3D secure authentication by calling [`confirmCardPayment`](https:\u002F\u002Fstripe.com\u002Fdocs\u002Fjs\u002Fpayment_intents\u002Fconfirm_card_payment):\n\n```js\nconst res = await stripe.confirmCardPayment(paymentIntent.client_secret)\n```\n\n## Upgrade the API version\n\nWhen everything is ready to roll out, it's time to upgrade the API version. \nIf you are using the old API version, you have to upgrade it to the latest version from *Developers -\u003E API version*. You should see the upgrade button if you are on the old one.\nBe careful to do this because it immediately affects your production environment!\n\n![API Version](https:\u002F\u002Fcdn-images-1.medium.com\u002Fmax\u002F1600\u002F1*1Jk_YvpdVXydUrq-Wde6jQ.png)\nI hope Stripe will allow testing the new API before upgrading it because I had many unexpected errors when switching it, which I left a sour taste in my mouth:\n\n![API failures](https:\u002F\u002Fcdn-images-1.medium.com\u002Fmax\u002F1600\u002F1*pWqlx1KSQIs04Safiwbuzw.png)\n\n\n## It's never been such simple without Stripe\n\nI've implemented credit card payments with PayPal in the past but it was so complicated and hard. The documentation was not clear to understand.\nStripe is so easy to integrate compared to that.\nI still have some small issues as I mentioned in the article, but I'm basically happy with Stripe.\nBesides, Stripe's website, dashboard, and mobile app are so beautiful and I've got a lot of inspiration from them.\nYou will learn their good UX practices while building your product with Stripe.\n\nThat's it! I hope it's helpful for building your SaaS business.\n\n#### Follow me online\n\n* Check out my app called [Inkdrop - A Markdown note-taking app](https:\u002F\u002Fwww.inkdrop.app\u002F)\n* Subscribe Newsletter http:\u002F\u002Feepurl.com\u002FdNgJo6\n* Twitter https:\u002F\u002Ftwitter.com\u002Finkdrop_app\n* Blog https:\u002F\u002Fblog.inkdrop.info\u002F\n* Discord community https:\u002F\u002Fdiscord.gg\u002FQfsG5Kj\n* Instagram https:\u002F\u002Finstagram.com\u002Fcraftzdog\n\n";b.user={name:"Takuya Matsuyama",username:e,twitter_username:"inkdrop_app",github_username:e,website_url:"https:\u002F\u002Fwww.craftz.dog\u002F",profile_image:"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--gOrzgmKb--\u002Fc_fill,f_auto,fl_progressive,h_640,q_auto,w_640\u002Fhttps:\u002F\u002Fdev-to-uploads.s3.amazonaws.com\u002Fuploads\u002Fuser\u002Fprofile_image\u002F51532\u002F5678e586-bad9-4271-b915-72336be509e8.jpg",profile_image_90:"https:\u002F\u002Fres.cloudinary.com\u002Fpracticaldev\u002Fimage\u002Ffetch\u002Fs--vwMSn3yO--\u002Fc_fill,f_auto,fl_progressive,h_90,q_auto,w_90\u002Fhttps:\u002F\u002Fdev-to-uploads.s3.amazonaws.com\u002Fuploads\u002Fuser\u002Fprofile_image\u002F51532\u002F5678e586-bad9-4271-b915-72336be509e8.jpg"};return {data:[{}],fetch:{"data-v-25febe66:0":{article:b}},mutations:[["SET_CURRENT_ARTICLE",b]]}}(10,{},"2021-05-31T04:00:40Z",null,"craftzdog")));